---
phase: 32-auth-security-audit
plan: 01
type: execute
---

<objective>
Review authentication flow, fix vulnerabilities, and document security posture.

Purpose: Ensure auth implementation follows security best practices before production deployment.
Output: Hardened auth endpoints, documented security posture, and auth-related tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-test-foundation/31-03-SUMMARY.md

**Key files to audit:**
@bullion-tracker/src/auth.ts
@bullion-tracker/src/lib/auth.ts
@bullion-tracker/src/app/api/auth/signup/route.ts
@bullion-tracker/src/app/api/auth/mobile/signin/route.ts
@bullion-tracker/src/lib/ratelimit.ts
@bullion-tracker/src/lib/validation.ts

**Tech stack available:** NextAuth v5, bcryptjs, jsonwebtoken, Upstash ratelimit
**Established patterns:** validatePassword in lib/validation.ts, rate limiting on auth endpoints

**Constraining decisions:**
- [31-03]: Password requirements: 8+ chars, uppercase, lowercase, number
- [31-03]: Validation functions in lib/validation.ts

**Known issues from STATE.md:**
- next-auth 5 beta may have breaking changes
- No email verification
- No password reset flow
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add email validation to signup</name>
  <files>bullion-tracker/src/lib/validation.ts, bullion-tracker/src/app/api/auth/signup/route.ts</files>
  <action>
    Add validateEmail function to lib/validation.ts:
    - Basic format validation using regex (must have @ and domain)
    - Normalize email (lowercase, trim whitespace)
    - Max length check (254 chars per RFC 5321)
    - Return { valid: boolean, normalizedEmail?: string, reason?: string }

    Update signup route to use validateEmail before checking for existing user.
    Store normalized email to prevent case-sensitivity issues.

    Do NOT implement full RFC 5322 compliance - basic validation sufficient.
  </action>
  <verify>npm test passes, signup rejects invalid emails (no @, spaces, too long)</verify>
  <done>validateEmail function exists, signup validates email format, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Reduce mobile JWT expiry and add refresh endpoint</name>
  <files>bullion-tracker/src/app/api/auth/mobile/signin/route.ts, bullion-tracker/src/app/api/auth/mobile/refresh/route.ts</files>
  <action>
    1. In mobile signin route:
       - Reduce JWT expiry from 30d to 7d
       - Add 'iat' (issued at) claim for token age tracking

    2. Create new refresh endpoint at /api/auth/mobile/refresh:
       - Accept Bearer token in Authorization header
       - Verify existing token (even if expired within grace period of 7 days)
       - If valid: issue new 7-day token
       - If expired beyond grace: return 401
       - Rate limit: same as signin (5 per 60s)

    Do NOT implement refresh tokens with DB storage - simple token renewal sufficient for this app.
  </action>
  <verify>curl tests: signin returns 7d token, refresh endpoint works, expired tokens rejected</verify>
  <done>Mobile tokens expire in 7 days, refresh endpoint works, rate limited</done>
</task>

<task type="auto">
  <name>Task 3: Add auth tests for security scenarios</name>
  <files>bullion-tracker/src/lib/__tests__/validation.test.ts</files>
  <action>
    Add tests to validation.test.ts for validateEmail:
    - Valid emails: user@example.com, user+tag@example.com
    - Invalid: no @, multiple @, no domain, spaces
    - Normalization: uppercase â†’ lowercase, whitespace trimmed
    - Length limit: >254 chars rejected

    Test coverage for security edge cases validates the auth hardening.
  </action>
  <verify>npm test shows new email validation tests passing</verify>
  <done>Email validation tests exist and pass, coverage for security edge cases</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm test passes all tests
- [ ] npm run build succeeds
- [ ] Signup rejects invalid emails
- [ ] Mobile signin returns shorter expiry
- [ ] Refresh endpoint works
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Email validation added to signup
- Mobile JWT expiry reduced to 7 days
- Token refresh endpoint created
- Auth security tests added
</success_criteria>

<output>
After completion, create `.planning/phases/32-auth-security-audit/32-01-SUMMARY.md`:

# Phase 32 Plan 01: Auth Security Hardening Summary

**[Substantive one-liner describing security improvements]**

## Accomplishments
- [Key security improvements]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key security decisions and rationale]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
- Ready for Phase 33: API Hardening

---
*Phase: 32-auth-security-audit*
*Completed: [date]*
</output>
