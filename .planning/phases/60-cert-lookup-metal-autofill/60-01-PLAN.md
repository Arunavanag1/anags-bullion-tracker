---
phase: 60-cert-lookup-metal-autofill
plan: 01
type: execute
---

<objective>
Extend PCGS cert lookup to return metal content data for automatic population during numismatic item creation.

Purpose: When users look up a coin by PCGS cert number, the response will include metalPurity, metalWeightOz, and preciousMetalOz fields calculated using the US coinage rules engine from Phase 59.

Output: Enhanced cert lookup response with metal content, enabling auto-fill of these fields in the collection form.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phases providing foundation:
@.planning/phases/58-metal-content-data-model/58-01-SUMMARY.md
@.planning/phases/59-us-historical-coinage-rules/59-01-SUMMARY.md

# Source files:
@bullion-tracker/src/app/api/coins/cert-lookup/route.ts
@bullion-tracker/src/hooks/useCertLookup.ts
@bullion-tracker/src/lib/us-coinage-rules.ts
@bullion-tracker/src/lib/metal-content.ts

**Tech stack available:** Next.js API routes, React Query, TypeScript
**Established patterns:**
- Cert lookup returns CertLookupResponse with data object
- detectUSCoinMetalContent returns MetalContent (metalPurity, metalWeightOz, preciousMetalOz)
- useCertLookup hook wraps API call with React Query mutation

**Constraining decisions:**
- Phase 58: Float type for purity (0.0-1.0 range)
- Phase 59: Check gold rules first for denominations containing $, dollar, eagle, gold
- Phase 59: US coinage rules engine returns null for unknown denominations

**Note:** PCGS API does not provide weight/fineness data directly. We use denomination and year from PCGS response with the US coinage rules engine to derive metal content.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend cert lookup API response with metal content</name>
  <files>bullion-tracker/src/app/api/coins/cert-lookup/route.ts</files>
  <action>
1. Import detectUSCoinMetalContent from @/lib/us-coinage-rules

2. Add metal content fields to CertLookupResponse.data interface:
   - metalPurity: number | null
   - metalWeightOz: number | null
   - preciousMetalOz: number | null

3. After determining metal type (line ~125), call detectUSCoinMetalContent:
   ```typescript
   // Get metal content from US coinage rules
   const metalContent = detectUSCoinMetalContent(pcgsData.Denomination, pcgsData.Year);
   ```

4. Add metal content to response data object:
   - metalPurity: metalContent?.metalPurity ?? null
   - metalWeightOz: metalContent?.metalWeightOz ?? null
   - preciousMetalOz: metalContent?.preciousMetalOz ?? null

5. Metal content will be null for:
   - Modern clad coins (post-1965 quarters, post-1970 halves)
   - Copper cents
   - Any denomination not in US coinage rules
  </action>
  <verify>npm run build --prefix bullion-tracker succeeds</verify>
  <done>Cert lookup API returns metalPurity, metalWeightOz, preciousMetalOz fields populated from US coinage rules</done>
</task>

<task type="auto">
  <name>Task 2: Update hook interface with metal content fields</name>
  <files>bullion-tracker/src/hooks/useCertLookup.ts</files>
  <action>
1. Add metal content fields to CertLookupData interface:
   ```typescript
   metalPurity: number | null;
   metalWeightOz: number | null;
   preciousMetalOz: number | null;
   ```

2. No changes needed to hook logic - fields will flow through automatically from API response

3. TypeScript types will now match the API response structure
  </action>
  <verify>npm run build --prefix bullion-tracker succeeds with no type errors</verify>
  <done>CertLookupData interface includes metal content fields matching API response</done>
</task>

<task type="auto">
  <name>Task 3: Add test for cert lookup metal content integration</name>
  <files>bullion-tracker/src/lib/__tests__/cert-lookup-metal-content.test.ts</files>
  <action>
Create a test file that validates the integration between cert lookup and metal content:

1. Test that detectUSCoinMetalContent returns correct values for common PCGS denominations:
   - "10C" (dime) + 1964 → silver content
   - "25C" (quarter) + 1932 → silver content
   - "$20" + 1928 → gold content
   - "25C" + 1965 → null (clad)

2. Test that denomination strings match PCGS format:
   - PCGS uses "10C", "25C", "50C", "$1" format
   - Verify these match the US coinage rules aliases

This validates the data flow without mocking the full API.
  </action>
  <verify>npm test --prefix bullion-tracker -- --run cert-lookup-metal passes</verify>
  <done>Test file validates PCGS denomination format compatibility with US coinage rules</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build --prefix bullion-tracker` succeeds without errors
- [ ] `npm test --prefix bullion-tracker -- --run cert-lookup-metal` passes
- [ ] No TypeScript errors in modified files
- [ ] API response includes metal content fields
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Cert lookup API returns metal content from US coinage rules
- Hook interface matches API response
- PCGS denomination format works with detectUSCoinMetalContent
</success_criteria>

<output>
After completion, create `.planning/phases/60-cert-lookup-metal-autofill/60-01-SUMMARY.md`:

# Phase 60 Plan 01: Cert Lookup Metal Autofill Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 60 complete. Ready for Phase 61 (Manual Metal Input UI).
</output>
