---
phase: 41-chart-interactions
plan: 01
type: execute
---

<objective>
Add touch interactions to mobile charts: tooltip on line chart press, and segment press feedback on pie chart.

Purpose: Enable users to explore chart data interactively on mobile devices.
Output: Interactive PortfolioLineChart with tooltip, AllocationPieChart with segment press feedback.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-portfolio-line-chart/38-01-SUMMARY.md
@.planning/phases/39-allocation-donut-chart/39-01-SUMMARY.md
@.planning/phases/40-gainloss-bar-chart/40-01-SUMMARY.md

**Relevant source files:**
@bullion-tracker-mobile/src/components/charts/PortfolioLineChart.tsx
@bullion-tracker-mobile/src/components/charts/AllocationPieChart.tsx
@bullion-tracker-mobile/src/lib/chartTheme.ts

**Victory Native interaction API (from docs):**
- `useChartPressState` hook for CartesianChart press tracking
- Returns: `{ isActive: SharedValue<boolean>, x: { value, position }, y: { [key]: { value, position } } }`
- Pass state to CartesianChart's `chartPressState` prop
- Use Reanimated `useAnimatedStyle` and `useDerivedValue` for tooltip positioning

**Established patterns:**
- ChartTheme with animation config (300ms timing)
- Colors.positive/#22A06B for gains, Colors.negative/#DE350B for losses
- ChartContainer wrapper with consistent styling

**Scope decision:**
- PortfolioLineChart: Add tooltip showing date and value on press
- AllocationPieChart: Add press handler showing segment details
- GainLossBarChart: Skip (custom rendering, already shows all data inline)
- Zoom/pan: Skip (charts are small dashboard widgets, not needed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add touch tooltip to PortfolioLineChart</name>
  <files>bullion-tracker-mobile/src/components/charts/PortfolioLineChart.tsx</files>
  <action>
Add interactive tooltip using Victory Native's useChartPressState:

1. Import useChartPressState from 'victory-native'
2. Import useAnimatedStyle, useDerivedValue from 'react-native-reanimated'
3. Import Animated from 'react-native-reanimated'

4. Create ChartPressState:
```typescript
const { state, isActive } = useChartPressState({ x: 0, y: { totalValue: 0 } });
```

5. Pass to CartesianChart:
```typescript
<CartesianChart
  data={data}
  xKey="x"
  yKeys={['totalValue']}
  chartPressState={state}
  ...
>
```

6. Create Tooltip component inside the CartesianChart children:
```typescript
function Tooltip({ state, data }: { state: ChartPressState; data: ChartDataPoint[] }) {
  const activeIndex = useDerivedValue(() => {
    return Math.round(state.x.value.value);
  });

  const activePoint = useDerivedValue(() => {
    const idx = Math.max(0, Math.min(activeIndex.value, data.length - 1));
    return data[idx] || { date: '', totalValue: 0 };
  });

  const tooltipStyle = useAnimatedStyle(() => ({
    position: 'absolute',
    left: state.x.position.value - 50,
    top: state.y.totalValue.position.value - 60,
    opacity: state.isActive.value ? 1 : 0,
  }));

  return (
    <Animated.View style={[styles.tooltip, tooltipStyle]}>
      <Animated.Text style={styles.tooltipDate}>
        {activePoint.value.date}
      </Animated.Text>
      <Animated.Text style={styles.tooltipValue}>
        ${activePoint.value.totalValue.toLocaleString()}
      </Animated.Text>
    </Animated.View>
  );
}
```

7. Add tooltip styles:
```typescript
tooltip: {
  backgroundColor: Colors.accentDark,
  borderRadius: 8,
  padding: 8,
  minWidth: 100,
  alignItems: 'center',
},
tooltipDate: {
  fontSize: 11,
  color: '#fff',
  opacity: 0.8,
},
tooltipValue: {
  fontSize: 14,
  fontWeight: '700',
  color: '#fff',
},
```

Note: The tooltip implementation may need adjustment based on how Reanimated SharedValues work with text rendering. If direct text interpolation doesn't work, use a simpler approach with useState and worklet callbacks.
  </action>
  <verify>npx tsc --noEmit passes, no TypeScript errors</verify>
  <done>PortfolioLineChart shows tooltip on touch with date and value</done>
</task>

<task type="auto">
  <name>Task 2: Add segment press feedback to AllocationPieChart</name>
  <files>bullion-tracker-mobile/src/components/charts/AllocationPieChart.tsx</files>
  <action>
Add press interaction to show selected segment details:

1. Add selectedSegment state:
```typescript
const [selectedSegment, setSelectedSegment] = useState<string | null>(null);
```

2. Victory Native PolarChart doesn't have built-in press handling like CartesianChart.
   Use TouchableOpacity wrapper around legend items instead for selection:

3. Update legend to be interactive:
```typescript
{chartData.map((item) => (
  <TouchableOpacity
    key={item.label}
    style={[
      styles.legendItem,
      selectedSegment === item.label && styles.legendItemSelected,
    ]}
    onPress={() => setSelectedSegment(
      selectedSegment === item.label ? null : item.label
    )}
  >
    <View style={[styles.legendDot, { backgroundColor: item.color }]} />
    <Text style={[
      styles.legendText,
      selectedSegment === item.label && styles.legendTextSelected,
    ]}>
      {item.label} ({item.percentage.toFixed(1)}%)
    </Text>
  </TouchableOpacity>
))}
```

4. Show detailed info when segment selected:
```typescript
{selectedSegment && (
  <View style={styles.detailCard}>
    <Text style={styles.detailLabel}>{selectedSegment}</Text>
    <Text style={styles.detailValue}>
      {formatCurrency(chartData.find(d => d.label === selectedSegment)?.value || 0)}
    </Text>
    <Text style={styles.detailPercent}>
      {chartData.find(d => d.label === selectedSegment)?.percentage.toFixed(1)}% of portfolio
    </Text>
  </View>
)}
```

5. Add styles for selection:
```typescript
legendItemSelected: {
  backgroundColor: Colors.bgCard,
  borderRadius: 8,
  paddingHorizontal: 8,
  paddingVertical: 4,
},
legendTextSelected: {
  color: Colors.textPrimary,
  fontWeight: '600',
},
detailCard: {
  backgroundColor: Colors.bgSecondary,
  borderRadius: 12,
  padding: 16,
  marginHorizontal: 16,
  marginTop: 8,
  alignItems: 'center',
},
detailLabel: {
  fontSize: 14,
  fontWeight: '600',
  color: Colors.textPrimary,
  marginBottom: 4,
},
detailValue: {
  fontSize: 24,
  fontWeight: '700',
  color: Colors.textPrimary,
},
detailPercent: {
  fontSize: 12,
  color: Colors.textSecondary,
  marginTop: 4,
},
```

This approach is simpler and more reliable than trying to add touch detection to the pie chart itself.
  </action>
  <verify>npx tsc --noEmit passes, no TypeScript errors</verify>
  <done>AllocationPieChart legend items are tappable and show detail card when selected</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Interactive charts with tooltip on line chart and segment selection on pie chart</what-built>
  <how-to-verify>
    1. Run: cd bullion-tracker-mobile && npx expo start
    2. Open app on device/simulator
    3. Test PortfolioLineChart:
       - Touch and drag on the line chart
       - Tooltip should appear showing date and value
       - Tooltip should follow finger position
       - Release finger, tooltip should fade
    4. Test AllocationPieChart:
       - Tap on a legend item (Gold, Silver, etc.)
       - Detail card should appear showing value and percentage
       - Tap same item again to deselect
       - Tap different item to change selection
    5. Check console for any errors
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npx tsc --noEmit passes
- [ ] PortfolioLineChart tooltip appears on touch
- [ ] AllocationPieChart legend is tappable with detail card
- [ ] No console errors during interaction
- [ ] Interactions feel smooth (no lag or jank)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Touch interactions work smoothly on mobile
- No regressions to existing chart functionality
</success_criteria>

<output>
After completion, create `.planning/phases/41-chart-interactions/41-01-SUMMARY.md`:

# Phase 41 Plan 01: Chart Interactions Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- Added tooltip to PortfolioLineChart using useChartPressState
- Added segment selection to AllocationPieChart via legend interaction
- Smooth touch feedback on mobile

## Files Created/Modified

- `bullion-tracker-mobile/src/components/charts/PortfolioLineChart.tsx` - Added tooltip
- `bullion-tracker-mobile/src/components/charts/AllocationPieChart.tsx` - Added legend interaction

## Decisions Made

[Document any decisions]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 42 (Dashboard Integration) - All chart components complete with interactions
</output>
