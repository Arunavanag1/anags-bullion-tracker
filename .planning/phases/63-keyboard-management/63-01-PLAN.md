---
phase: 63-keyboard-management
plan: 01
type: execute
---

<objective>
Add proper keyboard management to the mobile add/edit item forms: KeyboardAvoidingView for automatic layout adjustment, tap-to-dismiss for easy keyboard hiding, and a toolbar with Done/Next buttons above the keyboard for field navigation.

Purpose: Users currently struggle with the keyboard blocking half the screen when filling in form fields. There is no way to dismiss the keyboard without tapping another field, and no way to advance through fields sequentially.
Output: Both BullionForm and NumismaticForm have proper keyboard avoidance, tap-to-dismiss, and a Done/Next toolbar above the keyboard on iOS (with Done button fallback on Android).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

@bullion-tracker-mobile/src/screens/AddItemScreen.tsx
@bullion-tracker-mobile/src/components/addItem/BullionForm.tsx
@bullion-tracker-mobile/src/components/addItem/NumismaticForm.tsx
@bullion-tracker-mobile/src/components/ui/Input.tsx

**Constraining decisions:**
- Existing Input component wraps TextInput with label/error support
- Both forms use ScrollView with `contentContainerStyle={{ paddingBottom: 40 }}`
- No existing keyboard handling exists (no KeyboardAvoidingView, no Keyboard.dismiss)
- Expo SDK 54, React Navigation 7, standard React Native APIs available
- BullionForm has 7 TextInput fields; NumismaticForm has 10+ TextInput fields
- Input component does not currently forward refs

**Platform notes:**
- iOS: KeyboardAvoidingView needs `behavior="padding"`, InputAccessoryView is native
- Android: KeyboardAvoidingView needs `behavior="height"` or undefined, InputAccessoryView not supported natively
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add KeyboardAvoidingView and tap-to-dismiss</name>
  <files>
    bullion-tracker-mobile/src/screens/AddItemScreen.tsx,
    bullion-tracker-mobile/src/components/addItem/BullionForm.tsx,
    bullion-tracker-mobile/src/components/addItem/NumismaticForm.tsx
  </files>
  <action>
  **AddItemScreen.tsx:**
  - Import `KeyboardAvoidingView`, `Platform`, `Keyboard`, `TouchableWithoutFeedback` from react-native
  - Wrap the Card content area (the part containing forms) in a `KeyboardAvoidingView` with `behavior={Platform.OS === 'ios' ? 'padding' : 'height'}` and `style={{ flex: 1 }}`
  - Add `keyboardVerticalOffset` to account for the header height (~56px for header + step indicator). Use a reasonable value like 100 for iOS to account for header + navigation bar
  - Wrap the outer container in `TouchableWithoutFeedback onPress={Keyboard.dismiss}` so tapping outside any input dismisses the keyboard
  - Make sure the KeyboardAvoidingView wraps around the Card but inside the TouchableWithoutFeedback

  **BullionForm.tsx and NumismaticForm.tsx:**
  - Add `keyboardDismissMode="interactive"` to the ScrollView component — this allows dragging down to dismiss the keyboard naturally
  - Add `keyboardShouldPersistTaps="handled"` to the ScrollView — this ensures tapping buttons/selectors still works while keyboard is open (some sub-components like CoinSearchInput already use this on nested ScrollViews, but the parent needs it too)
  - Increase `contentContainerStyle` paddingBottom from 40 to 120 to give extra scroll room when keyboard is visible

  **Do NOT:**
  - Don't use `react-native-keyboard-aware-scroll-view` — standard RN KeyboardAvoidingView is sufficient and avoids adding a dependency
  - Don't add keyboard listeners for manual offset calculations — let the built-in behavior handle it
  </action>
  <verify>
  Run `cd bullion-tracker-mobile && npx expo start` — app should compile without errors. Navigate to Add Item > Bullion form, tap a text input:
  - Keyboard should appear and form should scroll up so the field is visible
  - Tapping empty space outside inputs should dismiss the keyboard
  - Dragging down on the scroll view should interactively dismiss the keyboard
  </verify>
  <done>
  - KeyboardAvoidingView wraps form content with platform-appropriate behavior
  - TouchableWithoutFeedback + Keyboard.dismiss enables tap-to-dismiss
  - ScrollView has keyboardDismissMode="interactive" and keyboardShouldPersistTaps="handled"
  - Both BullionForm and NumismaticForm updated
  - No new dependencies added
  </done>
</task>

<task type="auto">
  <name>Task 2: Add keyboard toolbar with Done and Next buttons</name>
  <files>
    bullion-tracker-mobile/src/components/ui/Input.tsx,
    bullion-tracker-mobile/src/components/addItem/BullionForm.tsx,
    bullion-tracker-mobile/src/components/addItem/NumismaticForm.tsx
  </files>
  <action>
  **Input.tsx — Add ref forwarding and inputAccessoryViewID support:**
  - Convert Input to use `React.forwardRef<TextInput, InputProps>` so parent forms can pass refs
  - Add optional `inputAccessoryViewID` prop (pass through to TextInput)
  - Keep all existing functionality intact, this is additive only

  **Create a new FormToolbar component** at `bullion-tracker-mobile/src/components/ui/FormToolbar.tsx`:
  - On iOS: Use React Native's `InputAccessoryView` with a unique `nativeID`
  - On Android: Since InputAccessoryView is iOS-only, render nothing (Android already has "Next" on the keyboard natively for most input types, and we'll set `returnKeyType` on inputs)
  - The toolbar should be a horizontal bar with:
    - "Previous" button (left, disabled if first field) — calls `.focus()` on previous ref
    - "Next" button (center-left, disabled if last field) — calls `.focus()` on next ref
    - "Done" button (right) — calls `Keyboard.dismiss()`
  - Style: Light gray background (#F0F0F0), border top 1px #D1D5DB, height ~44px, buttons are blue text (#3B82F6)
  - Accept props: `onPrevious`, `onNext`, `onDone`, `hasPrevious: boolean`, `hasNext: boolean`
  - The FormToolbar renders the `InputAccessoryView` component (iOS only) with the shared nativeID

  **BullionForm.tsx — Wire up field refs and toolbar:**
  - Create refs for each TextInput field using `useRef<TextInput>(null)`:
    `nameRef`, `weightRef`, `quantityRef`, `purchasePriceRef`, `premiumRef`, `purchaseDateRef`, `notesRef`
  - Track `activeFieldIndex` in state (updated via `onFocus` on each Input)
  - Define a `fieldRefs` array ordering all refs sequentially
  - Pass the shared `inputAccessoryViewID` to every Input
  - Set `returnKeyType="next"` on all inputs except the last (which gets `returnKeyType="done"`)
  - Set `onSubmitEditing` on each input to focus the next field (or dismiss keyboard on last)
  - Render `<FormToolbar>` once at the bottom of the component (outside ScrollView) with handlers that focus prev/next based on `activeFieldIndex`

  **NumismaticForm.tsx — Wire up field refs and toolbar:**
  - Same pattern as BullionForm but with more fields. Create refs for the text inputs that are standard Input components:
    - For non-RAW: `certNumberRef`, `numismaticValueRef`, `purchasePriceRef`, `purchaseDateRef`, `notesRef`
    - For RAW: `metalPurityRef`, `metalWeightOzRef`, `numismaticValueRef`, `purchasePriceRef`, `purchaseDateRef`, `notesRef`
  - Note: CoinSearchInput, GradePicker, PriceGuideDisplay are complex components — skip them in the ref chain (the toolbar Next/Previous should skip over non-standard inputs)
  - Track `activeFieldIndex` and wire up the same way as BullionForm
  - Render `<FormToolbar>` at bottom of component

  **Do NOT:**
  - Don't try to make every single form element part of the ref chain — only standard TextInput-based fields. Button groups, switches, pickers are excluded.
  - Don't use `useImperativeHandle` — simple ref forwarding is sufficient
  - Don't install any keyboard management libraries
  </action>
  <verify>
  Run the app, navigate to Add Item > Bullion:
  - Tap the "Description" field — keyboard toolbar should appear above keyboard (iOS) with "Next" and "Done"
  - Tap "Next" — focus should move to Weight field
  - Continue tapping "Next" — should progress through all fields
  - "Previous" should go back
  - "Done" should dismiss the keyboard
  - On Android: `returnKeyType` should show "Next" on keyboard, tapping it advances fields
  Repeat for Numismatic form (both RAW and graded paths).
  </verify>
  <done>
  - Input component forwards refs via React.forwardRef
  - FormToolbar component renders InputAccessoryView on iOS with Previous/Next/Done
  - BullionForm has ref chain for 7 text fields with sequential navigation
  - NumismaticForm has ref chain for relevant text fields with sequential navigation
  - returnKeyType set appropriately on all inputs
  - onSubmitEditing advances through fields
  - Android uses returnKeyType="next" for native keyboard navigation
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Keyboard management for both add item forms: KeyboardAvoidingView, tap-to-dismiss, interactive scroll dismiss, and a Done/Next toolbar above the keyboard</what-built>
  <how-to-verify>
    1. Run: `cd bullion-tracker-mobile && npx expo start`
    2. Open app on iOS simulator or device
    3. Navigate to Add Item > select Bullion
    4. Tap "Description" field:
       - Verify toolbar appears above keyboard with Previous (disabled), Next, Done buttons
       - Verify form scrolls so field is visible above keyboard
    5. Tap "Next" on toolbar:
       - Verify focus moves to "Weight" field, then "Quantity", etc.
    6. Tap "Done" on toolbar:
       - Verify keyboard dismisses
    7. Tap a field, then tap empty space outside:
       - Verify keyboard dismisses (tap-to-dismiss)
    8. Tap a field, then drag the scroll view down:
       - Verify keyboard dismisses interactively
    9. Go back, select Numismatic > RAW:
       - Verify toolbar works through numismatic fields
    10. Go back, select Numismatic > PCGS:
       - Verify toolbar works for cert number and value fields
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd bullion-tracker-mobile && npx tsc --noEmit` passes without type errors
- [ ] App compiles and runs on iOS simulator
- [ ] KeyboardAvoidingView prevents content from being hidden behind keyboard
- [ ] Tap-to-dismiss works on both forms
- [ ] Interactive scroll dismiss works on both forms
- [ ] Toolbar Next/Previous/Done buttons work on BullionForm
- [ ] Toolbar Next/Previous/Done buttons work on NumismaticForm
- [ ] Existing form submission still works correctly
- [ ] No regressions in CoinSearchInput, GradePicker, PriceGuideDisplay, CertScanner
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Keyboard management works end-to-end on both forms
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/63-keyboard-management/63-01-SUMMARY.md`
</output>
