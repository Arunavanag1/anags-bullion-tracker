---
phase: 21-bullion-premium-pricing
plan: 01
type: execute
---

<objective>
Add user-defined premium/discount percentage for bullion items that adjusts portfolio value calculation.

Purpose: Allow users to track bullion at spot price +/- a premium percentage (e.g., +5% for numismatic/collectible premiums, -3% for discount purchases), making portfolio valuations more accurate.

Output: Bullion items can store and use a premiumPercent field; portfolio value reflects spot × weight × (1 + premium%).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@bullion-tracker/prisma/schema.prisma
@bullion-tracker/src/lib/calculations.ts
@bullion-tracker/src/app/api/collection/route.ts
@bullion-tracker/src/app/api/collection/[id]/route.ts

**Mobile forms:**
@bullion-tracker-mobile/src/components/addItem/BullionForm.tsx
@bullion-tracker-mobile/src/screens/AddItemScreen.tsx

**Relevant context:**
- CollectionItem model has `bookValueType` field: 'custom' | 'spot' | 'numismatic'
- For bullion with `bookValueType = 'spot'`, value is pure melt (spot × weight)
- For bullion with `bookValueType = 'custom'`, complex logic applies (30% threshold rule)
- Phase 21 introduces `premiumPercent` for a simpler valuation: spot × weight × (1 + premium%)

**Decisions from prior phases:**
- Phase 19: Form components accept onSubmit callback with typed data interface
- Phase 19: BullionForm manages own state, calls onSubmit with BullionFormData
- Phase 4: Mobile uses expo-constants for config (app.json extra)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add premiumPercent field to database schema</name>
  <files>bullion-tracker/prisma/schema.prisma</files>
  <action>
Add `premiumPercent Float @default(0)` field to CollectionItem model, after the `customBookValue` field.

This field stores the premium/discount percentage:
- Positive values = premium over spot (e.g., 5 means 5% premium)
- Negative values = discount below spot (e.g., -3 means 3% discount)
- Default 0 = pure spot value

After adding the field, run:
1. `npx prisma migrate dev --name add-premium-percent`
2. `npx prisma generate`

DO NOT modify any existing fields or add any other changes to the schema.
  </action>
  <verify>
- `npx prisma validate` passes
- `npx prisma generate` succeeds
- Migration file created in prisma/migrations/
  </verify>
  <done>
- premiumPercent field added to CollectionItem model
- Migration applied successfully
- Prisma client regenerated
  </done>
</task>

<task type="auto">
  <name>Task 2: Update calculation functions to use premium percentage</name>
  <files>bullion-tracker/src/lib/calculations.ts</files>
  <action>
Modify `calculateCurrentBookValue` function to handle premium percentage for bullion items:

For bullion items where `bookValueType === 'spot'` OR where a new `bookValueType === 'spot_premium'` is used:
- Calculate: `meltValue * (1 + (premiumPercent || 0) / 100)`

Update the existing spot calculation block (around line 34):
```typescript
// If using spot value (with optional premium)
if (item.bookValueType === 'spot') {
  const meltValue = totalWeight * currentSpotPrice;
  const premiumMultiplier = 1 + ((item.premiumPercent || 0) / 100);
  return meltValue * premiumMultiplier;
}
```

Also update the `CollectionItem` type in `@/types/index.ts` to include `premiumPercent?: number`.

DO NOT change the logic for numismatic items or the 30% threshold custom value logic - those remain unchanged.
  </action>
  <verify>
- TypeScript compiles without errors: `cd bullion-tracker && npx tsc --noEmit`
- Calculation logic: spot item with premiumPercent=5, weight=10oz, spot=$30 should return $315 (not $300)
  </verify>
  <done>
- calculateCurrentBookValue handles premiumPercent for bullion
- CollectionItem type updated with premiumPercent field
- Existing numismatic and custom value logic unchanged
  </done>
</task>

<task type="auto">
  <name>Task 3: Update API routes and forms to accept premium percentage</name>
  <files>
bullion-tracker/src/app/api/collection/route.ts,
bullion-tracker/src/app/api/collection/[id]/route.ts,
bullion-tracker/src/components/collection/AddItemModal.tsx,
bullion-tracker/src/components/collection/EditItemModal.tsx,
bullion-tracker-mobile/src/components/addItem/BullionForm.tsx,
bullion-tracker-mobile/src/screens/AddItemScreen.tsx
  </files>
  <action>
**API Routes:**

1. In `route.ts` POST handler, add `premiumPercent` to bullion createData:
```typescript
if (body.premiumPercent !== undefined) createData.premiumPercent = body.premiumPercent;
```

2. In `[id]/route.ts` PATCH handler, allow updating premiumPercent:
```typescript
if (body.premiumPercent !== undefined) updateData.premiumPercent = body.premiumPercent;
```

**Web Forms (AddItemModal.tsx, EditItemModal.tsx):**

Add a "Premium/Discount %" input field for bullion items:
- Label: "Premium/Discount %"
- Placeholder: "0"
- Helper text: "Enter positive for premium, negative for discount"
- Input type: number, step: 0.1
- Only show for BULLION category

**Mobile Form (BullionForm.tsx):**

1. Add `premiumPercent: string` to BullionFormData interface
2. Add state: `const [premiumPercent, setPremiumPercent] = useState(initialData?.premiumPercent || '0')`
3. Add Input component after purchasePrice:
```tsx
<Input
  label="Premium/Discount %"
  value={premiumPercent}
  onChangeText={setPremiumPercent}
  keyboardType="decimal-pad"
  placeholder="0 (e.g., 5 for 5% premium, -3 for 3% discount)"
/>
```
4. Include in handleSubmit: `premiumPercent` in the returned data object

**Mobile AddItemScreen.tsx:**

In handleBullionSubmit, add premiumPercent to itemData and updateData:
```typescript
premiumPercent: data.premiumPercent ? Number(data.premiumPercent) : 0,
```

DO NOT change any numismatic form logic.
  </action>
  <verify>
- Web app builds: `cd bullion-tracker && npm run build`
- Mobile app type-checks: `cd bullion-tracker-mobile && npx tsc --noEmit`
- Can add bullion item with premium % via mobile form
- Can edit existing bullion item to add/change premium %
  </verify>
  <done>
- API accepts premiumPercent on create and update
- Web forms show premium input for bullion
- Mobile BullionForm includes premium input
- Premium value persists through create/edit cycle
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd bullion-tracker && npm run build` succeeds
- [ ] `cd bullion-tracker-mobile && npx tsc --noEmit` passes
- [ ] Database has premiumPercent column (check via psql or Prisma Studio)
- [ ] Create bullion item with 5% premium via mobile → verify saved to DB
- [ ] Edit bullion item to change premium to -3% → verify updated
- [ ] Portfolio summary reflects premium in total book value
</verification>

<success_criteria>
- premiumPercent field exists in CollectionItem model
- Bullion book value calculation: spot × weight × quantity × (1 + premium%)
- Web and mobile forms allow entering premium/discount percentage
- API create and update routes accept premiumPercent
- Existing items (premiumPercent = null/0) work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/21-bullion-premium-pricing/21-01-SUMMARY.md` with:

# Phase 21 Plan 01: Bullion Premium Pricing Summary

**[One-liner: what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `path/to/file` - Description

## Decisions Made
- [Any decisions, or "None"]

## Issues Encountered
- [Problems and resolutions, or "None"]

## Next Phase Readiness
- Ready for Phase 22: Valuation Type System
</output>
