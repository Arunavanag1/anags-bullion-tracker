---
phase: 22-valuation-type-system
plan: 01
type: execute
---

<objective>
Implement a unified valuation type system that consolidates bullion (spot+premium) and numismatic (guide price) valuation methods with explicit type selection.

Purpose: Replace the fragmented bookValueType logic with a clear three-option system: spot_premium (bullion), guide_price (numismatic), and custom (fixed value).

Output: Updated type system, calculation functions, and form UI that presents clear valuation choices.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase summary:**
@.planning/phases/21-bullion-premium-pricing/21-01-SUMMARY.md

**Key files:**
@bullion-tracker/src/types/index.ts
@bullion-tracker/src/lib/calculations.ts
@bullion-tracker/prisma/schema.prisma
@bullion-tracker/src/app/api/collection/route.ts
@bullion-tracker/src/app/api/collection/[id]/route.ts

**Mobile forms:**
@bullion-tracker-mobile/src/components/addItem/BullionForm.tsx
@bullion-tracker-mobile/src/components/addItem/NumismaticForm.tsx
@bullion-tracker-mobile/src/screens/AddItemScreen.tsx

**Relevant context:**
- Current `BookValueType = 'custom' | 'spot'` (line 4 in types/index.ts)
- Calculations already check for `'numismatic'` bookValueType (line 18 in calculations.ts)
- Phase 21 added premiumPercent for spot-valued bullion
- Bullion items now default to `bookValueType: 'spot'` with premiumPercent

**Decisions from Phase 21:**
- Phase 21: New bullion items use bookValueType: 'spot' to leverage premium pricing
- Phase 21: Premium percentage stored as float (e.g., 5 for 5%, -3 for -3% discount)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand BookValueType and update schema</name>
  <files>
bullion-tracker/src/types/index.ts,
bullion-tracker/prisma/schema.prisma
  </files>
  <action>
1. Update BookValueType in types/index.ts to:
```typescript
export type BookValueType = 'spot_premium' | 'guide_price' | 'custom';
```

2. Update the schema.prisma comment for bookValueType to reflect new values:
```prisma
bookValueType       String   // 'spot_premium' | 'guide_price' | 'custom'
```

3. Add IMPORTANT comment in types file documenting the valuation system:
```typescript
/**
 * Valuation Type System:
 * - 'spot_premium': Value = spot × weight × (1 + premiumPercent%). For bullion.
 * - 'guide_price': Value = numismaticValue from price guide. For numismatics.
 * - 'custom': Value = customBookValue. Fixed, doesn't change with market.
 */
export type BookValueType = 'spot_premium' | 'guide_price' | 'custom';
```

DO NOT run prisma db push yet - this is a string field change that doesn't affect schema structure.
  </action>
  <verify>
- `cd bullion-tracker && npx tsc --noEmit` shows errors (expected - calculations.ts uses old values)
- BookValueType type updated with documentation
  </verify>
  <done>
- BookValueType expanded to three options with documentation
- Schema comment updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Update calculation functions for new valuation types</name>
  <files>bullion-tracker/src/lib/calculations.ts</files>
  <action>
Refactor `calculateCurrentBookValue` to handle the new valuation type system:

```typescript
export function calculateCurrentBookValue(
  item: CollectionItem,
  currentSpotPrice: number
): number {
  // Handle by valuation type
  switch (item.bookValueType) {
    case 'spot_premium': {
      // Bullion: spot × weight × quantity × (1 + premium%)
      const quantity = 'quantity' in item ? item.quantity : 1;
      const totalWeight = (item.weightOz || 0) * quantity;
      const meltValue = totalWeight * currentSpotPrice;
      const premiumMultiplier = 1 + ((item.premiumPercent || 0) / 100);
      return meltValue * premiumMultiplier;
    }

    case 'guide_price': {
      // Numismatic: use numismaticValue (guide price)
      return item.numismaticValue ?? 0;
    }

    case 'custom': {
      // Fixed value: customBookValue doesn't change
      return item.customBookValue ?? 0;
    }

    // BACKWARD COMPATIBILITY: Handle legacy 'spot' and 'numismatic' values
    case 'spot': {
      // Treat as spot_premium with 0% premium
      const quantity = 'quantity' in item ? item.quantity : 1;
      const totalWeight = (item.weightOz || 0) * quantity;
      const meltValue = totalWeight * currentSpotPrice;
      const premiumMultiplier = 1 + ((item.premiumPercent || 0) / 100);
      return meltValue * premiumMultiplier;
    }

    default: {
      // Legacy numismatic or unknown - try numismaticValue, then customBookValue, then 0
      if (item.numismaticValue !== undefined) return item.numismaticValue;
      if (item.customBookValue !== undefined) return item.customBookValue;
      return 0;
    }
  }
}
```

Also update `getCalculatedValues` to determine `isTracking` based on new types:
- `spot_premium`: isTracking = true (tracks spot)
- `guide_price`: isTracking = false (tracks guide, not spot)
- `custom`: isTracking = false (fixed value)

Remove the legacy 30% threshold logic and 1% annual growth - these are replaced by explicit valuation type selection.
  </action>
  <verify>
- `cd bullion-tracker && npx tsc --noEmit` passes
- No more implicit 30% threshold logic
  </verify>
  <done>
- calculateCurrentBookValue uses switch on bookValueType
- Backward compatibility for legacy 'spot' values
- isTracking correctly reflects valuation type
  </done>
</task>

<task type="auto">
  <name>Task 3: Update API routes and mobile forms</name>
  <files>
bullion-tracker/src/app/api/collection/route.ts,
bullion-tracker-mobile/src/screens/AddItemScreen.tsx,
bullion-tracker-mobile/src/components/addItem/BullionForm.tsx,
bullion-tracker-mobile/src/components/addItem/NumismaticForm.tsx,
bullion-tracker-mobile/src/lib/api.ts
  </files>
  <action>
**API Routes (route.ts):**
- Change bullion default from `bookValueType: 'spot'` to `bookValueType: 'spot_premium'`
- Change numismatic default from `bookValueType: 'numismatic'` to `bookValueType: 'guide_price'`

**Mobile AddItemScreen.tsx:**
- Update bullion itemData to use `bookValueType: 'spot_premium'`
- Numismatic already sets bookValueType correctly in the create path

**Mobile BullionForm.tsx:**
- Add valuation type selector with two options:
  - "Track Spot Price" (spot_premium) - default
  - "Fixed Value" (custom)
- When "Fixed Value" selected, show customBookValue input instead of premiumPercent
- Add state: `const [valuationType, setValuationType] = useState<'spot_premium' | 'custom'>('spot_premium')`
- Include in BullionFormData interface and handleSubmit

**Mobile NumismaticForm.tsx:**
- Add valuation type selector with two options:
  - "Guide Price" (guide_price) - default
  - "Fixed Value" (custom)
- When "Fixed Value" selected, label the value input as "Custom Value"
- Add state for valuationType

**Mobile api.ts:**
- Update BookValueType in types to match new values

DO NOT change existing items - this is for new item creation only.
  </action>
  <verify>
- `cd bullion-tracker && npm run build` succeeds
- `cd bullion-tracker-mobile && npx tsc --noEmit` passes
- Mobile forms show valuation type selector
  </verify>
  <done>
- API uses new bookValueType values
- Mobile forms have valuation type selector
- Bullion can choose spot_premium or custom
- Numismatic can choose guide_price or custom
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd bullion-tracker && npm run build` succeeds
- [ ] `cd bullion-tracker-mobile && npx tsc --noEmit` passes
- [ ] calculateCurrentBookValue handles all three types correctly
- [ ] Backward compatibility: existing items with 'spot' bookValueType still work
- [ ] New bullion items default to spot_premium
- [ ] New numismatic items default to guide_price
</verification>

<success_criteria>
- BookValueType = 'spot_premium' | 'guide_price' | 'custom'
- Calculations handle all three types plus legacy 'spot'
- Mobile forms show valuation type selector
- Bullion defaults to spot_premium, numismatic to guide_price
- Custom valuation option available for both categories
</success_criteria>

<output>
After completion, create `.planning/phases/22-valuation-type-system/22-01-SUMMARY.md` with:

# Phase 22 Plan 01: Valuation Type System Summary

**[One-liner: what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `path/to/file` - Description

## Decisions Made
- [Any decisions, or "None"]

## Issues Encountered
- [Problems and resolutions, or "None"]

## Next Phase Readiness
- Ready for Phase 23: Dynamic Guide Price Integration
</output>
