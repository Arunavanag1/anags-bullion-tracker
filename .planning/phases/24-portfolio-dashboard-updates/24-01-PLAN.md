---
phase: 24-portfolio-dashboard-updates
plan: 01
type: execute
---

<objective>
Update dashboard and reports to reflect the new valuation model from Phases 21-23.

Purpose: Users can now see clear valuation type breakdowns (spot+premium, guide price, custom), premium/discount totals, and melt vs guide comparisons, helping them understand their portfolio value composition.

Output: Updated web CollectionSummary and mobile DashboardScreen with valuation breakdown sections.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase summaries:**
@.planning/phases/21-bullion-premium-pricing/21-01-SUMMARY.md
@.planning/phases/22-valuation-type-system/22-01-SUMMARY.md
@.planning/phases/23-dynamic-guide-price/23-01-SUMMARY.md

**Key files:**
@bullion-tracker/src/components/collection/CollectionSummary.tsx
@bullion-tracker-mobile/src/screens/DashboardScreen.tsx
@bullion-tracker/src/lib/calculations.ts
@bullion-tracker-mobile/src/lib/calculations.ts
@bullion-tracker/src/types/index.ts

**Relevant context:**
- BookValueType: 'spot_premium' | 'guide_price' | 'custom'
- premiumPercent field stores premium/discount % for bullion
- numismaticValue stores guide price for numismatics
- ItemValueHistory tracks value changes over time
- calculateCurrentBookValue in calculations.ts handles valuation logic

**Decisions from prior phases:**
- Phase 21: premiumPercent stored as float (5 for 5%, -3 for -3% discount)
- Phase 22: spot_premium items track spot, guide_price items use numismaticValue
- Phase 23: greysheet price preferred over pcgs when available
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API endpoint for valuation breakdown</name>
  <files>
bullion-tracker/src/app/api/portfolio/valuation-breakdown/route.ts,
bullion-tracker/src/types/index.ts
  </files>
  <action>
1. Add ValuationBreakdown type to types/index.ts:
```typescript
export interface ValuationBreakdown {
  spotPremium: {
    count: number;
    totalValue: number;
    totalPremium: number;  // Total $ from premiums
    avgPremiumPercent: number;
  };
  guidePrice: {
    count: number;
    totalValue: number;
    totalMeltValue: number;  // For comparison
    premiumOverMelt: number;  // guide - melt as %
  };
  custom: {
    count: number;
    totalValue: number;
  };
  lastSyncDate: string | null;  // From most recent ItemValueHistory
}
```

2. Create GET /api/portfolio/valuation-breakdown endpoint:
   - Fetch all user's collection items
   - Group by bookValueType (handling legacy 'spot' as 'spot_premium')
   - For spot_premium: sum values, calculate total premium $ and avg premium %
   - For guide_price: sum guide values and melt values for comparison
   - For custom: just sum values
   - Find most recent ItemValueHistory priceDate for lastSyncDate
   - Return ValuationBreakdown

Use existing patterns from /api/portfolio/summary route.
  </action>
  <verify>
- `cd bullion-tracker && npx tsc --noEmit` passes
- `curl localhost:3001/api/portfolio/valuation-breakdown` returns ValuationBreakdown JSON
  </verify>
  <done>
- ValuationBreakdown type exported
- API endpoint returns breakdown by valuation type
- lastSyncDate reflects most recent value history entry
  </done>
</task>

<task type="auto">
  <name>Task 2: Update web CollectionSummary with valuation breakdown</name>
  <files>
bullion-tracker/src/hooks/useValuationBreakdown.ts,
bullion-tracker/src/components/collection/CollectionSummary.tsx
  </files>
  <action>
1. Create useValuationBreakdown hook in hooks/useValuationBreakdown.ts:
   - Fetch from /api/portfolio/valuation-breakdown
   - Return { data, isLoading, error }

2. Update CollectionSummary.tsx:
   - Add a new "Valuation Breakdown" section below existing grid
   - Show three columns for spot_premium, guide_price, custom
   - For spot_premium: show count, total value, avg premium %
   - For guide_price: show count, total value, "X% over melt"
   - For custom: show count, total value
   - If lastSyncDate exists, show "Prices updated: [date]" footer
   - Only render section if items > 0

Keep existing layout intact - ADD a new section below the current 3-column grid.
  </action>
  <verify>
- `cd bullion-tracker && npm run build` succeeds
- CollectionSummary displays valuation breakdown when items exist
  </verify>
  <done>
- useValuationBreakdown hook fetches breakdown data
- CollectionSummary shows spot_premium/guide_price/custom breakdown
- Last sync date displays for guide_price items
  </done>
</task>

<task type="auto">
  <name>Task 3: Update mobile DashboardScreen with valuation breakdown</name>
  <files>
bullion-tracker-mobile/src/lib/api.ts,
bullion-tracker-mobile/src/types/index.ts,
bullion-tracker-mobile/src/screens/DashboardScreen.tsx
  </files>
  <action>
1. Add ValuationBreakdown type to mobile types/index.ts (same as web)

2. Add to api.ts:
```typescript
async getValuationBreakdown(): Promise<ValuationBreakdown> {
  const response = await makeRequest('/api/portfolio/valuation-breakdown');
  if (!response.ok) throw new Error('Failed to fetch valuation breakdown');
  const data = await response.json();
  return data.data;
}
```

3. Update DashboardScreen.tsx:
   - Add state for valuationBreakdown
   - Fetch in loadData alongside other calls
   - Add "VALUATION BREAKDOWN" card below categoryCard
   - Show three columns: Spot+Premium, Guide Price, Custom
   - For each: show count, value, and relevant metric (avg premium %, % over melt)
   - Show "Last synced: [date]" if lastSyncDate exists
   - Match existing card styling (bgCard, borderRadius: 24, padding: 24)

Keep styling consistent with existing allocationCard and categoryCard patterns.
  </action>
  <verify>
- `cd bullion-tracker-mobile && npx tsc --noEmit` passes (ignoring CollageScreen errors)
- DashboardScreen shows valuation breakdown card
  </verify>
  <done>
- ValuationBreakdown type added to mobile
- getValuationBreakdown API method works
- DashboardScreen displays valuation breakdown with consistent styling
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd bullion-tracker && npm run build` succeeds
- [ ] `cd bullion-tracker-mobile && npx tsc --noEmit` passes (minus CollageScreen errors)
- [ ] Valuation breakdown API returns data for items with mixed valuations
- [ ] Web CollectionSummary shows breakdown section
- [ ] Mobile DashboardScreen shows breakdown card
- [ ] Last sync date displays when ItemValueHistory entries exist
</verification>

<success_criteria>
- API endpoint returns accurate valuation breakdown by type
- Web and mobile dashboards display valuation type breakdown
- Premium/discount totals visible for bullion items
- Guide vs melt comparison visible for numismatic items
- "Last updated" indicator shows for dynamic values
- v1.6 Portfolio Valuation Model milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/24-portfolio-dashboard-updates/24-01-SUMMARY.md` with:

# Phase 24 Plan 01: Portfolio Value Dashboard Updates Summary

**[One-liner: what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `path/to/file` - Description

## Decisions Made
- [Any decisions, or "None"]

## Issues Encountered
- [Problems and resolutions, or "None"]

## Milestone Complete
- v1.6 Portfolio Valuation Model milestone complete
- All 4 phases (21-24) shipped
</output>
