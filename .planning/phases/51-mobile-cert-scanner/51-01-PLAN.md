---
phase: 51-mobile-cert-scanner
plan: 01
type: execute
---

<objective>
Add camera-based barcode scanning to mobile app for automatic cert number extraction from PCGS slabs and NGC QR codes.

Purpose: Enable quick coin entry by scanning certification holder barcodes instead of manual number entry.
Output: CertScanner component integrated into NumismaticForm with auto-detection of PCGS/NGC.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-mobile-cert-scanner/DISCOVERY.md
@.planning/phases/49-cert-lookup-api/49-01-SUMMARY.md
@.planning/phases/50-autofill-form-component/50-01-SUMMARY.md

**Key files:**
@bullion-tracker-mobile/src/components/addItem/NumismaticForm.tsx
@bullion-tracker-mobile/src/lib/api.ts
@bullion-tracker-mobile/package.json

**Prior work:**
- Phase 49: Created `/api/coins/cert-lookup` endpoint with PCGS API integration
- Phase 50: Added cert autofill to web AddItemModal and mobile NumismaticForm
- Mobile NumismaticForm already has cert lookup with debounced API calls

**PCGS Barcode Format (22-digit ITF):**
- Digits 1-2: `01` prefix
- Digits 3-8: PCGS coin number (6 digits)
- Digits 9-12: Grade (4 digits)
- Digits 13-22: Cert number (8 digits)

**NGC Format:**
- QR code containing URL: `https://www.ngccoin.com/certlookup/{cert-number}/`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install expo-camera and create CertScanner component</name>
  <files>
    bullion-tracker-mobile/package.json,
    bullion-tracker-mobile/src/components/addItem/CertScanner.tsx
  </files>
  <action>
1. Install expo-camera: `npx expo install expo-camera`
2. Create CertScanner.tsx component with:
   - Full-screen modal with CameraView
   - barcodeScannerSettings for `['itf14', 'qr']` types
   - onBarcodeScanned callback that:
     - Parses PCGS ITF barcode (22 digits) to extract cert number from positions 14-22
     - Parses NGC QR code URL to extract cert number
     - Auto-detects service based on barcode type
   - Viewfinder overlay with targeting rectangle
   - Close button and permission handling
   - Props: `visible`, `onClose`, `onScan: (certNumber: string, service: 'pcgs' | 'ngc') => void`

AVOID: Using deprecated expo-barcode-scanner (use expo-camera CameraView instead).
AVOID: Complex OCR - barcodes contain all needed data.
  </action>
  <verify>
    cd bullion-tracker-mobile && npx tsc --noEmit
  </verify>
  <done>
    - expo-camera installed in package.json
    - CertScanner component created with barcode parsing logic
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate CertScanner into NumismaticForm</name>
  <files>
    bullion-tracker-mobile/src/components/addItem/NumismaticForm.tsx
  </files>
  <action>
1. Import CertScanner component
2. Add state: `scannerVisible: boolean`
3. Add "Scan Cert" button next to cert number input (camera icon)
   - Only show for graded coins (PCGS/NGC, not RAW)
   - Button opens scanner modal
4. Handle onScan callback:
   - Set certNumber from scanned data
   - Set currentGradingService based on detected service
   - Close scanner
   - Existing debounced lookup will trigger automatically
5. Style the scan button to match existing UI (blue camera icon button)

AVOID: Duplicating cert lookup logic - use existing lookupCert flow.
  </action>
  <verify>
    cd bullion-tracker-mobile && npx tsc --noEmit
  </verify>
  <done>
    - "Scan Cert" button visible next to cert number input for graded coins
    - Scanner modal opens/closes correctly
    - Scanned cert number populates input and triggers lookup
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>CertScanner component with barcode/QR scanning integrated into NumismaticForm</what-built>
  <how-to-verify>
    1. Run: `cd bullion-tracker-mobile && npx expo start`
    2. Open app on device (physical device required for camera)
    3. Navigate to Add Item > Numismatic > select PCGS or NGC
    4. Look for camera/scan icon button next to cert number input
    5. Tap scan button - camera should open with viewfinder
    6. If you have a PCGS slab: scan the barcode on the label
    7. If you have an NGC holder: scan the QR code on the back
    8. Verify: cert number populates, service auto-selects, lookup triggers
    9. Close scanner without scanning - verify it closes cleanly
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd bullion-tracker-mobile && npx tsc --noEmit` passes
- [ ] expo-camera is in package.json dependencies
- [ ] CertScanner component renders camera with barcode scanning
- [ ] Scan button appears for PCGS/NGC (not RAW) coins
- [ ] PCGS barcode scanning extracts cert number correctly
- [ ] NGC QR code scanning extracts cert number correctly
- [ ] Scanner modal opens/closes without errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Mobile cert scanner works end-to-end on physical device
- Phase 51 complete, v2.2 milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/51-mobile-cert-scanner/51-01-SUMMARY.md`
</output>
