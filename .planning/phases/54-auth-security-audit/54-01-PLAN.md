# Phase 54-01: Auth Security Audit

## Objective
Comprehensive security audit of JWT implementation, token storage, password hashing, and session management to identify and remediate vulnerabilities.

## Prerequisites
- Access to all auth-related source files
- Understanding of current auth architecture (NextAuth + mobile JWT)

## Current Architecture Summary

### Authentication Flows
1. **Web App**: NextAuth with JWT strategy, Google OAuth + Credentials providers
2. **Mobile App**: Custom JWT via `/api/auth/mobile/signin` + token refresh
3. **OAuth Server**: Full authorization code flow with PKCE for third-party integrations

### Key Files
- `bullion-tracker/src/auth.ts` - NextAuth configuration
- `bullion-tracker/src/lib/auth.ts` - Auth utilities (getUserId, requireAuth)
- `bullion-tracker/src/app/api/auth/mobile/signin/route.ts` - Mobile login
- `bullion-tracker/src/app/api/auth/mobile/refresh/route.ts` - Token refresh
- `bullion-tracker/src/lib/plaid/oauth-tokens.ts` - OAuth token generation
- `bullion-tracker-mobile/src/contexts/AuthContext.tsx` - Mobile auth state

---

## Tasks

### Task 1: JWT Secret Configuration Audit
**Files**: `src/lib/auth.ts`, `src/auth.ts`, `src/app/api/auth/mobile/*`

**Audit Points**:
- [ ] Verify JWT_SECRET is required in production (fail-hard pattern exists at `src/lib/auth.ts:5-13`)
- [ ] Check NEXTAUTH_SECRET configuration requirements
- [ ] Ensure secrets are not logged or exposed in error messages
- [ ] Verify minimum secret length/entropy requirements

**Current Status**: JWT_SECRET has fail-hard pattern. NEXTAUTH_SECRET handling needs verification.

---

### Task 2: Token Expiration & Refresh Audit
**Files**: `src/app/api/auth/mobile/signin/route.ts`, `src/app/api/auth/mobile/refresh/route.ts`

**Audit Points**:
- [ ] Review 7-day JWT expiry window (line 68-75 in signin)
- [ ] **CRITICAL**: Review 7-day grace period for expired tokens in refresh endpoint (line 16)
- [ ] Verify token rotation on refresh (new token issued, old invalidated)
- [ ] Check for token replay attack prevention

**Current Status**: 7-day grace period is generous - may want to reduce. Token rotation exists but no server-side invalidation of old tokens.

---

### Task 3: Password Hashing Audit
**Files**: `src/app/api/auth/signup/route.ts`, `src/auth.ts`, `src/app/api/auth/delete-account/route.ts`

**Audit Points**:
- [ ] Verify bcrypt salt rounds (currently 10 at `signup/route.ts:67`)
- [ ] Check password validation rules (8+ chars, upper, lower, number at `signup/route.ts:46-52`)
- [ ] Ensure timing-safe comparison for password verification
- [ ] Verify no password logging

**Current Status**: bcrypt with 10 rounds is adequate. Password validation is strong.

---

### Task 4: Rate Limiting Audit
**Files**: `src/lib/ratelimit.ts`, all auth API routes

**Audit Points**:
- [ ] Verify auth rate limiting (5 requests/60s per IP - `ratelimit.ts:14-21`)
- [ ] Check all auth endpoints have rate limiting applied
- [ ] Review IP extraction from x-forwarded-for (spoofing risk)
- [ ] Verify rate limit applies before expensive operations (password hash)

**Current Status**: Rate limiting exists. Need to verify all endpoints protected.

**Endpoints to check**:
- `/api/auth/mobile/signin` - Has rate limiting ✓
- `/api/auth/mobile/refresh` - Has rate limiting ✓
- `/api/auth/signup` - Need to verify
- `/api/auth/delete-account` - Has rate limiting ✓

---

### Task 5: OAuth Implementation Audit
**Files**: `src/app/api/oauth/authorize/route.ts`, `src/app/api/oauth/token/route.ts`, `src/lib/plaid/oauth-tokens.ts`

**Audit Points**:
- [ ] Verify authorization code is single-use (line 86-90 in token route)
- [ ] Check 10-minute auth code expiry (line 59 in authorize)
- [ ] Verify PKCE implementation (SHA256 code challenge)
- [ ] Review refresh token 13-month expiry (long, but acceptable for OAuth)
- [ ] Check redirect_uri validation against registered URIs
- [ ] Verify state parameter handling for CSRF protection

**Current Status**: OAuth implementation follows RFC 6749 patterns. PKCE implemented.

---

### Task 6: Session Management Audit
**Files**: `src/auth.ts`, `prisma/schema.prisma`

**Audit Points**:
- [ ] Verify session cookie security flags (httpOnly, secure, sameSite)
- [ ] Check session invalidation on password change
- [ ] Verify cascade deletes for sessions on user deletion
- [ ] Review NextAuth callback security

**Current Status**: NextAuth manages cookies. Cascade deletes configured in schema.

---

### Task 7: Mobile Token Storage Audit
**Files**: `bullion-tracker-mobile/src/contexts/AuthContext.tsx`, `bullion-tracker-mobile/src/lib/api.ts`

**Audit Points**:
- [ ] Verify expo-secure-store usage (line 2 in AuthContext)
- [ ] Check token keys aren't predictable
- [ ] Verify tokens cleared on sign-out (lines 120-121)
- [ ] Review 3-second timeout on SecureStore operations
- [ ] Check no token logging in debug mode

**Current Status**: Using expo-secure-store which is appropriate for mobile.

---

### Task 8: Security Headers Audit
**Files**: `src/middleware.ts`

**Audit Points**:
- [ ] Review CSP directives (lines 14-23) - has unsafe-inline/unsafe-eval
- [ ] Verify X-Frame-Options: DENY (line 27)
- [ ] Check X-Content-Type-Options: nosniff (line 30)
- [ ] Review missing HSTS header (intentionally omitted)
- [ ] Verify Permissions-Policy restrictions

**Current Status**: Good headers but CSP could be stricter in production.

---

### Task 9: Development Fallback Audit
**Files**: `src/lib/plaid/jwks.ts`, `src/lib/ratelimit.ts`

**Audit Points**:
- [ ] **CRITICAL**: Review RSA key fallback in development (lines 67-76 in jwks.ts)
- [ ] Verify fallbacks don't leak into production
- [ ] Check environment detection is reliable

**Current Status**: Development fallbacks exist. Need to ensure production hardening.

---

## Remediation Priority

### Critical (Fix Immediately)
1. Reduce 7-day grace period for expired token refresh to 1 day max
2. Ensure RSA key fallback cannot be used in production

### High (Fix Soon)
3. Add rate limiting to signup endpoint if missing
4. Implement token blacklist for immediate revocation capability
5. Tighten CSP headers for production

### Medium (Address in Phase)
6. Consider reducing JWT expiry from 7 days to 24 hours + rely on refresh
7. Add session invalidation on password change
8. Implement HSTS after HTTPS verification

### Low (Future Enhancement)
9. Consider JWT jti (unique identifier) for replay prevention
10. Add audit logging for auth events

---

## Verification

After remediation:
1. Run existing auth tests: `npm run test -- --grep auth`
2. Manual testing of all auth flows
3. Verify rate limiting with repeated requests
4. Check production environment variables are set
5. Confirm no development fallbacks in deployed code

---

## Estimated Scope

- **Files to modify**: 4-6
- **New files**: 0-1 (token blacklist if implemented)
- **Tests to add**: 3-5 security-focused tests
