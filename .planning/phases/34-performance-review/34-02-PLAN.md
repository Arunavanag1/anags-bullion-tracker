---
phase: 34-performance-review
plan: 02
type: execute
---

<objective>
Add pagination to collection API and configure basic bundle optimization.

Purpose: Support large collections without performance degradation, reduce client bundle size.
Output: Paginated collection endpoint, optimized Next.js configuration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./34-02-SUMMARY.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-performance-review/34-01-SUMMARY.md

@bullion-tracker/src/app/api/collection/route.ts
@bullion-tracker/next.config.ts

**Tech stack available:** Prisma 7.2, Next.js 16.1, React 19
**Established patterns:** Use handleApiError() for catch blocks, validation utilities

**Issues being addressed:**
- Large mobile sync (no pagination) - Known issue from STATE.md
- Empty next.config.ts - No bundle optimization
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pagination to GET /api/collection</name>
  <files>bullion-tracker/src/app/api/collection/route.ts</files>
  <action>
Add cursor-based pagination to the collection GET endpoint:

1. Accept optional query params: `cursor` (last item ID), `limit` (default 50, max 100)
2. Validate limit with validatePositiveNumber, cap at 100
3. Use Prisma cursor pagination:
   ```typescript
   const items = await prisma.collectionItem.findMany({
     where: { userId },
     take: limit + 1, // Fetch one extra to detect hasMore
     cursor: cursor ? { id: cursor } : undefined,
     skip: cursor ? 1 : 0, // Skip cursor item
     include: { images: { orderBy: { order: 'asc' } } },
     orderBy: { createdAt: 'desc' },
   });
   ```
4. Detect hasMore by checking if we got limit+1 items
5. Return response with pagination metadata:
   ```typescript
   {
     success: true,
     data: items.slice(0, limit),
     pagination: {
       hasMore: items.length > limit,
       nextCursor: hasMore ? items[limit - 1].id : null,
       limit,
     }
   }
   ```

Keep backwards compatibility: if no params provided, return all items (limit=Infinity equivalent with reasonable cap like 1000).
  </action>
  <verify>npm run build succeeds, GET /api/collection?limit=10 returns 10 items with pagination metadata</verify>
  <done>Collection GET supports cursor pagination with limit and cursor params</done>
</task>

<task type="auto">
  <name>Task 2: Configure Next.js bundle optimization</name>
  <files>bullion-tracker/next.config.ts</files>
  <action>
Add basic bundle optimization to next.config.ts:

1. Enable standalone output for production:
   ```typescript
   output: 'standalone',
   ```

2. Configure image optimization (Cloudinary already handles images, but set remote patterns):
   ```typescript
   images: {
     remotePatterns: [
       { hostname: 'res.cloudinary.com' },
     ],
   },
   ```

3. Add experimental optimizations if beneficial (check Next.js 16 docs):
   - Consider optimizing imports for large libraries (recharts, gsap)

Keep configuration minimal - only add proven optimizations.
  </action>
  <verify>npm run build succeeds, bundle output shows standalone folder created</verify>
  <done>next.config.ts has production-ready configuration</done>
</task>

<task type="auto">
  <name>Task 3: Add pagination metadata type</name>
  <files>bullion-tracker/src/types/index.ts</files>
  <action>
Add TypeScript types for pagination to ensure type safety:

```typescript
export interface PaginationMeta {
  hasMore: boolean;
  nextCursor: string | null;
  limit: number;
}

export interface PaginatedResponse<T> {
  success: true;
  data: T[];
  pagination: PaginationMeta;
}
```

This enables type-safe pagination across the codebase.
  </action>
  <verify>npm run build succeeds, types are exported</verify>
  <done>Pagination types available for use across API routes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests
- [ ] GET /api/collection supports pagination params
- [ ] Standalone output folder created during build
</verification>

<success_criteria>

- Collection API paginated with cursor support
- Next.js configured for production
- Pagination types exported
- All tests pass
- Phase 34 complete
</success_criteria>

<output>
After completion, create `.planning/phases/34-performance-review/34-02-SUMMARY.md`
</output>
