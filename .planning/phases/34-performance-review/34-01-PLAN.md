---
phase: 34-performance-review
plan: 01
type: execute
---

<objective>
Fix N+1 query patterns in coins/performance and sync-prices API routes.

Purpose: Eliminate database query multiplication that degrades performance as collections grow.
Output: Optimized API routes using batch queries instead of per-item loops.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./34-01-SUMMARY.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-api-hardening/33-02-SUMMARY.md

@bullion-tracker/src/app/api/coins/performance/route.ts
@bullion-tracker/src/app/api/collection/sync-prices/route.ts

**Tech stack available:** Prisma 7.2, Next.js 16.1
**Established patterns:** Use handleApiError() for catch blocks

**Issues being addressed:**
- N+1 queries in coins/performance (3 queries per item)
- N+1 queries in sync-prices (3 queries per item)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix N+1 in coins/performance route</name>
  <files>bullion-tracker/src/app/api/coins/performance/route.ts</files>
  <action>
Refactor the coins/performance route to eliminate N+1 queries:

1. Get all numismatic items in one query (already done)
2. Extract unique coinReferenceIds from items
3. Batch fetch ALL current prices with `findMany` using `where: { coinReferenceId: { in: [...] } }` grouped by coinReferenceId+gradeCode
4. Batch fetch ALL historical prices the same way with date filter
5. Batch fetch ALL coin references using `findMany` with `where: { id: { in: [...] } }`
6. Build lookup Maps for O(1) access in the processing loop
7. Process items using lookups instead of per-item queries

Replace the 3-query-per-item loop with:
- 1 query for all current prices
- 1 query for all historical prices
- 1 query for all coin references (only if needed)

Use Prisma's `groupBy` or just `findMany` with filtering and build Maps.
  </action>
  <verify>npm run build succeeds, manual test: GET /api/coins/performance returns same data structure</verify>
  <done>coins/performance uses batch queries, no per-item database calls</done>
</task>

<task type="auto">
  <name>Task 2: Fix N+1 in sync-prices route</name>
  <files>bullion-tracker/src/app/api/collection/sync-prices/route.ts</files>
  <action>
Refactor the sync-prices route to eliminate N+1 queries:

1. Get all items to sync in one query (already done)
2. Extract unique (coinReferenceId, grade) pairs
3. Batch fetch ALL price guides with `findMany` using compound filter
4. Build a Map keyed by `${coinReferenceId}-${grade}` for O(1) lookup
5. Batch the updates using `prisma.$transaction` with multiple operations

The current loop does 3 operations per item:
- findFirst for priceGuide
- update for numismaticValue
- upsert for history

Replace with:
- 1 findMany for all price guides
- 1 $transaction containing all updates and upserts

Use Prisma's `$transaction([...])` to batch all writes atomically.
  </action>
  <verify>npm run build succeeds, npm test passes</verify>
  <done>sync-prices uses batch queries and transactional writes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all 76 tests
- [ ] No new TypeScript errors
- [ ] Both routes return same response structure as before
</verification>

<success_criteria>

- N+1 queries eliminated from coins/performance
- N+1 queries eliminated from sync-prices
- All tests pass
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/34-performance-review/34-01-SUMMARY.md`
</output>
