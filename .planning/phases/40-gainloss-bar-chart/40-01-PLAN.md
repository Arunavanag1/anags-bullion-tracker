---
phase: 40-gainloss-bar-chart
plan: 01
type: execute
---

<objective>
Create a horizontal bar chart showing gain/loss by metal with color-coded positive/negative values.

Purpose: Show users their profit/loss per metal type with visual distinction between gains (green) and losses (red).
Output: Working GainLossBarChart component with horizontal bars and summary stats.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-portfolio-line-chart/38-01-SUMMARY.md
@.planning/phases/39-allocation-donut-chart/39-01-SUMMARY.md

**Relevant source files:**
@bullion-tracker-mobile/src/components/charts/PortfolioLineChart.tsx
@bullion-tracker-mobile/src/components/charts/AllocationPieChart.tsx
@bullion-tracker-mobile/src/lib/chartTheme.ts
@bullion-tracker/src/components/charts/GainLossBarChart.tsx

**From Phase 37-39:**
- Victory Native with CartesianChart for line/bar, PolarChart for pie
- ChartTheme with Colors.positive (#22A06B) and Colors.negative (#DE350B)
- Data types need `[key: string]: unknown` index signature

**Victory Native Bar API (from docs):**
```typescript
<CartesianChart data={DATA} xKey="x" yKeys={["y"]}>
  {({ points, chartBounds }) => (
    <Bar points={points.y} chartBounds={chartBounds} />
  )}
</CartesianChart>
```

**Web GainLossBarChart features:**
- Horizontal bars (layout="vertical" in Recharts)
- Per-metal gain/loss: current value - cost basis
- Colors: green (#22C55E) for gain, red (#EF4444) for loss, gray for zero
- Reference line at x=0
- Summary: total portfolio value, overall gain/loss amount and percent
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GainLossBarChart component with Victory Native</name>
  <files>bullion-tracker-mobile/src/components/charts/GainLossBarChart.tsx</files>
  <action>
Create a horizontal bar chart showing gain/loss by metal using Victory Native.

Note: Victory Native's Bar component works with CartesianChart. For horizontal bars, we'll use the standard approach and rotate the data presentation.

Features to implement:
1. Accept collection items and spot prices as props
2. Calculate gain/loss per metal (current value - cost basis)
3. Horizontal bars color-coded: green for gain, red for loss
4. Summary section showing total portfolio value and overall gain/loss

Component structure:
```typescript
import React, { useMemo } from 'react';
import { View, Text, StyleSheet } from 'react-native';
import { ChartContainer } from './ChartContainer';
import { Colors } from '../../lib/colors';
import type { CollectionItem } from '../../lib/api';

interface GainLossBarChartProps {
  collection: CollectionItem[];
  spotPrices: {
    gold: number;
    silver: number;
    platinum: number;
  };
}

interface MetalGainLoss {
  name: string;
  gainLoss: number;
  percentChange: number;
  currentValue: number;
  costBasis: number;
  color: string;
}

const POSITIVE_COLOR = Colors.positive;
const NEGATIVE_COLOR = Colors.negative;

export function GainLossBarChart({ collection, spotPrices }: GainLossBarChartProps) {
  const { chartData, totals } = useMemo(() => {
    if (!collection || collection.length === 0) {
      return {
        chartData: [],
        totals: { gainLoss: 0, percentChange: 0, currentValue: 0, costBasis: 0 },
      };
    }

    const metalTotals: Record<string, { currentValue: number; costBasis: number }> = {
      gold: { currentValue: 0, costBasis: 0 },
      silver: { currentValue: 0, costBasis: 0 },
      platinum: { currentValue: 0, costBasis: 0 },
    };

    collection.forEach((item) => {
      const metal = item.metal as 'gold' | 'silver' | 'platinum';
      if (!metal || !spotPrices[metal]) return;

      const spotPrice = spotPrices[metal];
      const weightOz = item.weightOz || 0;
      const currentValue = weightOz * spotPrice;
      const costBasis = item.purchasePrice || 0;

      metalTotals[metal].currentValue += currentValue;
      metalTotals[metal].costBasis += costBasis;
    });

    const data: MetalGainLoss[] = Object.entries(metalTotals)
      .filter(([, values]) => values.currentValue > 0 || values.costBasis > 0)
      .map(([metal, values]) => {
        const gainLoss = values.currentValue - values.costBasis;
        const percentChange = values.costBasis > 0
          ? ((values.currentValue - values.costBasis) / values.costBasis) * 100
          : 0;

        return {
          name: metal.charAt(0).toUpperCase() + metal.slice(1),
          gainLoss,
          percentChange,
          currentValue: values.currentValue,
          costBasis: values.costBasis,
          color: gainLoss >= 0 ? POSITIVE_COLOR : NEGATIVE_COLOR,
        };
      })
      .sort((a, b) => b.gainLoss - a.gainLoss);

    const totalCurrentValue = data.reduce((sum, d) => sum + d.currentValue, 0);
    const totalCostBasis = data.reduce((sum, d) => sum + d.costBasis, 0);
    const totalGainLoss = totalCurrentValue - totalCostBasis;
    const totalPercentChange = totalCostBasis > 0
      ? ((totalCurrentValue - totalCostBasis) / totalCostBasis) * 100
      : 0;

    return {
      chartData: data,
      totals: {
        gainLoss: totalGainLoss,
        percentChange: totalPercentChange,
        currentValue: totalCurrentValue,
        costBasis: totalCostBasis,
      },
    };
  }, [collection, spotPrices]);

  const formatCurrency = (value: number) => {
    const absValue = Math.abs(value);
    if (absValue >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
    if (absValue >= 1000) return `$${(value / 1000).toFixed(1)}K`;
    return `$${value.toFixed(0)}`;
  };

  const formatPercent = (value: number) => {
    const sign = value >= 0 ? '+' : '';
    return `${sign}${value.toFixed(1)}%`;
  };

  if (!collection || collection.length === 0) {
    return (
      <ChartContainer title="Gain / Loss by Metal" height={150}>
        <View style={styles.emptyContainer}>
          <Text style={styles.emptyText}>Add items to see gain/loss</Text>
        </View>
      </ChartContainer>
    );
  }

  // Calculate max for scaling bars
  const maxAbsValue = Math.max(...chartData.map(d => Math.abs(d.gainLoss)), 1);

  const isOverallPositive = totals.gainLoss >= 0;

  return (
    <View>
      <ChartContainer title="Gain / Loss by Metal" height={chartData.length * 50 + 20}>
        <View style={styles.barsContainer}>
          {chartData.map((item) => {
            const barWidth = Math.max((Math.abs(item.gainLoss) / maxAbsValue) * 100, 5);
            const isPositive = item.gainLoss >= 0;

            return (
              <View key={item.name} style={styles.barRow}>
                <Text style={styles.metalLabel}>{item.name}</Text>
                <View style={styles.barTrack}>
                  <View
                    style={[
                      styles.bar,
                      {
                        width: `${barWidth}%`,
                        backgroundColor: item.color,
                        alignSelf: isPositive ? 'flex-start' : 'flex-end',
                      },
                    ]}
                  />
                </View>
                <Text style={[styles.valueLabel, { color: item.color }]}>
                  {isPositive ? '+' : ''}{formatCurrency(item.gainLoss)}
                </Text>
              </View>
            );
          })}
        </View>
      </ChartContainer>

      {/* Summary */}
      <View style={styles.summaryContainer}>
        <View style={styles.summaryLeft}>
          <Text style={styles.summaryLabel}>Total Portfolio</Text>
          <Text style={styles.summaryValue}>{formatCurrency(totals.currentValue)}</Text>
        </View>
        <View style={styles.summaryRight}>
          <Text style={styles.summaryLabel}>Overall {isOverallPositive ? 'Gain' : 'Loss'}</Text>
          <Text style={[styles.summaryGainLoss, { color: isOverallPositive ? POSITIVE_COLOR : NEGATIVE_COLOR }]}>
            {isOverallPositive ? '+' : ''}{formatCurrency(totals.gainLoss)}
          </Text>
          <Text style={[styles.summaryPercent, { color: isOverallPositive ? POSITIVE_COLOR : NEGATIVE_COLOR }]}>
            {formatPercent(totals.percentChange)}
          </Text>
        </View>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  barsContainer: {
    flex: 1,
    justifyContent: 'center',
    gap: 12,
  },
  barRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  metalLabel: {
    width: 70,
    fontSize: 13,
    fontWeight: '600',
    color: Colors.textPrimary,
  },
  barTrack: {
    flex: 1,
    height: 24,
    backgroundColor: Colors.bgSecondary,
    borderRadius: 4,
    overflow: 'hidden',
  },
  bar: {
    height: '100%',
    borderRadius: 4,
    minWidth: 4,
  },
  valueLabel: {
    width: 70,
    fontSize: 12,
    fontWeight: '600',
    textAlign: 'right',
  },
  summaryContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginHorizontal: 16,
    marginTop: 12,
    paddingTop: 12,
    borderTopWidth: 1,
    borderTopColor: Colors.border,
  },
  summaryLeft: {},
  summaryRight: {
    alignItems: 'flex-end',
  },
  summaryLabel: {
    fontSize: 11,
    color: Colors.textSecondary,
    textTransform: 'uppercase',
    marginBottom: 4,
  },
  summaryValue: {
    fontSize: 18,
    fontWeight: '700',
    color: Colors.textPrimary,
  },
  summaryGainLoss: {
    fontSize: 18,
    fontWeight: '700',
  },
  summaryPercent: {
    fontSize: 13,
    fontWeight: '600',
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  emptyText: {
    color: Colors.textSecondary,
    fontSize: 14,
  },
});
```

Note: Using custom bar rendering instead of Victory Native Bar since horizontal bar charts with negative values require more control. This approach gives us exact visual control over bar direction and sizing.
  </action>
  <verify>File exists and exports GainLossBarChart component</verify>
  <done>GainLossBarChart.tsx created with horizontal bars, color-coding, and summary stats</done>
</task>

<task type="auto">
  <name>Task 2: Export GainLossBarChart and verify TypeScript</name>
  <files>bullion-tracker-mobile/src/components/charts/index.ts</files>
  <action>
Update the barrel export to include GainLossBarChart:

```typescript
export { ChartContainer } from './ChartContainer';
export { TestChart } from './TestChart';
export { PortfolioLineChart } from './PortfolioLineChart';
export { AllocationPieChart } from './AllocationPieChart';
export { GainLossBarChart } from './GainLossBarChart';
```

Then run TypeScript check:
```bash
cd bullion-tracker-mobile && npx tsc --noEmit
```
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>GainLossBarChart exported and TypeScript compiles successfully</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>GainLossBarChart component with horizontal bars showing gain/loss per metal and summary stats</what-built>
  <how-to-verify>
    1. Run: cd bullion-tracker-mobile && npx expo start
    2. Open app on device/simulator
    3. Add GainLossBarChart to DashboardScreen:
       - Import: import { GainLossBarChart } from '../components/charts';
       - Pass collection and spotPrices props
       - Add below AllocationPieChart
    4. Verify:
       - Horizontal bars render for each metal with holdings
       - Green bars for gains, red bars for losses
       - Summary shows total value and overall gain/loss
       - Percentages display correctly
    5. Check console for any errors
  </how-to-verify>
  <resume-signal>Type "approved" or "skip" to continue</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] GainLossBarChart.tsx exists with horizontal bar rendering
- [ ] Bars are color-coded (green for gain, red for loss)
- [ ] Summary shows total portfolio and overall gain/loss
- [ ] npx tsc --noEmit passes
- [ ] Manual verification: chart renders in app
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Horizontal bars render correctly
- Color-coding works for positive/negative values
- Summary stats accurate
</success_criteria>

<output>
After completion, create `.planning/phases/40-gainloss-bar-chart/40-01-SUMMARY.md`:

# Phase 40 Plan 01: Gain/Loss Bar Chart Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- Created GainLossBarChart with horizontal bars
- Implemented color-coding (green=gain, red=loss)
- Added summary with total portfolio and overall gain/loss

## Files Created/Modified

- `bullion-tracker-mobile/src/components/charts/GainLossBarChart.tsx` - New component
- `bullion-tracker-mobile/src/components/charts/index.ts` - Updated exports

## Decisions Made

[Document any decisions]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 41 (Chart Interactions) - All chart components complete
</output>
