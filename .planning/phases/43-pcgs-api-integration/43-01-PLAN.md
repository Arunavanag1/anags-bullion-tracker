---
phase: 43-pcgs-api-integration
plan: 01
type: execute
---

<objective>
Implement PCGS Public API client with OAuth2 authentication, rate limiting, and daily quota tracking.

Purpose: Enable legal, reliable access to PCGS coin data at 1,000 queries/day without web scraping fragility.
Output: Python API client module with authentication, rate limiting, and quota persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

**Existing scraper infrastructure:**
@bullion-tracker/coin_scraper/config.py
@bullion-tracker/coin_scraper/scrapers/pcgs_scraper.py

**PCGS API Research (from milestone creation):**
- Base URL: https://api.pcgs.com/publicapi/
- Auth: OAuth2 password grant with PCGS credentials
- Rate limit: 1,000 queries/day (free tier)
- Endpoints: GetCoinFactsByCertNo, GetCoinFactsByGrade, GetAuctionPrices
- Swagger docs: https://api.pcgs.com/publicapi/swagger/ui/index
- Auth header: "Authorization: bearer <access_token>"

**v2.1 Milestone Context:**
- Goal: Expand from ~100 to ~8,000 coins
- Approach: Hybrid API (primary) + scraping (fallback)
- This phase establishes the API client infrastructure
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PCGS API client with OAuth2 authentication</name>
  <files>bullion-tracker/coin_scraper/api/pcgs_api.py, bullion-tracker/coin_scraper/api/__init__.py</files>
  <action>
Create a new `api/` directory in coin_scraper with a PCGSApiClient class:

1. Create `api/__init__.py` with exports
2. Create `api/pcgs_api.py` with:
   - PCGSApiClient class using httpx for async HTTP
   - `authenticate()` method: POST to /publicapi/Authentication/GetToken with username/password, store bearer token
   - `get_coin_by_cert(cert_no: str)` method: GET /publicapi/coindetail/GetCoinFactsByCertNo/{cert_no}
   - `get_coin_by_pcgs_and_grade(pcgs_number: int, grade: str)` method: GET /publicapi/coindetail/GetCoinFactsByGrade
   - Token refresh logic (check if token expired before requests)
   - Proper error handling for 401 (re-auth), 429 (rate limit), 5xx (retry with backoff)

Environment variables needed:
- PCGS_USERNAME: PCGS account email
- PCGS_PASSWORD: PCGS account password

Use httpx (already in requirements.txt) for async HTTP.
Base URL: https://api.pcgs.com/publicapi/

DO NOT hardcode credentials - use environment variables only.
  </action>
  <verify>python -c "from api.pcgs_api import PCGSApiClient; print('Import successful')" in coin_scraper dir</verify>
  <done>PCGSApiClient class importable with authenticate(), get_coin_by_cert(), get_coin_by_pcgs_and_grade() methods</done>
</task>

<task type="auto">
  <name>Task 2: Add daily quota tracking with JSON persistence</name>
  <files>bullion-tracker/coin_scraper/api/quota_tracker.py</files>
  <action>
Create quota tracking to enforce 1,000 daily API calls:

1. Create `api/quota_tracker.py` with QuotaTracker class:
   - Store quota data in JSON file: `coin_scraper/data/api_quota.json`
   - Track: date, calls_made, calls_remaining
   - `check_quota()` → bool: Return True if calls remaining > 0
   - `record_call()` → int: Increment calls_made, return remaining
   - `reset_if_new_day()`: Auto-reset if date changed
   - `get_status()` → dict: Return current quota info

2. Integrate with PCGSApiClient:
   - Check quota before each API call
   - Raise QuotaExceededError if no calls remaining
   - Log quota status after each call

JSON structure:
```json
{
  "date": "2026-01-17",
  "calls_made": 0,
  "daily_limit": 1000,
  "last_call_at": null
}
```

Create data/ directory if needed: `mkdir -p coin_scraper/data`
  </action>
  <verify>python -c "from api.quota_tracker import QuotaTracker; qt = QuotaTracker(); print(qt.get_status())"</verify>
  <done>QuotaTracker class works, persists to JSON, resets daily, integrates with PCGSApiClient</done>
</task>

<task type="auto">
  <name>Task 3: Create CLI command to test API and fetch coin</name>
  <files>bullion-tracker/coin_scraper/scripts/test_pcgs_api.py</files>
  <action>
Create a CLI script to test the PCGS API client:

1. Create `scripts/test_pcgs_api.py`:
   - Parse command line args: --cert-no, --pcgs-number, --grade, --status
   - `--status`: Show quota status only (no API call)
   - `--cert-no XXXXXXXX`: Fetch coin by cert number
   - `--pcgs-number XXXXX --grade MS65`: Fetch coin by PCGS number and grade
   - Pretty-print JSON response
   - Show quota remaining after each call

2. Add usage instructions in docstring

Example usage:
```bash
# Check quota status
python scripts/test_pcgs_api.py --status

# Fetch by cert number
python scripts/test_pcgs_api.py --cert-no 12345678

# Fetch by PCGS number and grade
python scripts/test_pcgs_api.py --pcgs-number 9801 --grade MS65
```

Handle errors gracefully:
- Missing credentials: Prompt to set PCGS_USERNAME and PCGS_PASSWORD
- Auth failure: Clear error message
- Quota exceeded: Show when quota resets
- API errors: Show status code and message
  </action>
  <verify>python scripts/test_pcgs_api.py --status (should show quota status without requiring credentials if no API call made)</verify>
  <done>CLI works for --status, --cert-no, and --pcgs-number+--grade options with clear error handling</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "from api.pcgs_api import PCGSApiClient"` succeeds in coin_scraper/
- [ ] `python -c "from api.quota_tracker import QuotaTracker"` succeeds
- [ ] `python scripts/test_pcgs_api.py --status` shows quota info
- [ ] Quota JSON file created in coin_scraper/data/
- [ ] If PCGS credentials available: test actual API call with `--cert-no`
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No hardcoded credentials
- Quota tracking persists across script runs
- CLI provides clear feedback for all scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/43-pcgs-api-integration/43-01-SUMMARY.md`:

# Phase 43 Plan 01: PCGS API Integration Summary

**[Substantive one-liner about what shipped]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.py` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
Ready for Phase 44: Series Priority Mapping
</output>
