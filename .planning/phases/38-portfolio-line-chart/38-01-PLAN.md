---
phase: 38-portfolio-line-chart
plan: 01
type: execute
---

<objective>
Create an interactive Victory Native line chart showing portfolio value over time with time range selector.

Purpose: Replace the text-only PortfolioChart with a real interactive line chart matching the website's visualization.
Output: Working PortfolioLineChart component with time range controls (1W, 1M, 1Y, 5Y) and smooth animations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-victory-native-setup/37-01-SUMMARY.md

**Relevant source files:**
@bullion-tracker-mobile/src/lib/api.ts
@bullion-tracker-mobile/src/components/PortfolioChart.tsx
@bullion-tracker-mobile/src/components/charts/ChartContainer.tsx
@bullion-tracker-mobile/src/components/charts/TestChart.tsx
@bullion-tracker-mobile/src/lib/chartTheme.ts
@bullion-tracker/src/app/api/portfolio/history/route.ts

**From Phase 37:**
- Victory Native v41.20.2 with @shopify/react-native-skia v2.2.12
- ChartContainer wrapper component
- ChartTheme with colors, axis, animation settings
- Victory Native API: `<CartesianChart data={DATA} xKey="x" yKeys={["y"]}>{({ points }) => <Line points={points.y} />}</CartesianChart>`

**Key patterns from web PortfolioChart:**
- Time ranges: 1W (7 days), 1M (30 days), 1Y (365 days), 5Y (1825 days)
- API endpoint: `/api/portfolio/history?days=N` or `?startDate=X&endDate=Y`
- Response: `{ date, meltValue, bookValue, bullionValue, numismaticValue, totalValue, timestamp }`
- Y-axis formatting: $1.2K, $1.2M based on magnitude
- X-axis formatting: varies by time range (Jan 5, Jan, Jan '22)

**Mobile app existing pattern:**
- PortfolioChart.tsx has time range selector UI, data loading logic, summary stats
- Uses `generateDailyPrices()` locally instead of API - should use API instead
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add portfolio history API function</name>
  <files>bullion-tracker-mobile/src/lib/api.ts</files>
  <action>
Add a `getPortfolioHistory` function to fetch portfolio history data from the API.

Add this function to the `api` object:

```typescript
/**
 * Get portfolio value history for charts
 * @param days - Number of days to look back (7, 30, 365, 1825)
 */
async getPortfolioHistory(days: number = 30): Promise<HistoricalPoint[]> {
  const response = await makeRequest(`/api/portfolio/history?days=${days}`);

  if (!response.ok) {
    throw new Error('Failed to fetch portfolio history');
  }

  const data = await response.json();
  return data.data || [];
}
```

Also add the HistoricalPoint type to the types import at the top if not already present.

The API returns an array of:
```typescript
interface HistoricalPoint {
  date: string;
  meltValue: number;
  bookValue: number;
  bullionValue: number;
  numismaticValue: number;
  totalValue: number;
  timestamp: number;
}
```

Make sure HistoricalPoint is exported from src/types/index.ts if not already.
  </action>
  <verify>grep "getPortfolioHistory" bullion-tracker-mobile/src/lib/api.ts shows the function exists</verify>
  <done>getPortfolioHistory function added to api object</done>
</task>

<task type="auto">
  <name>Task 2: Create PortfolioLineChart component with Victory Native</name>
  <files>bullion-tracker-mobile/src/components/charts/PortfolioLineChart.tsx</files>
  <action>
Create a new PortfolioLineChart component using Victory Native's CartesianChart and Line.

Features to implement:
1. Time range selector buttons (1W, 1M, 1Y, 5Y) - styled like existing PortfolioChart
2. Fetch data from API using api.getPortfolioHistory(days)
3. Line chart showing totalValue over time using Victory Native
4. Loading state using ChartContainer's loading prop
5. Summary stats showing start value, current value, change amount and percent
6. Gold-colored line (#C9A227 / ChartTheme.colors.gold)

Component structure:
```typescript
import React, { useEffect, useState } from 'react';
import { View, Text, StyleSheet, TouchableOpacity } from 'react-native';
import { CartesianChart, Line, useChartPressState } from 'victory-native';
import { Circle } from '@shopify/react-native-skia';
import { ChartContainer } from './ChartContainer';
import { ChartTheme } from '../../lib/chartTheme';
import { Colors } from '../../lib/colors';
import { api } from '../../lib/api';

type TimeRange = '1W' | '1M' | '1Y' | '5Y';

const TIME_RANGES: { value: TimeRange; label: string; days: number }[] = [
  { value: '1W', label: '1W', days: 7 },
  { value: '1M', label: '1M', days: 30 },
  { value: '1Y', label: '1Y', days: 365 },
  { value: '5Y', label: '5Y', days: 1825 },
];

interface HistoricalPoint {
  date: string;
  totalValue: number;
  timestamp: number;
}

export function PortfolioLineChart() {
  const [timeRange, setTimeRange] = useState<TimeRange>('1M');
  const [data, setData] = useState<HistoricalPoint[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    loadData();
  }, [timeRange]);

  const loadData = async () => {
    setLoading(true);
    setError(null);
    try {
      const range = TIME_RANGES.find(r => r.value === timeRange);
      const history = await api.getPortfolioHistory(range?.days || 30);
      // Transform to chart format
      setData(history.map((p, i) => ({
        date: p.date,
        totalValue: p.totalValue,
        timestamp: p.timestamp,
        x: i, // Use index for x-axis
      })));
    } catch (err) {
      setError('Failed to load chart data');
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // Calculate change stats
  const firstPoint = data[0];
  const lastPoint = data[data.length - 1];
  const change = lastPoint && firstPoint ? lastPoint.totalValue - firstPoint.totalValue : 0;
  const changePercent = firstPoint?.totalValue > 0
    ? ((change / firstPoint.totalValue) * 100).toFixed(2)
    : '0.00';
  const isPositive = change >= 0;

  return (
    <View>
      {/* Time Range Selector */}
      <View style={styles.rangeContainer}>
        {TIME_RANGES.map((range) => (
          <TouchableOpacity
            key={range.value}
            style={[
              styles.rangeButton,
              timeRange === range.value && styles.rangeButtonActive,
            ]}
            onPress={() => setTimeRange(range.value)}
          >
            <Text style={[
              styles.rangeText,
              timeRange === range.value && styles.rangeTextActive,
            ]}>
              {range.label}
            </Text>
          </TouchableOpacity>
        ))}
      </View>

      {/* Chart */}
      <ChartContainer title="Portfolio Value" height={200} loading={loading}>
        {data.length > 0 && !error ? (
          <CartesianChart
            data={data}
            xKey="x"
            yKeys={['totalValue']}
            domainPadding={{ top: 20, bottom: 20 }}
          >
            {({ points }) => (
              <Line
                points={points.totalValue}
                color={ChartTheme.colors.gold}
                strokeWidth={2.5}
                animate={ChartTheme.animation}
                curveType="natural"
              />
            )}
          </CartesianChart>
        ) : error ? (
          <View style={styles.errorContainer}>
            <Text style={styles.errorText}>{error}</Text>
          </View>
        ) : null}
      </ChartContainer>

      {/* Summary Stats */}
      {data.length > 0 && !loading && (
        <View style={styles.statsContainer}>
          <View style={styles.statRow}>
            <View style={styles.stat}>
              <Text style={styles.statLabel}>Start</Text>
              <Text style={styles.statValue}>
                ${firstPoint?.totalValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
              </Text>
            </View>
            <View style={[styles.stat, styles.statRight]}>
              <Text style={styles.statLabel}>Current</Text>
              <Text style={[styles.statValue, { color: Colors.accentTeal }]}>
                ${lastPoint?.totalValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
              </Text>
            </View>
          </View>
          <View style={styles.changeRow}>
            <Text style={styles.changeLabel}>Change ({timeRange})</Text>
            <Text style={[styles.changeValue, { color: isPositive ? Colors.positive : Colors.negative }]}>
              {isPositive ? '+' : ''}${change.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} ({isPositive ? '+' : ''}{changePercent}%)
            </Text>
          </View>
        </View>
      )}
    </View>
  );
}

const styles = StyleSheet.create({
  rangeContainer: {
    flexDirection: 'row',
    backgroundColor: Colors.bgSecondary,
    borderRadius: 8,
    padding: 4,
    marginHorizontal: 16,
    marginBottom: 8,
  },
  rangeButton: {
    flex: 1,
    paddingVertical: 8,
    alignItems: 'center',
    borderRadius: 6,
  },
  rangeButtonActive: {
    backgroundColor: Colors.bgCard,
  },
  rangeText: {
    fontSize: 13,
    fontWeight: '600',
    color: Colors.textSecondary,
  },
  rangeTextActive: {
    color: Colors.textPrimary,
  },
  statsContainer: {
    marginHorizontal: 16,
    marginTop: 8,
    backgroundColor: Colors.bgSecondary,
    borderRadius: 12,
    padding: 16,
  },
  statRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 12,
  },
  stat: {
    flex: 1,
  },
  statRight: {
    alignItems: 'flex-end',
  },
  statLabel: {
    fontSize: 12,
    color: Colors.textSecondary,
    marginBottom: 4,
  },
  statValue: {
    fontSize: 16,
    fontWeight: '600',
    color: Colors.textPrimary,
  },
  changeRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    borderTopWidth: 1,
    borderTopColor: Colors.border,
    paddingTop: 12,
  },
  changeLabel: {
    fontSize: 12,
    color: Colors.textSecondary,
  },
  changeValue: {
    fontSize: 14,
    fontWeight: '600',
  },
  errorContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  errorText: {
    color: Colors.textSecondary,
    fontSize: 14,
  },
});
```

Do NOT include useChartPressState or tooltip functionality yet - that's for Phase 41 (Chart Interactions).
  </action>
  <verify>File exists and exports PortfolioLineChart component</verify>
  <done>PortfolioLineChart.tsx created with Victory Native line chart, time range selector, and summary stats</done>
</task>

<task type="auto">
  <name>Task 3: Export PortfolioLineChart and verify TypeScript</name>
  <files>bullion-tracker-mobile/src/components/charts/index.ts, bullion-tracker-mobile/src/types/index.ts</files>
  <action>
1. Update the barrel export to include PortfolioLineChart:

```typescript
export { ChartContainer } from './ChartContainer';
export { TestChart } from './TestChart';
export { PortfolioLineChart } from './PortfolioLineChart';
```

2. Ensure HistoricalPoint type is exported from src/types/index.ts if not already present. Add:

```typescript
export interface HistoricalPoint {
  date: string;
  meltValue: number;
  bookValue: number;
  bullionValue: number;
  numismaticValue: number;
  totalValue: number;
  timestamp: number;
}
```

3. Run TypeScript check to verify no errors:
```bash
cd bullion-tracker-mobile && npx tsc --noEmit
```
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>PortfolioLineChart exported and TypeScript compiles successfully</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>PortfolioLineChart component with Victory Native line chart, time range selector, and summary stats</what-built>
  <how-to-verify>
    1. Run: cd bullion-tracker-mobile && npx expo start
    2. Open app on device/simulator
    3. Temporarily add PortfolioLineChart to DashboardScreen:
       - Import: import { PortfolioLineChart } from '../components/charts';
       - Add before AllocationDonutChart: <PortfolioLineChart />
    4. Verify:
       - Time range buttons (1W, 1M, 1Y, 5Y) appear and work
       - Line chart renders with gold-colored line
       - Summary stats show start/current value and change
       - Switching time ranges loads new data
    5. Check console for any Victory Native or Skia errors
    6. Keep PortfolioLineChart in DashboardScreen (Phase 42 will finalize layout)
  </how-to-verify>
  <resume-signal>Type "approved" if chart renders correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] api.getPortfolioHistory function exists and works
- [ ] PortfolioLineChart.tsx renders Victory Native line chart
- [ ] Time range selector switches between 1W, 1M, 1Y, 5Y
- [ ] Summary stats display correctly
- [ ] npx tsc --noEmit passes
- [ ] Manual verification: chart renders in app
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Line chart renders with animation
- Time range selector functional
- No Victory Native/Skia runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/38-portfolio-line-chart/38-01-SUMMARY.md`:

# Phase 38 Plan 01: Portfolio Line Chart Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- Added api.getPortfolioHistory() function
- Created PortfolioLineChart with Victory Native
- Implemented time range selector (1W, 1M, 1Y, 5Y)
- Added summary stats (start, current, change)

## Files Created/Modified

- `bullion-tracker-mobile/src/lib/api.ts` - Added getPortfolioHistory
- `bullion-tracker-mobile/src/components/charts/PortfolioLineChart.tsx` - New component
- `bullion-tracker-mobile/src/components/charts/index.ts` - Updated exports
- `bullion-tracker-mobile/src/types/index.ts` - Added HistoricalPoint type

## Decisions Made

[Document any decisions]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 39 (Allocation Donut Chart) - Victory Native line chart established
</output>
