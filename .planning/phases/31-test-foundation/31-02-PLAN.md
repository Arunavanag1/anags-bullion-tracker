---
phase: 31-test-foundation
plan: 02
type: tdd
---

<objective>
TDD for portfolio calculation functions: calculateCurrentBookValue, calculateCurrentMeltValue, getPurchasePrice, getCalculatedValues.

Purpose: Ensure valuation calculations are correct and documented via tests. These are business-critical functions that determine portfolio value display.
Output: Comprehensive test coverage for all calculation functions with edge cases.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/references/tdd.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@bullion-tracker/src/lib/calculations.ts

**Valuation Types:**
- `spot_premium`: Bullion - spot × weight × quantity × (1 + premium%)
- `guide_price`: Numismatic - fixed numismaticValue
- `custom`: Fixed customBookValue
- Legacy `spot`: Treat as spot_premium with 0%

**Key Behaviors to Test:**
1. calculateCurrentBookValue: Each valuation type, edge cases (missing values, 0 weight)
2. calculateCurrentMeltValue: weight × quantity × spot
3. getPurchasePrice: Fallback chain (purchasePrice → customBookValue → original melt)
4. getCalculatedValues: Combines above, calculates percentChange
</context>

<feature>
  <name>Portfolio Calculation Functions</name>
  <files>bullion-tracker/src/lib/__tests__/calculations.test.ts, bullion-tracker/src/lib/calculations.ts</files>
  <behavior>
    calculateCurrentBookValue:
    - spot_premium: item(metal=gold, weightOz=1, quantity=2, premiumPercent=5), spot=2000 → 4200
    - spot_premium no premium: item(weightOz=1, quantity=1, premiumPercent=0), spot=30 → 30
    - guide_price: item(numismaticValue=500) → 500 (ignores spot)
    - custom: item(customBookValue=1000) → 1000 (ignores spot)
    - legacy spot: item(bookValueType='spot', weightOz=1), spot=30 → 30
    - missing weight: item(weightOz=0) → 0
    - missing numismaticValue for guide_price: → 0

    calculateCurrentMeltValue:
    - item(weightOz=1, quantity=5), spot=30 → 150
    - item(weightOz=0.5, quantity=2), spot=2000 → 2000
    - missing quantity (default 1): item(weightOz=1), spot=30 → 30

    getPurchasePrice:
    - Has purchasePrice: item(purchasePrice=100) → 100
    - No purchasePrice, has customBookValue: item(customBookValue=150) → 150
    - Neither, use original melt: item(weightOz=1, quantity=1, spotPriceAtCreation=25) → 25

    getCalculatedValues:
    - Returns all values with correct percentChange
    - isTracking true for spot_premium, false for guide_price/custom
  </behavior>
  <implementation>
    Write tests first (RED), then verify existing implementation passes (should be GREEN).
    If tests fail, fix the implementation or adjust tests based on intended behavior.
  </implementation>
</feature>

<verification>
cd bullion-tracker && npm test -- --filter calculations
All calculation tests pass
</verification>

<success_criteria>
- Failing tests written and committed (RED)
- Tests pass with existing implementation (GREEN)
- Edge cases covered (0 weight, missing values, all valuation types)
- Commits follow pattern: test(31-02), feat(31-02) or just test(31-02) if no changes needed
</success_criteria>

<output>
After completion, create `.planning/phases/31-test-foundation/31-02-SUMMARY.md` with:
- RED: Tests written, expected failures documented
- GREEN: Which tests passed immediately vs needed fixes
- REFACTOR: Any cleanup done
- Commits: List of commits
</output>
