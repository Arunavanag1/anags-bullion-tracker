---
phase: 39-allocation-donut-chart
plan: 01
type: execute
---

<objective>
Create an animated Victory Native pie/donut chart showing portfolio allocation by metal or category.

Purpose: Replace the basic SVG AllocationDonutChart with an interactive, animated Victory Native chart matching the website's functionality.
Output: Working AllocationPieChart component with metal/category toggle and animated segments.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-victory-native-setup/37-01-SUMMARY.md
@.planning/phases/38-portfolio-line-chart/38-01-SUMMARY.md

**Relevant source files:**
@bullion-tracker-mobile/src/components/AllocationDonutChart.tsx
@bullion-tracker-mobile/src/components/charts/ChartContainer.tsx
@bullion-tracker-mobile/src/components/charts/PortfolioLineChart.tsx
@bullion-tracker-mobile/src/lib/chartTheme.ts
@bullion-tracker-mobile/src/lib/api.ts
@bullion-tracker/src/components/charts/AllocationPieChart.tsx

**From Phase 37-38:**
- Victory Native with @shopify/react-native-skia configured
- ChartTheme with colors (gold, silver, platinum, positive, negative)
- ChartContainer wrapper for consistent styling
- Data types need `[key: string]: unknown` index signature for Victory Native

**Victory Native Pie/Donut API (from docs):**
```typescript
<PolarChart
  data={DATA}
  labelKey="label"
  valueKey="value"
  colorKey="color"
>
  <Pie.Chart innerRadius={50} />
</PolarChart>
```

**Existing mobile AllocationDonutChart:**
- Uses react-native-svg directly (basic implementation)
- Props: goldOz, silverOz, platinumOz, goldPrice, silverPrice, platinumPrice
- Calculates melt values and percentages
- No toggle, no animation, no center label

**Web AllocationPieChart features to replicate:**
- View mode toggle: "By Metal" (gold/silver/platinum) vs "By Category" (bullion/numismatic)
- Color scheme: gold=#C9A227, silver=#9CA3AF, platinum=#6B7280, bullion=#C9A227, numismatic=#4F46E5
- Center label showing total value
- Legend with name and percentage
- Animated segments
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AllocationPieChart component with Victory Native</name>
  <files>bullion-tracker-mobile/src/components/charts/AllocationPieChart.tsx</files>
  <action>
Create a new AllocationPieChart component using Victory Native's PolarChart and Pie.Chart.

Features to implement:
1. Accept collection items and spot prices as props
2. View mode toggle (metal vs category) with pill-style buttons
3. Donut chart with innerRadius for center label
4. Center label showing total portfolio value
5. Legend below chart showing segment name and percentage
6. Animated segments using ChartTheme.animation

Component structure:
```typescript
import React, { useState, useMemo } from 'react';
import { View, Text, StyleSheet, TouchableOpacity } from 'react-native';
import { PolarChart, Pie } from 'victory-native';
import { ChartContainer } from './ChartContainer';
import { ChartTheme } from '../../lib/chartTheme';
import { Colors } from '../../lib/colors';
import type { CollectionItem } from '../../lib/api';

type ViewMode = 'metal' | 'category';

interface AllocationPieChartProps {
  collection: CollectionItem[];
  spotPrices: {
    gold: number;
    silver: number;
    platinum: number;
  };
}

interface PieDataItem {
  label: string;
  value: number;
  color: string;
  percentage: number;
  [key: string]: unknown;
}

const METAL_COLORS: Record<string, string> = {
  Gold: Colors.gold,
  Silver: Colors.silver,
  Platinum: Colors.platinum,
};

const CATEGORY_COLORS: Record<string, string> = {
  Bullion: Colors.gold,
  Numismatic: '#4F46E5',
};

export function AllocationPieChart({ collection, spotPrices }: AllocationPieChartProps) {
  const [viewMode, setViewMode] = useState<ViewMode>('metal');

  const { chartData, totalValue } = useMemo(() => {
    if (!collection || collection.length === 0) {
      return { chartData: [], totalValue: 0 };
    }

    const totals: Record<string, number> = {};
    let total = 0;

    collection.forEach((item) => {
      const metal = item.metal as 'gold' | 'silver' | 'platinum';
      if (!metal || !spotPrices[metal]) return;

      const spotPrice = spotPrices[metal];
      const weightOz = item.weightOz || 0;
      const value = weightOz * spotPrice;

      if (viewMode === 'metal') {
        const metalName = metal.charAt(0).toUpperCase() + metal.slice(1);
        totals[metalName] = (totals[metalName] || 0) + value;
      } else {
        const category = item.category === 'NUMISMATIC' ? 'Numismatic' : 'Bullion';
        totals[category] = (totals[category] || 0) + value;
      }

      total += value;
    });

    const colors = viewMode === 'metal' ? METAL_COLORS : CATEGORY_COLORS;

    const data: PieDataItem[] = Object.entries(totals)
      .filter(([, value]) => value > 0)
      .map(([name, value]) => ({
        label: name,
        value,
        color: colors[name] || Colors.textSecondary,
        percentage: total > 0 ? (value / total) * 100 : 0,
      }))
      .sort((a, b) => b.value - a.value);

    return { chartData: data, totalValue: total };
  }, [collection, spotPrices, viewMode]);

  const formatCurrency = (value: number) => {
    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
    if (value >= 1000) return `$${(value / 1000).toFixed(1)}K`;
    return `$${value.toFixed(0)}`;
  };

  if (!collection || collection.length === 0) {
    return (
      <ChartContainer title="Portfolio Allocation" height={200}>
        <View style={styles.emptyContainer}>
          <Text style={styles.emptyText}>Add items to see allocation</Text>
        </View>
      </ChartContainer>
    );
  }

  return (
    <View>
      {/* View Mode Toggle */}
      <View style={styles.toggleContainer}>
        <TouchableOpacity
          style={[styles.toggleButton, viewMode === 'metal' && styles.toggleButtonActive]}
          onPress={() => setViewMode('metal')}
        >
          <Text style={[styles.toggleText, viewMode === 'metal' && styles.toggleTextActive]}>
            By Metal
          </Text>
        </TouchableOpacity>
        <TouchableOpacity
          style={[styles.toggleButton, viewMode === 'category' && styles.toggleButtonActive]}
          onPress={() => setViewMode('category')}
        >
          <Text style={[styles.toggleText, viewMode === 'category' && styles.toggleTextActive]}>
            By Category
          </Text>
        </TouchableOpacity>
      </View>

      {/* Chart */}
      <ChartContainer title="Portfolio Allocation" height={200}>
        {chartData.length > 0 ? (
          <View style={styles.chartWrapper}>
            <PolarChart
              data={chartData}
              labelKey="label"
              valueKey="value"
              colorKey="color"
            >
              <Pie.Chart innerRadius={50} />
            </PolarChart>
            {/* Center Label */}
            <View style={styles.centerLabel}>
              <Text style={styles.centerLabelSmall}>Total</Text>
              <Text style={styles.centerLabelValue}>{formatCurrency(totalValue)}</Text>
            </View>
          </View>
        ) : (
          <View style={styles.emptyContainer}>
            <Text style={styles.emptyText}>No allocation data</Text>
          </View>
        )}
      </ChartContainer>

      {/* Legend */}
      {chartData.length > 0 && (
        <View style={styles.legend}>
          {chartData.map((item) => (
            <View key={item.label} style={styles.legendItem}>
              <View style={[styles.legendDot, { backgroundColor: item.color }]} />
              <Text style={styles.legendText}>
                {item.label} ({item.percentage.toFixed(1)}%)
              </Text>
            </View>
          ))}
        </View>
      )}
    </View>
  );
}

const styles = StyleSheet.create({
  toggleContainer: {
    flexDirection: 'row',
    backgroundColor: Colors.bgSecondary,
    borderRadius: 8,
    padding: 4,
    marginHorizontal: 16,
    marginBottom: 8,
  },
  toggleButton: {
    flex: 1,
    paddingVertical: 8,
    alignItems: 'center',
    borderRadius: 6,
  },
  toggleButtonActive: {
    backgroundColor: Colors.bgCard,
  },
  toggleText: {
    fontSize: 13,
    fontWeight: '600',
    color: Colors.textSecondary,
  },
  toggleTextActive: {
    color: Colors.textPrimary,
  },
  chartWrapper: {
    flex: 1,
    position: 'relative',
  },
  centerLabel: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    justifyContent: 'center',
    alignItems: 'center',
  },
  centerLabelSmall: {
    fontSize: 11,
    color: Colors.textSecondary,
  },
  centerLabelValue: {
    fontSize: 16,
    fontWeight: '700',
    color: Colors.textPrimary,
  },
  legend: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'center',
    gap: 16,
    marginHorizontal: 16,
    marginTop: 8,
  },
  legendItem: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 6,
  },
  legendDot: {
    width: 10,
    height: 10,
    borderRadius: 5,
  },
  legendText: {
    fontSize: 12,
    color: Colors.textSecondary,
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  emptyText: {
    color: Colors.textSecondary,
    fontSize: 14,
  },
});
```

Important: The center label positioning uses absolute positioning to overlay the donut hole. This is similar to the web implementation.
  </action>
  <verify>File exists and exports AllocationPieChart component</verify>
  <done>AllocationPieChart.tsx created with Victory Native pie chart, view mode toggle, center label, and legend</done>
</task>

<task type="auto">
  <name>Task 2: Export AllocationPieChart and verify TypeScript</name>
  <files>bullion-tracker-mobile/src/components/charts/index.ts</files>
  <action>
Update the barrel export to include AllocationPieChart:

```typescript
export { ChartContainer } from './ChartContainer';
export { TestChart } from './TestChart';
export { PortfolioLineChart } from './PortfolioLineChart';
export { AllocationPieChart } from './AllocationPieChart';
```

Then run TypeScript check:
```bash
cd bullion-tracker-mobile && npx tsc --noEmit
```

If there are any Victory Native type errors with PolarChart or Pie.Chart, add the index signature to PieDataItem interface (already included in Task 1).
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>AllocationPieChart exported and TypeScript compiles successfully</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>AllocationPieChart component with Victory Native donut chart, metal/category toggle, center label, and legend</what-built>
  <how-to-verify>
    1. Run: cd bullion-tracker-mobile && npx expo start
    2. Open app on device/simulator
    3. Add AllocationPieChart to DashboardScreen:
       - Import: import { AllocationPieChart } from '../components/charts';
       - Pass collection and spotPrices props (from existing DashboardScreen state)
       - Add below PortfolioLineChart: <AllocationPieChart collection={items} spotPrices={{ gold: spotPrices.gold, silver: spotPrices.silver, platinum: spotPrices.platinum }} />
    4. Verify:
       - Donut chart renders with colored segments
       - Toggle switches between "By Metal" and "By Category" views
       - Center shows total value
       - Legend displays below with percentages
       - Animations work when switching views
    5. Check console for any Victory Native errors
  </how-to-verify>
  <resume-signal>Type "approved" if chart renders correctly, or describe any issues (or "skip" to continue)</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] AllocationPieChart.tsx exists with Victory Native PolarChart
- [ ] View mode toggle works (metal/category)
- [ ] Center label shows total value
- [ ] Legend displays with percentages
- [ ] npx tsc --noEmit passes
- [ ] Manual verification: chart renders in app
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Donut chart renders with animation
- View mode toggle functional
- No Victory Native/Skia runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/39-allocation-donut-chart/39-01-SUMMARY.md`:

# Phase 39 Plan 01: Allocation Donut Chart Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- Created AllocationPieChart with Victory Native PolarChart
- Implemented view mode toggle (metal vs category)
- Added center label showing total portfolio value
- Added legend with segment names and percentages

## Files Created/Modified

- `bullion-tracker-mobile/src/components/charts/AllocationPieChart.tsx` - New component
- `bullion-tracker-mobile/src/components/charts/index.ts` - Updated exports

## Decisions Made

[Document any decisions]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 40 (Gain/Loss Bar Chart) - Victory Native pie chart pattern established
</output>
