---
phase: 36-deployment-verification
plan: 01
type: execute
---

<objective>
Create health check endpoint and environment validation for production deployment verification.

Purpose: Enable monitoring systems to verify app health and fail fast on missing configuration.
Output: Health check API endpoint, environment validation utility, comprehensive error messages for missing env vars.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./36-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Source files:**
@bullion-tracker/src/app/api/prices/route.ts (existing API pattern)
@bullion-tracker/src/lib/db.ts (database connection)
@bullion-tracker/.env.example (environment variable reference)

**Prior decisions:**
- Phase 33: Security headers middleware established
- Phase 33: Centralized API error handling pattern
- Phase 31-35: Code quality and security hardening complete

**Known constraints:**
- Uses Next.js 16 App Router
- Prisma for database
- Upstash Redis for rate limiting (optional)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health check endpoint</name>
  <files>bullion-tracker/src/app/api/health/route.ts</files>
  <action>
Create GET /api/health endpoint that returns:
- status: "healthy" | "degraded" | "unhealthy"
- timestamp: ISO timestamp
- version: from package.json
- checks object with:
  - database: { status, latencyMs } - run `SELECT 1` query
  - redis: { status, latencyMs } - only if UPSTASH configured, ping redis
  - spotPrices: { status } - verify METAL_PRICE_API_KEY exists

Return 200 for healthy/degraded, 503 for unhealthy.
Degraded = non-critical services down (redis).
Unhealthy = critical services down (database).

Do NOT include sensitive data (connection strings, secrets).
Use `export const dynamic = 'force-dynamic'` to prevent caching.
  </action>
  <verify>curl http://localhost:3000/api/health returns JSON with status, checks, timestamp</verify>
  <done>Health endpoint returns proper status based on dependency availability</done>
</task>

<task type="auto">
  <name>Task 2: Create environment validation utility</name>
  <files>bullion-tracker/src/lib/env.ts</files>
  <action>
Create environment validation utility that:

1. Defines required vs optional env vars:
   - Required: DATABASE_URL, NEXTAUTH_SECRET, NEXTAUTH_URL
   - Required for production: NEXT_PUBLIC_METAL_PRICE_API_KEY
   - Optional: UPSTASH_*, CLOUDINARY_*, GOOGLE_*

2. Exports `validateEnv()` function that:
   - Checks all required vars exist
   - Validates format where applicable (DATABASE_URL starts with postgresql://)
   - Returns { valid: boolean, missing: string[], warnings: string[] }

3. Exports `getEnvSummary()` for debugging (masks sensitive values):
   - DATABASE_URL: postgresql://***@host/db
   - NEXTAUTH_SECRET: [set]
   - UPSTASH_*: [configured] or [not set]

4. Add warning for development defaults (NEXTAUTH_SECRET = "your-secret-key-here")

Import and call validateEnv() in src/app/layout.tsx during development to fail fast.
  </action>
  <verify>npm run dev starts and logs env validation, missing vars cause clear error messages</verify>
  <done>Environment validation catches missing config early with actionable error messages</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `curl localhost:3000/api/health` returns proper JSON response
- [ ] Missing DATABASE_URL causes clear error message at startup
- [ ] No secrets exposed in health check response
</verification>

<success_criteria>

- Health check endpoint works and reports dependency status
- Environment validation fails fast with clear messages
- No regressions in existing functionality
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/36-deployment-verification/36-01-SUMMARY.md`
</output>
