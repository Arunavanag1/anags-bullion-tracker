---
phase: 36-deployment-verification
plan: 02
type: execute
---

<objective>
Set up error monitoring, Vercel deployment configuration, and create deployment runbook.

Purpose: Complete production readiness with monitoring, optimal Vercel config, and deployment documentation.
Output: Sentry integration, vercel.json configuration, DEPLOYMENT.md runbook.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./36-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-deployment-verification/36-01-SUMMARY.md

**Source files:**
@bullion-tracker/next.config.ts
@bullion-tracker/package.json
@bullion-tracker/.env.example
@bullion-tracker/src/middleware.ts (security headers)

**Prior decisions:**
- Phase 33: Security headers in middleware (CSP, X-Frame-Options, etc.)
- Phase 35: ESLint config updated, code quality verified
- Plan 36-01: Health check and env validation complete

**Known constraints:**
- Deploying to Vercel
- PostgreSQL database (Supabase/Neon recommended)
- Upstash Redis for rate limiting
- Cloudinary for images
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Sentry error monitoring</name>
  <files>
    bullion-tracker/package.json,
    bullion-tracker/sentry.client.config.ts,
    bullion-tracker/sentry.server.config.ts,
    bullion-tracker/sentry.edge.config.ts,
    bullion-tracker/next.config.ts,
    bullion-tracker/.env.example
  </files>
  <action>
1. Install Sentry: `npm install @sentry/nextjs`

2. Create sentry.client.config.ts:
   - Initialize with NEXT_PUBLIC_SENTRY_DSN env var
   - Set environment from NEXT_PUBLIC_VERCEL_ENV or "development"
   - Enable replay for 10% of sessions, 100% on error
   - Configure tracesSampleRate: 0.1 (10% in production)

3. Create sentry.server.config.ts:
   - Server-side initialization
   - Same DSN from SENTRY_DSN (server-side)
   - Enable spotlight for local development

4. Create sentry.edge.config.ts:
   - Edge runtime initialization (for middleware)
   - Minimal config, same DSN

5. Update next.config.ts:
   - Wrap with withSentryConfig from @sentry/nextjs
   - Configure source maps upload (production only)
   - Set org/project from env vars

6. Update .env.example:
   - Add NEXT_PUBLIC_SENTRY_DSN
   - Add SENTRY_DSN (server-side, same value)
   - Add SENTRY_AUTH_TOKEN (for source maps, optional)
   - Add SENTRY_ORG and SENTRY_PROJECT

Do NOT hardcode DSN - make it optional so app works without Sentry configured.
  </action>
  <verify>npm run build succeeds with Sentry configured, no errors when SENTRY_DSN not set</verify>
  <done>Sentry integrated, gracefully handles missing DSN, source maps configured for production</done>
</task>

<task type="auto">
  <name>Task 2: Create Vercel configuration</name>
  <files>bullion-tracker/vercel.json</files>
  <action>
Create vercel.json with:

1. Headers:
   - Cache static assets (1 year): /_next/static/*, images/*
   - No cache for API routes: /api/*
   - CORS headers for API if needed

2. Regions:
   - iad1 (US East) as primary
   - Comment noting user can add more regions

3. Functions configuration:
   - Default maxDuration: 10s
   - Specific routes needing more time (sync-prices): 30s

4. Build configuration:
   - buildCommand: "npm run build"
   - outputDirectory: ".next"

5. Environment variables note (comment):
   - Reference to .env.example for required variables

Keep it minimal - only override defaults where necessary.
Do NOT duplicate headers already in middleware.ts.
  </action>
  <verify>vercel.json is valid JSON, no conflicts with middleware security headers</verify>
  <done>Vercel configuration optimized for production deployment</done>
</task>

<task type="auto">
  <name>Task 3: Create deployment runbook</name>
  <files>bullion-tracker/DEPLOYMENT.md</files>
  <action>
Create comprehensive deployment documentation:

## Prerequisites
- Vercel account
- PostgreSQL database (Supabase, Neon, or Railway)
- Optional: Upstash Redis, Cloudinary, Sentry

## Environment Variables
- Table of all variables with Required/Optional, Description, How to get

## First Deployment Steps
1. Fork/clone repository
2. Create Vercel project
3. Configure environment variables
4. Deploy
5. Run database migrations (if needed)
6. Verify health check

## Post-Deployment Verification
- Check /api/health
- Test authentication flow
- Verify image uploads
- Check error monitoring (Sentry)

## Troubleshooting
- Common issues and solutions
- How to check logs
- Health check interpretation

## Security Checklist
- [ ] NEXTAUTH_SECRET is unique
- [ ] DATABASE_URL uses SSL
- [ ] Rate limiting enabled
- [ ] Cloudinary configured (avoid db bloat)

## Monitoring
- Health check endpoint usage
- Sentry dashboard
- Vercel analytics

Reference .env.example inline for variable details.
  </action>
  <verify>DEPLOYMENT.md exists and covers all deployment aspects</verify>
  <done>Deployment runbook complete with all steps and troubleshooting</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Sentry integration works (or gracefully degrades without DSN)
- [ ] vercel.json is valid JSON
- [ ] DEPLOYMENT.md is comprehensive
- [ ] No secrets in committed files
</verification>

<success_criteria>

- Sentry error monitoring integrated and functional
- Vercel configuration optimized for production
- Deployment runbook provides clear instructions
- Phase 36 complete
- v1.9 milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/36-deployment-verification/36-02-SUMMARY.md`
</output>
