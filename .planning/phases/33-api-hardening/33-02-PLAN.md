---
phase: 33-api-hardening
plan: 02
type: execute
---

<objective>
Add input validation utilities and API rate limiting for collection routes.

Purpose: Prevent abuse through input validation and rate limiting on write operations.
Output: Validation utilities, rate-limited collection routes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./33-02-SUMMARY.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-api-hardening/33-01-SUMMARY.md
@bullion-tracker/src/lib/ratelimit.ts
@bullion-tracker/src/lib/validation.ts
@bullion-tracker/src/app/api/collection/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add input sanitization and validation utilities</name>
  <files>bullion-tracker/src/lib/validation.ts</files>
  <action>
Extend the existing validation.ts with input sanitization utilities:

1. sanitizeString(input, maxLength): Trims, removes null bytes, truncates to maxLength
2. validatePositiveNumber(value, fieldName): Returns validation result for positive numbers
3. validateEnum(value, allowedValues, fieldName): Returns validation result for enum values
4. validateId(id): Validates CUID format (starts with 'c', 25 chars)

These will be used to sanitize and validate API inputs before processing.

DO NOT change existing validatePassword or validateEmail functions.
  </action>
  <verify>npm run build succeeds</verify>
  <done>Sanitization and validation utilities added to validation.ts</done>
</task>

<task type="auto">
  <name>Task 2: Add collection API rate limiter</name>
  <files>bullion-tracker/src/lib/ratelimit.ts</files>
  <action>
Add a separate rate limiter for collection write operations:

1. Add collectionRateLimiter: 30 requests per 60 seconds per user ID (more permissive than auth)
2. Add checkCollectionRateLimit(userId) helper function
3. Keep existing authRateLimiter unchanged

This prevents abuse of POST/PUT/DELETE operations while allowing normal usage.
The rate limit is per user (not IP) since these are authenticated routes.
  </action>
  <verify>npm run build succeeds</verify>
  <done>Collection rate limiter added alongside auth rate limiter</done>
</task>

<task type="auto">
  <name>Task 3: Apply validation and rate limiting to collection POST</name>
  <files>bullion-tracker/src/app/api/collection/route.ts</files>
  <action>
Update POST handler with input validation and rate limiting:

1. After getUserId(), check collection rate limit - return 429 if exceeded
2. Sanitize string inputs (title, notes) with sanitizeString(input, 500)
3. Validate numeric inputs (weightOz, quantity, prices) with validatePositiveNumber
4. Validate category with validateEnum
5. Validate metal with validateEnum(['gold', 'silver', 'platinum'])

Use validationError() from api-errors for validation failures.
Use rateLimitedError() for rate limit exceeded.

Keep existing business logic unchanged - just add validation layer.
  </action>
  <verify>npm run build succeeds, POST /api/collection still creates items correctly, rejects invalid inputs</verify>
  <done>Collection POST route has input validation and rate limiting</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests
- [ ] Collection POST validates inputs and returns clear error messages
- [ ] Rate limiting headers present on collection routes
</verification>

<success_criteria>

- Validation utilities added to validation.ts
- Collection rate limiter configured
- POST /api/collection validates and sanitizes all inputs
- All tests pass
- Phase 33 complete
</success_criteria>

<output>
After completion, create `.planning/phases/33-api-hardening/33-02-SUMMARY.md`
</output>
