---
phase: 33-api-hardening
plan: 01
type: execute
---

<objective>
Add security headers via Next.js middleware to protect against common web vulnerabilities.

Purpose: Harden the web application against XSS, clickjacking, MIME sniffing, and other attacks.
Output: Working middleware.ts with comprehensive security headers.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./33-01-SUMMARY.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-auth-security-audit/32-01-SUMMARY.md
@bullion-tracker/next.config.ts
@bullion-tracker/src/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security headers middleware</name>
  <files>bullion-tracker/src/middleware.ts</files>
  <action>
Create Next.js middleware that adds security headers to all responses:

1. Content-Security-Policy (CSP):
   - default-src 'self'
   - script-src 'self' 'unsafe-inline' 'unsafe-eval' (needed for Next.js dev)
   - style-src 'self' 'unsafe-inline'
   - img-src 'self' data: blob: https://res.cloudinary.com
   - connect-src 'self' https://api.metals.dev (spot prices API)
   - frame-ancestors 'none'

2. X-Frame-Options: DENY (prevent clickjacking)
3. X-Content-Type-Options: nosniff (prevent MIME sniffing)
4. X-XSS-Protection: 1; mode=block (legacy browser XSS filter)
5. Referrer-Policy: strict-origin-when-cross-origin
6. Permissions-Policy: camera=(), microphone=(), geolocation=()

Configure matcher to apply to all routes except static files (_next/static, favicon.ico).

DO NOT add HSTS yet - that should only be enabled after deployment verification on HTTPS.
  </action>
  <verify>npm run build succeeds, curl -I localhost:3000 shows security headers in response</verify>
  <done>Middleware created, all security headers present in responses</done>
</task>

<task type="auto">
  <name>Task 2: Add API error response standardization</name>
  <files>bullion-tracker/src/lib/api-errors.ts</files>
  <action>
Create a standardized API error handling utility:

1. Define error types enum: VALIDATION, UNAUTHORIZED, FORBIDDEN, NOT_FOUND, RATE_LIMITED, INTERNAL
2. Create ApiError class extending Error with type, statusCode, and optional details
3. Create helper functions:
   - validationError(message, details?) -> ApiError with 400
   - unauthorizedError(message?) -> ApiError with 401
   - forbiddenError(message?) -> ApiError with 403
   - notFoundError(message?) -> ApiError with 404
   - rateLimitedError(retryAfter?) -> ApiError with 429
   - internalError(message?) -> ApiError with 500
4. Create handleApiError(error) function that:
   - If ApiError: returns NextResponse.json with structured error
   - If generic Error with 'Unauthorized' message: returns 401
   - Otherwise: logs error, returns generic 500

This provides consistent error responses across all API routes.
  </action>
  <verify>npm run build succeeds, TypeScript compiles without errors</verify>
  <done>api-errors.ts created with all error types and handler function</done>
</task>

<task type="auto">
  <name>Task 3: Update collection routes to use standardized errors</name>
  <files>bullion-tracker/src/app/api/collection/route.ts, bullion-tracker/src/app/api/collection/[id]/route.ts</files>
  <action>
Refactor collection routes to use the new api-errors utilities:

1. Import handleApiError from @/lib/api-errors
2. Replace manual error handling in catch blocks with handleApiError(error)
3. Replace manual 400/404 responses with validationError() and notFoundError()
4. Keep existing validation logic but use new error helpers

This is a refactor - behavior should remain the same but error responses become consistent.
  </action>
  <verify>npm run build succeeds, GET/POST/PUT/DELETE on /api/collection still work correctly</verify>
  <done>Both collection route files updated to use standardized error handling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all 76 tests
- [ ] Security headers visible in browser dev tools (Network tab)
- [ ] API errors return consistent JSON structure
</verification>

<success_criteria>

- Middleware.ts created with security headers
- api-errors.ts utility created
- Collection routes refactored to use standardized errors
- All tests pass
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/33-api-hardening/33-01-SUMMARY.md`
</output>
