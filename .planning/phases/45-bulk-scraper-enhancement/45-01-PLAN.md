# Phase 45 Plan 01: Bulk Scraper Enhancement

## Goal

Update the existing PCGS scraper for current website structure, add NGC cross-reference capability, improve error handling with session management, and add progress tracking with resume capability for large series.

## Context

- Phase 44 established 67 coin series with priority tiers (P0-P3)
- SCRAPING-ROADMAP.md defines Phase 45 requirements
- Existing `pcgs_scraper.py` has basic scraping but needs:
  - Updated HTML selectors for PCGS website changes
  - NGC number cross-reference mapping
  - Better retry logic and session management
  - Progress tracking with resume capability

## Scope

**In Scope:**
- Update HTML selectors based on current PCGS CoinFacts structure
- Add NGC number field to coin data model
- Implement persistent session with cookie management
- Add progress tracking to SQLite for resume capability
- Improve error handling and logging

**Out of Scope:**
- Running the actual data population (Phase 46)
- Price refresh automation (Phase 47)
- Full-text search optimization (Phase 48)

## Tasks

### Task 1: Update HTML Selectors and Session Management

**Files:** `bullion-tracker/coin_scraper/scrapers/pcgs_scraper.py`

Update the scraper with:
1. Add session cookie persistence for authenticated-like browsing
2. Update `scrape_series()` selectors for current PCGS structure
3. Update `_parse_coin_row()` with fallback selector chains
4. Update `scrape_coin_detail()` selectors with multiple fallbacks
5. Add request headers to mimic browser behavior better

**Acceptance:**
- Scraper handles 403 errors gracefully with session refresh
- Multiple selector fallbacks for robustness
- Better logging of which selectors matched

### Task 2: Add Progress Tracking with Resume Capability

**Files:**
- `bullion-tracker/coin_scraper/scrapers/progress_tracker.py` (new)
- `bullion-tracker/coin_scraper/scrapers/pcgs_scraper.py` (update)

Create progress tracking:
1. Create ProgressTracker class with SQLite backend
2. Track: series started, series completed, coins attempted, coins failed
3. Add `get_resume_point()` to find where to continue
4. Add `mark_coin_complete()` and `mark_series_complete()`
5. Integrate progress tracker into PCGSScraper

**Acceptance:**
- Can stop and resume scraping mid-series
- Progress persisted to SQLite file
- CLI shows current progress stats

### Task 3: Improve Error Handling and NGC Field

**Files:**
- `bullion-tracker/coin_scraper/scrapers/pcgs_scraper.py`
- `bullion-tracker/coin_scraper/models/coin_reference.py` (if needed)

Enhancements:
1. Add `ngcNumber` field extraction from PCGS pages (if available)
2. Add exponential backoff with jitter for retries
3. Add circuit breaker for repeated failures
4. Better exception classification (network vs parsing vs rate limit)
5. Add summary report at end of scraping run

**Acceptance:**
- NGC numbers captured when available
- Graceful degradation on parse errors
- Circuit breaker prevents hammering failed endpoints
- End-of-run summary shows success/failure breakdown

### Task 4: Create Scraper CLI with Progress Display

**Files:**
- `bullion-tracker/coin_scraper/run_scraper.py` (update or create)

Create user-friendly CLI:
1. Add argparse for --series, --priority, --resume, --dry-run flags
2. Add progress bar (tqdm) for visual feedback
3. Add --verify flag to test selectors on sample pages
4. Add --status flag to show current progress

**Acceptance:**
- `python run_scraper.py --priority P0` scrapes P0 coins
- `python run_scraper.py --resume` continues from last position
- `python run_scraper.py --status` shows progress summary
- Visual progress bar during operation

## Verification

```bash
# Test selector verification on sample coin
python bullion-tracker/coin_scraper/run_scraper.py --verify --series silver-eagles

# Check progress tracking
python bullion-tracker/coin_scraper/run_scraper.py --status

# Dry run to verify selectors (no database writes)
python bullion-tracker/coin_scraper/run_scraper.py --priority P0 --dry-run --limit 5
```

## Dependencies

- **Phase 43:** PCGS API client (for potential hybrid use)
- **Phase 44:** COIN_SERIES config with 67 series and priorities

## Risks

1. **PCGS website changes:** Selectors may still fail - mitigated by fallback chains
2. **Rate limiting:** May get blocked - mitigated by polite delays and session management
3. **NGC mapping incomplete:** PCGS may not have NGC numbers - graceful handling

## Estimated Complexity

Medium - mostly enhancement of existing code with new tracking infrastructure.

---
*Phase: 45-bulk-scraper-enhancement*
*Plan: 01*
