---
phase: 04-environment-configuration
plan: 01
type: execute
---

<objective>
Fix hardcoded mobile API URL and establish proper environment configuration for both web and mobile apps.

Purpose: Enable mobile app to work across development, staging, and production environments without code changes.
Output: Environment-driven API configuration for mobile, comprehensive .env.example files for both platforms.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries:
@.planning/phases/03-security-hardening/03-02-SUMMARY.md

# Source files to modify:
@bullion-tracker-mobile/src/lib/api.ts
@bullion-tracker/.env.example

**Issue from CONCERNS.md:**
- Hardcoded Mobile API URL: `export const API_URL = 'http://192.168.100.102:3001';`
- Impact: Mobile app breaks outside development network
- Fix approach: Use environment variables with Expo Constants

**Tech stack available:**
- Expo ~54.0.30 with expo-constants for environment access
- React Native 0.81.5

**Established patterns from Phase 3:**
- .env.example updated with Rate Limiting vars
- Environment-driven configuration with graceful fallbacks
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add environment-driven API URL to mobile app</name>
  <files>bullion-tracker-mobile/src/lib/api.ts, bullion-tracker-mobile/app.json</files>
  <action>
    1. Update `bullion-tracker-mobile/src/lib/api.ts` to read API_URL from environment:

    ```typescript
    import Constants from 'expo-constants';

    // Get API URL from environment with development fallback
    function getApiUrl(): string {
      const envUrl = Constants.expoConfig?.extra?.apiUrl;
      if (envUrl) {
        return envUrl;
      }
      // Development fallback - warn in console
      console.warn('API_URL not configured, using localhost:3001');
      return 'http://localhost:3001';
    }

    export const API_URL = getApiUrl();
    ```

    2. Update `bullion-tracker-mobile/app.json` to include extra config:

    Add to the "expo" object:
    ```json
    "extra": {
      "apiUrl": process.env.API_URL || "http://localhost:3001"
    }
    ```

    Note: This requires expo-constants which is already installed. The extra config allows environment variables to be passed at build time.

    Why: Expo's Constants.expoConfig.extra is the standard pattern for runtime configuration. Falls back to localhost for development convenience.
  </action>
  <verify>
    1. File exists: `bullion-tracker-mobile/src/lib/api.ts`
    2. No hardcoded IP (192.168) in api.ts
    3. TypeScript compiles: `cd bullion-tracker-mobile && npx tsc --noEmit`
  </verify>
  <done>API_URL reads from environment with localhost fallback. No hardcoded IP addresses.</done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive mobile .env.example</name>
  <files>bullion-tracker-mobile/.env.example</files>
  <action>
    Replace the minimal `.env.example` with comprehensive documentation:

    ```
    # Bullion Tracker Mobile - Environment Configuration
    # Copy this file to .env and fill in values for your environment

    # =============================================================================
    # API Configuration
    # =============================================================================

    # Backend API URL - REQUIRED for app to function
    # Development (iOS Simulator): http://localhost:3001
    # Development (Android Emulator): http://10.0.2.2:3001
    # Development (Physical Device): http://YOUR_COMPUTER_IP:3001
    # Production: https://your-production-url.com
    API_URL=http://localhost:3001

    # =============================================================================
    # Optional: Metal Price API (if fetching prices directly from mobile)
    # =============================================================================
    # Get your free API key at: https://metalpriceapi.com
    # Note: Mobile app typically fetches prices through the backend API
    # METAL_PRICE_API_KEY=your_api_key_here
    ```

    Why: Clear documentation prevents developers from guessing correct values. Platform-specific guidance (iOS vs Android vs physical device) addresses common pain points.
  </action>
  <verify>
    1. File exists: `bullion-tracker-mobile/.env.example`
    2. Contains API_URL variable
    3. Contains platform-specific guidance (localhost, 10.0.2.2)
  </verify>
  <done>Mobile .env.example has API_URL with platform-specific guidance for iOS/Android/physical devices.</done>
</task>

<task type="auto">
  <name>Task 3: Enhance web .env.example with production guidance</name>
  <files>bullion-tracker/.env.example</files>
  <action>
    Add header comments and production deployment section to existing .env.example:

    Add at the top:
    ```
    # Bullion Tracker Web - Environment Configuration
    # Copy this file to .env and fill in values for your environment
    #
    # SECURITY: Never commit .env files with real values to git
    # Use secrets management (Vercel, 1Password) for production

    # =============================================================================
    ```

    Add section headers to organize existing content:
    - Database
    - NextAuth.js
    - Google OAuth (optional)
    - Metal Price API
    - Rate Limiting (Optional)
    - Admin/Development

    Add production deployment section at end:
    ```
    # =============================================================================
    # Production Deployment Notes
    # =============================================================================
    #
    # Vercel: Set environment variables in Project Settings > Environment Variables
    # Railway: Set in Variables tab of your service
    #
    # Required for production:
    # - DATABASE_URL (production PostgreSQL)
    # - NEXTAUTH_SECRET (generate new: openssl rand -base64 32)
    # - NEXTAUTH_URL (your production URL)
    # - NEXT_PUBLIC_METAL_PRICE_API_KEY
    #
    # Recommended for production:
    # - UPSTASH_REDIS_REST_URL (for rate limiting)
    # - UPSTASH_REDIS_REST_TOKEN
    ```

    Why: Section headers make long .env files scannable. Production notes help new developers deploy correctly.
  </action>
  <verify>
    1. File exists: `bullion-tracker/.env.example`
    2. Contains section headers (=====)
    3. Contains production deployment notes
  </verify>
  <done>Web .env.example has section headers, security warning, and production deployment guidance.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] No hardcoded IP addresses in mobile api.ts
- [ ] Mobile .env.example exists with API_URL
- [ ] Web .env.example has section organization
- [ ] TypeScript compiles in mobile: `cd bullion-tracker-mobile && npx tsc --noEmit`
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Mobile API URL reads from environment
- Both .env.example files are comprehensive and documented
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-environment-configuration/04-01-SUMMARY.md`
</output>
