---
phase: 56-account-deletion-security
plan: 01
type: execute
---

<objective>
Verify cascade deletes work correctly and ensure no orphaned data remains after account deletion.

Purpose: Validate that account deletion is complete and secure - no user data persists in database after deletion.
Output: Integration test proving cascade deletes work, audited delete endpoint, documented known limitations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-data-security-review/55-01-SUMMARY.md
@.planning/phases/54-auth-security-audit/54-01-SUMMARY.md

# Key files for this phase
@bullion-tracker/src/app/api/auth/delete-account/route.ts
@bullion-tracker/prisma/schema.prisma

**Tech stack available:**
- Vitest for testing (established in Phase 31)
- Prisma with PostgreSQL
- bcryptjs for password hashing

**Established patterns:**
- Integration tests in `bullion-tracker/src/__tests__/`
- Transaction pattern for multi-table operations
- Rate limiting on sensitive endpoints

**Constraining decisions:**
- Phase 55: User existence verification added to getUserId() - delete endpoint must handle user-not-found case
- Phase 54: All auth endpoints rate limited

**Known limitation (pre-existing):**
- Cloudinary images uploaded but publicId not stored in DB - orphaned images after account deletion (acceptable cost tradeoff, not security issue)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write cascade delete integration test</name>
  <files>bullion-tracker/src/__tests__/api/auth/delete-account.test.ts</files>
  <action>
Create integration test that:
1. Creates a test user with password
2. Creates full data tree: CollectionItems with Images, PortfolioSnapshots, OAuthAuthorizationCode, OAuthRefreshToken
3. Calls delete-account endpoint with correct password and confirmation text
4. Verifies user deleted
5. Verifies ALL related records deleted (no orphans in any table)
6. Tests edge cases: wrong password returns 401, wrong confirmation text returns 400, unauthenticated returns 401

Use direct Prisma queries to verify deletions (not API calls). Create test OAuthClient fixture if needed for OAuth tokens.

Pattern: Follow existing test patterns in src/__tests__/ - use beforeEach/afterEach for cleanup, mock auth where needed.

IMPORTANT: Do NOT use vi.mock for prisma - use actual database with test transactions or cleanup.
  </action>
  <verify>npm test -- src/__tests__/api/auth/delete-account.test.ts passes</verify>
  <done>Test file exists, all assertions pass, verifies no orphaned records in any related table</done>
</task>

<task type="auto">
  <name>Task 2: Audit and simplify delete endpoint</name>
  <files>bullion-tracker/src/app/api/auth/delete-account/route.ts</files>
  <action>
Review delete-account endpoint for completeness:

1. The explicit OAuth token deletes (lines 90-96) are REDUNDANT since schema has onDelete: Cascade. However, keeping them is defensive programming. Leave them but add comment explaining why.

2. Verify transaction is properly structured - currently good.

3. Add comment documenting what cascade handles vs what's explicit:
   - Cascade: Account, Session, CollectionItem (â†’ Image, ItemValueHistory), PortfolioSnapshot, OAuthAuthorizationCode, OAuthRefreshToken
   - Explicit in transaction: OAuthAuthorizationCode, OAuthRefreshToken (defensive)

4. Ensure error logging doesn't leak sensitive info (currently only logs "Account deletion error:" which is fine).

Changes should be minimal - mainly adding clarifying comments. Do NOT over-engineer.
  </action>
  <verify>npm run build passes, endpoint behavior unchanged</verify>
  <done>Delete endpoint has clarifying comments documenting cascade behavior, no functional changes</done>
</task>

<task type="auto">
  <name>Task 3: Document Cloudinary orphan limitation</name>
  <files>bullion-tracker/src/lib/cloudinary.ts</files>
  <action>
Add JSDoc comment to uploadToCloudinary function documenting the known limitation:

```typescript
/**
 * Upload a base64 image to Cloudinary
 *
 * @param base64Data - Base64 encoded image data (data:image/...;base64,...)
 * @returns Cloudinary URL and public ID, or null if upload fails/not configured
 *
 * @note KNOWN LIMITATION: The returned publicId is not stored in the database.
 * When users delete their accounts, Cloudinary images become orphans.
 * This is an acceptable cost tradeoff - orphaned images are a billing concern,
 * not a security issue (images contain no PII beyond what's visible).
 * Future enhancement: Add cleanup job using Cloudinary Admin API to remove
 * images older than X days that aren't referenced in any Image record.
 */
```

This documents the limitation for future developers and provides a path forward.
  </action>
  <verify>npm run build passes, TypeScript types valid</verify>
  <done>Cloudinary limitation documented with JSDoc, includes future enhancement suggestion</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm test -- src/__tests__/api/auth/delete-account.test.ts` passes all tests
- [ ] `npm run build` succeeds without errors
- [ ] Delete endpoint has clarifying comments
- [ ] Cloudinary limitation documented
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Integration test proves no orphaned data after account deletion
- Delete endpoint code is well-documented
- Known limitation (Cloudinary orphans) is documented with path forward
</success_criteria>

<output>
After completion, create `.planning/phases/56-account-deletion-security/56-01-SUMMARY.md` following the summary template.

Document:
- Test coverage added
- Any edge cases discovered
- Cloudinary limitation documentation
</output>
