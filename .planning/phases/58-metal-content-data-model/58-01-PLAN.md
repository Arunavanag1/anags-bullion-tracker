---
phase: 58-metal-content-data-model
plan: 01
type: execute
---

<objective>
Add metal content fields to the CollectionItem schema to track precious metal weight for numismatic coins.

Purpose: Enable tracking of actual precious metal content (purity and weight) for numismatic items, which will feed into portfolio metal aggregation and US historical coinage rules engine in later phases.
Output: Updated Prisma schema with metal content fields, calculation utility, and updated TypeScript types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key source files:**
@bullion-tracker/prisma/schema.prisma
@bullion-tracker/src/types/index.ts

**Relevant context:**
- CoinReference already has `metal`, `weightOz`, `fineness` fields from price guide data
- CollectionItem has `weightOz` and `metal` but primarily for BULLION items
- For numismatics, metal content needs to be stored on CollectionItem for:
  - Coins autofilled from cert lookup (Phase 60)
  - Coins matched to US historical coinage rules (Phase 59)
  - Manual entry for raw coins (Phase 61)
- PortfolioSnapshot tracks goldOz, silverOz, platinumOz - will use these new fields in Phase 62

**Field design decisions:**
- `metalPurity`: Float (0.0-1.0), e.g., 0.900 for 90% silver, 0.9999 for .9999 gold
- `metalWeightOz`: Float, total weight of the coin in troy oz (gross weight)
- `preciousMetalOz`: Float, calculated = metalWeightOz × metalPurity (actual precious metal content)
- All nullable since existing items won't have these values initially
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add metal content fields to CollectionItem schema</name>
  <files>bullion-tracker/prisma/schema.prisma</files>
  <action>
Add three new fields to the CollectionItem model after the existing `weightOz` field:

```prisma
// Metal content for numismatics (populated by cert lookup, US coinage rules, or manual entry)
metalPurity      Float?   // 0.0-1.0, e.g., 0.900 for 90% silver
metalWeightOz    Float?   // Total coin weight in troy oz (gross weight)
preciousMetalOz  Float?   // Calculated: metalWeightOz × metalPurity
```

These fields are nullable because:
1. Existing items won't have these values
2. Bullion items use `weightOz` directly (purity assumed 0.999+)
3. Some numismatic items may not have known metal content

Run `npx prisma generate` to update the Prisma client.
Run `npx prisma db push` to apply schema changes (development) or create migration for production.
  </action>
  <verify>npx prisma validate passes, npx prisma generate succeeds without errors</verify>
  <done>Schema updated with metalPurity, metalWeightOz, preciousMetalOz fields on CollectionItem</done>
</task>

<task type="auto">
  <name>Task 2: Create metal content calculation utility</name>
  <files>bullion-tracker/src/lib/metal-content.ts</files>
  <action>
Create a new utility module for metal content calculations:

```typescript
/**
 * Metal Content Calculation Utilities
 *
 * Provides functions for calculating precious metal content from
 * coin weight and purity. Used by:
 * - Cert lookup autofill (Phase 60)
 * - US historical coinage rules (Phase 59)
 * - Manual entry validation (Phase 61)
 * - Portfolio aggregation (Phase 62)
 */

export interface MetalContent {
  metalPurity: number | null;      // 0.0-1.0
  metalWeightOz: number | null;    // Total weight in troy oz
  preciousMetalOz: number | null;  // Calculated precious metal weight
}

/**
 * Calculate precious metal content from weight and purity.
 * Returns null if either input is null/undefined.
 */
export function calculatePreciousMetalOz(
  metalWeightOz: number | null | undefined,
  metalPurity: number | null | undefined
): number | null {
  if (metalWeightOz == null || metalPurity == null) {
    return null;
  }
  // Round to 6 decimal places to avoid floating point issues
  return Math.round(metalWeightOz * metalPurity * 1000000) / 1000000;
}

/**
 * Build a complete MetalContent object, calculating preciousMetalOz.
 */
export function buildMetalContent(
  metalWeightOz: number | null | undefined,
  metalPurity: number | null | undefined
): MetalContent {
  return {
    metalPurity: metalPurity ?? null,
    metalWeightOz: metalWeightOz ?? null,
    preciousMetalOz: calculatePreciousMetalOz(metalWeightOz, metalPurity),
  };
}

/**
 * Validate metal purity is in valid range (0.0 to 1.0).
 * Returns true if valid or null, false if invalid.
 */
export function isValidPurity(purity: number | null | undefined): boolean {
  if (purity == null) return true;
  return purity >= 0 && purity <= 1;
}

/**
 * Validate metal weight is positive.
 * Returns true if valid or null, false if invalid.
 */
export function isValidWeight(weight: number | null | undefined): boolean {
  if (weight == null) return true;
  return weight > 0;
}
```

Keep it simple - this is foundation for later phases. Do NOT add US coinage rules here (that's Phase 59).
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit (or npm run build)</verify>
  <done>metal-content.ts utility created with calculatePreciousMetalOz, buildMetalContent, and validation functions</done>
</task>

<task type="auto">
  <name>Task 3: Update TypeScript types for metal content</name>
  <files>bullion-tracker/src/types/index.ts</files>
  <action>
Add metal content fields to the item interfaces. Update both ItemizedPiece and BulkWeight interfaces:

After the `weightOz` field in ItemizedPiece, add:
```typescript
// Metal content for numismatics
metalPurity?: number;      // 0.0-1.0, e.g., 0.900 for 90% silver
metalWeightOz?: number;    // Total coin weight in troy oz
preciousMetalOz?: number;  // Calculated: metalWeightOz × metalPurity
```

Add the same fields to BulkWeight interface after its `weightOz` field.

Also export the MetalContent interface from the types file for use across the app:
```typescript
// Metal Content (re-export from utility for convenience)
export type { MetalContent } from '@/lib/metal-content';
```

Do NOT modify CollectionSummary or PortfolioSnapshot types yet - that's Phase 62.
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit (or npm run build)</verify>
  <done>ItemizedPiece and BulkWeight interfaces updated with metalPurity, metalWeightOz, preciousMetalOz fields</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx prisma validate` passes
- [ ] `npx prisma generate` succeeds
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] New fields appear in generated Prisma types
- [ ] metal-content.ts utility exports all functions
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Schema migration ready (or db push applied in dev)
- Metal content utility ready for use by Phase 59-62
</success_criteria>

<output>
After completion, create `.planning/phases/58-metal-content-data-model/58-01-SUMMARY.md`:

# Phase 58 Plan 01: Metal Content Data Model Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `bullion-tracker/prisma/schema.prisma` - Added metal content fields
- `bullion-tracker/src/lib/metal-content.ts` - New calculation utility
- `bullion-tracker/src/types/index.ts` - Updated item interfaces

## Decisions Made

[Any decisions about field types, naming, etc.]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 58 complete. Ready for Phase 59: US Historical Coinage Rules Engine.
</output>
