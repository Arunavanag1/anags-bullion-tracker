---
phase: 18-state-management-refactor
plan: 01
type: execute
---

<objective>
Extract duplicated components, centralize spot prices state, and fix TypeScript any types in the mobile app.

Purpose: Reduce code duplication, eliminate redundant API calls, and improve type safety as foundation for Phases 19-20.
Output: Shared PricePill/TabButton components, SpotPricesContext provider, properly typed hooks and API responses.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./18-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Phase 17 Audit (direct dependency):**
@.planning/phases/17-mobile-code-audit/17-01-SUMMARY.md
@bullion-tracker-mobile/MOBILE-ARCHITECTURE.md

**Source files to modify:**
@bullion-tracker-mobile/src/screens/DashboardScreen.tsx
@bullion-tracker-mobile/src/screens/CollectionScreen.tsx
@bullion-tracker-mobile/src/screens/CollageScreen.tsx
@bullion-tracker-mobile/src/hooks/useCoins.ts
@bullion-tracker-mobile/src/lib/api.ts
@bullion-tracker-mobile/src/types/index.ts
@bullion-tracker-mobile/App.tsx

**Existing patterns to follow:**
@bullion-tracker-mobile/src/contexts/AuthContext.tsx
@bullion-tracker-mobile/src/components/ui/Button.tsx
@bullion-tracker-mobile/src/lib/colors.ts

**Constraining decisions:**
- Phase 4: Use expo-constants for mobile config (app.json extra, not .env)

**Tech stack available:**
- React Context API (already used in AuthContext)
- TypeScript 5.9
- NativeWind for styling
- Colors from lib/colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract PricePill and TabButton to shared components</name>
  <files>
    bullion-tracker-mobile/src/components/ui/PricePill.tsx (new),
    bullion-tracker-mobile/src/components/ui/TabButton.tsx (new),
    bullion-tracker-mobile/src/screens/DashboardScreen.tsx,
    bullion-tracker-mobile/src/screens/CollectionScreen.tsx,
    bullion-tracker-mobile/src/screens/CollageScreen.tsx
  </files>
  <action>
    1. Create `src/components/ui/PricePill.tsx`:
       - Extract PricePill from DashboardScreen.tsx:694-707
       - Props: `{ metal: string; price: number; color: string }`
       - Use StyleSheet for styles, import Colors from lib/colors.ts
       - Follow Button.tsx pattern for prop typing

    2. Create `src/components/ui/TabButton.tsx`:
       - Extract TabButton from DashboardScreen.tsx:714-730
       - Props: `{ icon: string; label: string; active: boolean; onPress: () => void; badge?: number }`
       - Include badge rendering logic
       - Use StyleSheet for styles

    3. Update screens to use shared components:
       - DashboardScreen.tsx: Remove inline PricePill (lines 694-707) and TabButton (lines 714-730), import from components/ui/
       - CollectionScreen.tsx: Remove inline PricePill (lines 591-602) and TabButton (lines 605-621), import from components/ui/
       - CollageScreen.tsx: Remove inline PricePill (lines 159-167) and TabButton (lines 169-185), import from components/ui/

    Do NOT change component behavior or styling - exact extraction only. This preserves functionality while eliminating ~60 lines of duplication.
  </action>
  <verify>
    - npx tsc --noEmit passes
    - App starts without errors: npx expo start
    - Visual check: spot prices banner and bottom tabs render identically
  </verify>
  <done>
    - PricePill.tsx and TabButton.tsx exist in src/components/ui/
    - All 3 screens import shared components
    - Inline component definitions removed from screens
    - No visual or behavioral changes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SpotPricesContext for centralized price state</name>
  <files>
    bullion-tracker-mobile/src/contexts/SpotPricesContext.tsx (new),
    bullion-tracker-mobile/App.tsx,
    bullion-tracker-mobile/src/screens/DashboardScreen.tsx,
    bullion-tracker-mobile/src/screens/CollectionScreen.tsx,
    bullion-tracker-mobile/src/screens/CollageScreen.tsx
  </files>
  <action>
    1. Create `src/contexts/SpotPricesContext.tsx`:
       - Follow AuthContext.tsx pattern exactly for structure
       - Provider state: `{ spotPrices: SpotPrices | null; isLoading: boolean; error: Error | null; refresh: () => Promise<void> }`
       - On mount: fetch prices using fetchSpotPrices from lib/prices.ts
       - Import API key from Constants.expoConfig.extra.metalPriceApiKey (same as current usage)
       - Export useSpotPrices hook that throws if used outside provider
       - Cache prices in AsyncStorage with 12-hour TTL (same as prices.ts current behavior)

    2. Update App.tsx:
       - Wrap navigation with SpotPricesProvider (inside AuthProvider)
       - Place after AuthProvider since prices don't require auth

    3. Update screens to use context instead of local fetch:
       - DashboardScreen.tsx: Remove spotPrices useState/useEffect, use useSpotPrices() hook
       - CollectionScreen.tsx: Remove spotPrices useState/useEffect, use useSpotPrices() hook
       - CollageScreen.tsx: Remove spotPrices useState/useEffect, use useSpotPrices() hook

    Benefits: Single API call instead of 3, consistent state across screens, no stale data issues.
  </action>
  <verify>
    - npx tsc --noEmit passes
    - App starts without errors
    - Prices load once on app start (check console for single fetch)
    - All 3 screens show same prices simultaneously
    - Pull-to-refresh still works (calls context refresh)
  </verify>
  <done>
    - SpotPricesContext.tsx exists with provider and hook
    - App.tsx wraps navigation with SpotPricesProvider
    - All 3 screens use useSpotPrices() instead of local state
    - Only 1 price fetch occurs on app load (not 3)
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix TypeScript any types in hooks and api.ts</name>
  <files>
    bullion-tracker-mobile/src/hooks/useCoins.ts,
    bullion-tracker-mobile/src/lib/api.ts,
    bullion-tracker-mobile/src/types/index.ts
  </files>
  <action>
    1. Fix useCollectionSummary return type (useCoins.ts:106):
       - Change `useState<any>(null)` to `useState<CollectionSummary | null>(null)`
       - Import CollectionSummary from types/index.ts

    2. Fix Fuse.js search result type (api.ts:170):
       - Define `interface FuseResult<T> { item: T; refIndex: number; score?: number }`
       - Change `(result: any)` to `(result: FuseResult<CoinReference>)`

    3. Fix image mapping types (api.ts:334-337, 350-352, 369-371, 387-390):
       - Define image response type: `interface ImageResponse { url: string } | string`
       - Change `(img: any)` to `(img: ImageResponse | string)` in all 4 locations
       - Type guard: `typeof img === 'string' ? img : img.url`

    Do NOT change any runtime behavior - types only. This improves IDE support and catches errors at compile time.
  </action>
  <verify>
    - npx tsc --noEmit passes with no errors
    - No `any` type errors in the modified files
    - grep -r ": any" bullion-tracker-mobile/src/hooks/ returns no matches
    - App functions identically
  </verify>
  <done>
    - useCollectionSummary returns CollectionSummary | null
    - Fuse.js result properly typed
    - Image mapping uses typed interface
    - No any types remaining in modified files
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npx tsc --noEmit passes in bullion-tracker-mobile/
- [ ] App starts and runs without errors
- [ ] Spot prices display correctly on all 3 screens
- [ ] Bottom navigation works identically to before
- [ ] Only 1 spot price API call on app load (not 3)
- [ ] grep -r "any" src/hooks/useCoins.ts returns no useState<any>
</verification>

<success_criteria>
- All 3 tasks completed
- PricePill.tsx and TabButton.tsx extracted and shared across 3 screens
- SpotPricesContext provides single source of truth for prices
- TypeScript any types eliminated from hooks and api.ts image mapping
- No visual or behavioral regressions
- ~60 lines of code removed (duplication eliminated)
</success_criteria>

<output>
After completion, create `.planning/phases/18-state-management-refactor/18-01-SUMMARY.md`:

---
phase: 18-state-management-refactor
plan: 01
subsystem: mobile
provides: [shared-components, spot-prices-context, typed-hooks]
affects: [19, 20]
tags: [refactor, state-management, typescript, mobile]
key-files:
  - bullion-tracker-mobile/src/components/ui/PricePill.tsx
  - bullion-tracker-mobile/src/components/ui/TabButton.tsx
  - bullion-tracker-mobile/src/contexts/SpotPricesContext.tsx
---

# Phase 18 Plan 01: State Management Refactor Summary

**[Substantive one-liner about what was refactored]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `bullion-tracker-mobile/src/components/ui/PricePill.tsx` - Shared spot price pill component
- `bullion-tracker-mobile/src/components/ui/TabButton.tsx` - Shared tab button component
- `bullion-tracker-mobile/src/contexts/SpotPricesContext.tsx` - Centralized prices context
- [Modified screens and hooks]

## Decisions Made
[Any decisions about implementation approach]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Phase 18 complete, ready for Phase 19 (Component Refactor)
</output>
