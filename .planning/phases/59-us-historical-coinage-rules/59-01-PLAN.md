---
phase: 59-us-historical-coinage-rules
plan: 01
type: execute
---

<objective>
Implement automatic metal content detection for US historical coins based on denomination and year.

Purpose: Automatically populate metalPurity, metalWeightOz, and preciousMetalOz fields for numismatic items when the coin matches known US historical coinage specifications (pre-1965 silver, pre-1933 gold, war nickels, etc.).

Output: Rules engine utility and integration with collection item creation that automatically applies metal content for qualifying US coins.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase providing metal content foundation:
@.planning/phases/58-metal-content-data-model/58-01-SUMMARY.md

# Research with exact US Mint specifications:
@.planning/phases/59-us-historical-coinage-rules/RESEARCH.md

# Source files:
@bullion-tracker/src/lib/metal-content.ts
@bullion-tracker/src/app/api/collection/route.ts
@bullion-tracker/prisma/schema.prisma

**Tech stack available:** Prisma, TypeScript, Next.js API routes
**Established patterns:**
- Metal content stored on item, not computed on-the-fly
- preciousMetalOz = metalWeightOz × metalPurity formula
- Float (0.0-1.0) for purity
- Nullable fields for backward compatibility

**Constraining decisions:**
- Phase 58: Float type for purity (0.0-1.0 range) rather than percentage
- Phase 58: Separate utility file for calculations to enable reuse across phases
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create US coinage rules engine utility</name>
  <files>bullion-tracker/src/lib/us-coinage-rules.ts</files>
  <action>
Create a new utility file with:

1. Define USCoinRule interface with fields: denomination (string), aliases (string[]), yearRange ({start, end}), metalType ('gold' | 'silver'), purity (number 0-1), totalWeightOz (number), preciousMetalOz (number)

2. Create SILVER_COIN_RULES array with entries for:
   - Dime (pre-1965): aliases ["10C", "10 Cent", "10-Cent"], years 1892-1964, purity 0.900, totalWeightOz 0.0804, preciousMetalOz 0.07234
   - Quarter (pre-1965): aliases ["25C", "25 Cent", "25-Cent"], years 1892-1964, purity 0.900, totalWeightOz 0.2010, preciousMetalOz 0.18084
   - Half Dollar (pre-1965): aliases ["50C", "50 Cent", "50-Cent", "Half"], years 1892-1964, purity 0.900, totalWeightOz 0.4019, preciousMetalOz 0.36169
   - Half Dollar (40% silver 1965-1970): aliases same, years 1965-1970, purity 0.400, totalWeightOz 0.36975, preciousMetalOz 0.14792
   - Dollar (Morgan/Peace): aliases ["$1", "1 Dollar", "Dollar"], years 1878-1935, purity 0.900, totalWeightOz 0.8594, preciousMetalOz 0.77344
   - War Nickel: aliases ["5C", "Nickel", "5 Cent"], years 1942-1945, purity 0.350, totalWeightOz 0.16075, preciousMetalOz 0.05626

3. Create GOLD_COIN_RULES array with entries for:
   - $1 Gold: aliases ["$1", "Gold Dollar", "1 Dollar Gold"], years 1849-1889, purity 0.900, totalWeightOz 0.05376, preciousMetalOz 0.04837
   - $2.50 Quarter Eagle: aliases ["$2.50", "$2 1/2", "Quarter Eagle"], years 1796-1929, purity 0.900, totalWeightOz 0.13438, preciousMetalOz 0.12094
   - $3 Gold: aliases ["$3", "Three Dollar"], years 1854-1889, purity 0.900, totalWeightOz 0.16124, preciousMetalOz 0.14512
   - $5 Half Eagle: aliases ["$5", "Half Eagle", "5 Dollar"], years 1795-1929, purity 0.900, totalWeightOz 0.26875, preciousMetalOz 0.24187
   - $10 Eagle: aliases ["$10", "Eagle", "10 Dollar"], years 1795-1933, purity 0.900, totalWeightOz 0.53750, preciousMetalOz 0.48375
   - $20 Double Eagle: aliases ["$20", "Double Eagle", "20 Dollar"], years 1849-1933, purity 0.900, totalWeightOz 1.07500, preciousMetalOz 0.96750

4. Create function detectUSCoinMetalContent(denomination: string, year: number): MetalContent | null
   - Normalize denomination to lowercase for matching
   - Check against all rules (silver first, then gold) looking for denomination match AND year within range
   - For denomination matching: check if denomination.toLowerCase() includes rule.denomination.toLowerCase() OR any alias
   - Return null if no match found
   - Return { metalPurity, metalWeightOz, preciousMetalOz } if match found

5. Create helper function normalizeUSCoinDenomination(rawDenom: string): string
   - Strip common prefixes/suffixes, normalize spacing
   - Handle cases like "10C" -> "dime", "$20" -> "$20 Double Eagle"
  </action>
  <verify>npm run build --prefix bullion-tracker succeeds with no type errors</verify>
  <done>us-coinage-rules.ts exports USCoinRule interface, SILVER_COIN_RULES, GOLD_COIN_RULES, and detectUSCoinMetalContent function</done>
</task>

<task type="auto">
  <name>Task 2: Integrate rules engine with numismatic item creation</name>
  <files>bullion-tracker/src/app/api/collection/route.ts</files>
  <action>
Modify the POST handler for numismatic item creation:

1. Import detectUSCoinMetalContent from @/lib/us-coinage-rules

2. In the NUMISMATIC category branch, after fetching coinReference (if present):
   - Extract denomination from coinReference.denomination
   - Extract year from coinReference.year
   - Call detectUSCoinMetalContent(denomination, year)
   - If result is not null, add metalPurity, metalWeightOz, preciousMetalOz to createData

3. For custom coins (no coinReferenceId), metal content detection is NOT applied automatically (will be handled by Phase 61 manual input)

4. Ensure existing fields (from coinReference.fineness and coinReference.weightOz) take precedence over rules engine when present - rules engine is fallback when coinReference doesn't have metal data
  </action>
  <verify>npm run build --prefix bullion-tracker succeeds</verify>
  <done>POST /api/collection automatically populates metal content fields for numismatic items with coinReference when US coinage rules match</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for US coinage rules engine</name>
  <files>bullion-tracker/src/lib/__tests__/us-coinage-rules.test.ts</files>
  <action>
Create test file with vitest tests:

1. Test detectUSCoinMetalContent for silver coins:
   - "10C" + 1964 → returns 90% silver dime specs
   - "Dime" + 1892 → returns 90% silver dime specs
   - "Quarter" + 1932 → returns 90% silver quarter specs
   - "Half Dollar" + 1964 → returns 90% silver half specs
   - "Half Dollar" + 1967 → returns 40% silver Kennedy specs
   - "Dollar" + 1921 → returns Morgan/Peace dollar specs
   - "Nickel" + 1943 → returns war nickel specs

2. Test detectUSCoinMetalContent for gold coins:
   - "$20" + 1928 → returns Double Eagle specs
   - "$10" + 1907 → returns Eagle specs
   - "$5" + 1900 → returns Half Eagle specs
   - "$2.50" + 1915 → returns Quarter Eagle specs

3. Test edge cases:
   - "Half Dollar" + 1971 → returns null (post-silver era)
   - "Quarter" + 1965 → returns null (clad)
   - "Nickel" + 1946 → returns null (post-war)
   - "$20" + 1934 → returns null (post-recall)
   - "Unknown Denomination" + 1900 → returns null

4. Verify returned preciousMetalOz matches expected values from RESEARCH.md
  </action>
  <verify>npm test --prefix bullion-tracker -- --run us-coinage-rules passes all tests</verify>
  <done>Test file covers silver, gold, and edge cases for US coinage detection with all tests passing</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build --prefix bullion-tracker` succeeds without errors
- [ ] `npm test --prefix bullion-tracker -- --run us-coinage-rules` passes all tests
- [ ] No TypeScript errors in new files
- [ ] detectUSCoinMetalContent returns correct values for known US coins
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- US coinage rules engine correctly identifies pre-1965 silver coins
- US coinage rules engine correctly identifies pre-1933 gold coins
- Edge cases (war nickels, 40% Kennedy halves) handled
- Rules engine integrated with collection item creation
- Tests cover key scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/59-us-historical-coinage-rules/59-01-SUMMARY.md`:

# Phase 59 Plan 01: US Historical Coinage Rules Engine Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 59 complete. Ready for Phase 60 (Cert Lookup Metal Autofill).
</output>
