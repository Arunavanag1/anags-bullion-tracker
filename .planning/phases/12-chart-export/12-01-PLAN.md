# Phase 12-01: Chart Export

**Add export utilities and export buttons to all charts**

## Context

This plan adds the ability to export charts as PNG images and underlying data as CSV files. All three chart components (PortfolioChart, AllocationPieChart, GainLossBarChart) will gain export functionality.

### Dependencies

- Phase 10-01: PortfolioChart with custom date range
- Phase 11-01: AllocationPieChart and GainLossBarChart components

### Research Findings

**html2canvas approach:**
- `html2canvas` library captures DOM elements as canvas, then exports as PNG
- Wrap chart in a ref, capture on button click
- Works well with Recharts since it renders as SVG in DOM

**Alternative: Recharts native SVG export:**
- Recharts renders SVG, could extract SVG directly and convert
- More complex, html2canvas is simpler for PNG

**CSV generation:**
- No library needed - generate CSV string from data array
- Use Blob + URL.createObjectURL for download

### Key Files

- `bullion-tracker/src/components/charts/PortfolioChart.tsx`
- `bullion-tracker/src/components/charts/AllocationPieChart.tsx`
- `bullion-tracker/src/components/charts/GainLossBarChart.tsx`
- `bullion-tracker/src/lib/exportUtils.ts` (new)

## Tasks

### Task 1: Create export utility functions

**Files:**
- Create: `bullion-tracker/src/lib/exportUtils.ts`

**Changes:**

1. Create `exportUtils.ts` with:

```typescript
// exportChartAsPNG(element: HTMLElement, filename: string): Promise<void>
// - Use html2canvas to capture element
// - Convert to PNG blob
// - Trigger download with filename

// exportDataAsCSV(data: Record<string, any>[], filename: string): void
// - Convert data array to CSV string
// - Handle headers from first object keys
// - Escape values with commas/quotes
// - Trigger download
```

2. Install html2canvas:
```bash
npm install html2canvas
npm install -D @types/html2canvas
```

**Verification:**
- [ ] TypeScript compiles without errors
- [ ] Functions exported correctly

**Commit message:** `feat(export): add chart PNG and CSV export utilities`

---

### Task 2: Add export buttons to PortfolioChart

**Files:**
- Modify: `bullion-tracker/src/components/charts/PortfolioChart.tsx`

**Changes:**

1. Import export utilities and useRef
2. Add ref to chart container div
3. Add export buttons in header area:
   - PNG export button (camera/download icon)
   - CSV export button (table/download icon)
4. Wire up click handlers:
   - PNG: call exportChartAsPNG with ref.current and filename
   - CSV: call exportDataAsCSV with filteredData and filename

**Button styling:**
- Small icon buttons matching existing UI
- Tooltip on hover explaining action
- Group together, right side of header

**Verification:**
- [ ] PNG download works (captures full chart with legend)
- [ ] CSV download works (includes date and value columns)
- [ ] Buttons don't interfere with existing controls

**Commit message:** `feat(chart): add PNG and CSV export to PortfolioChart`

---

### Task 3: Add export buttons to AllocationPieChart

**Files:**
- Modify: `bullion-tracker/src/components/charts/AllocationPieChart.tsx`

**Changes:**

1. Import export utilities and useRef
2. Add ref to chart container
3. Add export buttons in header (same pattern as PortfolioChart)
4. Wire up handlers:
   - PNG: capture pie chart with legend
   - CSV: export chartData (name, value, percentage)

**CSV columns:** Name, Value, Percentage

**Verification:**
- [ ] PNG captures chart with center label and legend
- [ ] CSV includes all allocation data

**Commit message:** `feat(chart): add PNG and CSV export to AllocationPieChart`

---

### Task 4: Add export buttons to GainLossBarChart

**Files:**
- Modify: `bullion-tracker/src/components/charts/GainLossBarChart.tsx`

**Changes:**

1. Import export utilities and useRef
2. Add ref to chart container
3. Add export buttons in header
4. Wire up handlers:
   - PNG: capture bar chart with summary
   - CSV: export chartData with full detail

**CSV columns:** Metal, Current Value, Cost Basis, Gain/Loss, Percent Change

**Verification:**
- [ ] PNG captures chart with summary section
- [ ] CSV includes all financial data

**Commit message:** `feat(chart): add PNG and CSV export to GainLossBarChart`

---

## Summary

| Task | Description | Files | Estimate |
|------|-------------|-------|----------|
| 1 | Create export utility functions | 1 new | Small |
| 2 | Add export to PortfolioChart | 1 modified | Small |
| 3 | Add export to AllocationPieChart | 1 modified | Small |
| 4 | Add export to GainLossBarChart | 1 modified | Small |

**Total files:** 1 new, 3 modified

## Deviation Handling

1. **html2canvas issues with Recharts SVG:** If html2canvas doesn't capture SVG correctly, consider using svg-to-image or domtoimage library instead
2. **Type issues with html2canvas:** May need to adjust types or use `// @ts-ignore` for edge cases
3. **Button styling conflicts:** Adjust button positioning if it conflicts with existing controls

---
*Phase: 12-chart-export*
*Created: 2026-01-10*
