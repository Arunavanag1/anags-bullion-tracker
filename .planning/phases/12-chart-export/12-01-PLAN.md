---
phase: 12-chart-export
plan: 01
type: execute
---

<objective>
Enable exporting charts as images (PNG/JPEG) and underlying data as CSV.

Purpose: Allow users to save and share their portfolio visualizations and data for record-keeping or external analysis.
Output: Export buttons on each chart component with PNG and CSV download functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./12-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STACK.md
@.planning/codebase/CONVENTIONS.md

**Key files:**
@bullion-tracker/src/components/charts/PortfolioChart.tsx
@bullion-tracker/src/components/charts/AllocationPieChart.tsx
@bullion-tracker/src/components/charts/GainLossBarChart.tsx

**Tech approach:**
- html2canvas for chart-to-image conversion (install as new dependency)
- Native Blob API for CSV generation (no external dependency)
- FileSaver pattern using download attribute on anchor

**Patterns to follow:**
- Button styling from existing UI
- Dropdown menu for export options
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install html2canvas and create export utilities</name>
  <files>bullion-tracker/package.json, bullion-tracker/src/lib/export.ts</files>
  <action>
Install html2canvas and create export utility functions:

1. Install dependency:
   ```bash
   npm install html2canvas
   ```

2. Create export utility file with these functions:

   a) exportToImage(elementRef: RefObject<HTMLElement>, filename: string, format: 'png' | 'jpeg'):
      - Use html2canvas to capture the element
      - Convert canvas to blob
      - Create download link with filename
      - Handle errors gracefully

   b) exportToCSV(data: Record<string, any>[], filename: string):
      - Convert data array to CSV string
      - Handle special characters (quotes, commas) in values
      - Create blob with text/csv type
      - Trigger download

   c) generateChartFilename(chartName: string, format: string):
      - Return formatted filename: "bullion-tracker-{chartName}-{date}.{format}"
      - Date format: YYYY-MM-DD

3. TypeScript types:
   - Export function signatures
   - Add html2canvas types (comes with package)
  </action>
  <verify>
- html2canvas installed and in package.json
- Export utility functions created
- TypeScript types correct
- npm run build passes
  </verify>
  <done>Export utilities created with image and CSV functions, build passes</done>
</task>

<task type="auto">
  <name>Task 2: Add export functionality to PortfolioChart</name>
  <files>bullion-tracker/src/components/charts/PortfolioChart.tsx</files>
  <action>
Add export buttons to the PortfolioChart component:

1. Add ref to the chart container:
   ```typescript
   const chartRef = useRef<HTMLDivElement>(null);
   ```

2. Add export handlers:
   - handleExportPNG: call exportToImage with chartRef, 'portfolio-value', 'png'
   - handleExportCSV: format chartData into CSV with columns: Date, Total Value, Bullion Value, Numismatic Value

3. Add export dropdown in header (next to time range selector):
   ```jsx
   <div className="relative">
     <button onClick={() => setShowExportMenu(!showExportMenu)}>
       Export â†“
     </button>
     {showExportMenu && (
       <div className="absolute right-0 mt-2 bg-white border rounded-lg shadow-lg">
         <button onClick={handleExportPNG}>Download PNG</button>
         <button onClick={handleExportCSV}>Download CSV</button>
       </div>
     )}
   </div>
   ```

4. Style dropdown to match existing UI:
   - bg-white, border-border, rounded-lg, shadow-lg
   - Buttons: px-4 py-2 hover:bg-bg-secondary text-sm

5. Close dropdown when clicking outside (useEffect with click listener)
  </action>
  <verify>
- Export dropdown appears in PortfolioChart
- PNG download captures chart correctly
- CSV download contains correct data columns
- Dropdown closes on outside click
- npm run build passes
  </verify>
  <done>PortfolioChart has working PNG and CSV export, build passes</done>
</task>

<task type="auto">
  <name>Task 3: Add export to AllocationPieChart and GainLossBarChart</name>
  <files>bullion-tracker/src/components/charts/AllocationPieChart.tsx, bullion-tracker/src/components/charts/GainLossBarChart.tsx</files>
  <action>
Add export functionality to the other chart components:

1. AllocationPieChart:
   - Add chartRef for image export
   - CSV columns: Category/Metal, Value, Percentage
   - Export dropdown in card header

2. GainLossBarChart:
   - Add chartRef for image export
   - CSV columns: Metal, Book Value, Current Value, Gain/Loss, Percentage Change
   - Export dropdown in card header

3. Extract reusable ExportDropdown component if code is duplicated:
   - Create bullion-tracker/src/components/ui/ExportDropdown.tsx if beneficial
   - Props: onExportPNG, onExportCSV, disabled?
   - OR keep inline if simpler

4. Ensure consistent behavior:
   - Same dropdown styling across all charts
   - Same filename convention
   - Same click-outside behavior
  </action>
  <verify>
- Both charts have export dropdowns
- PNG exports capture charts correctly
- CSV exports contain appropriate data for each chart
- Styling consistent across all charts
- npm run build passes
  </verify>
  <done>All chart components have working export functionality, build passes</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] html2canvas installed and working
- [ ] Export utilities created and typed
- [ ] PortfolioChart exports PNG and CSV
- [ ] AllocationPieChart exports PNG and CSV
- [ ] GainLossBarChart exports PNG and CSV
- [ ] Exports contain correct data
- [ ] No TypeScript errors
- [ ] `npm run build` succeeds
</verification>

<success_criteria>

- All tasks completed
- All three chart components have export functionality
- PNG exports capture full chart appearance
- CSV exports contain properly formatted data
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-chart-export/12-01-SUMMARY.md`
</output>
