---
phase: 23-dynamic-guide-price
plan: 01
type: execute
---

<objective>
Set up infrastructure for numismatic guide prices to update over time, with manual updates initially.

Purpose: Enable numismatic items with bookValueType='guide_price' to track value changes as guide prices update, providing users visibility into their collection's value history.

Output: ItemValueHistory model, sync endpoint to update numismaticValue from guide, value history display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase summary:**
@.planning/phases/22-valuation-type-system/22-01-SUMMARY.md

**Key files:**
@bullion-tracker/prisma/schema.prisma
@bullion-tracker/src/lib/calculations.ts
@bullion-tracker/src/app/api/coins/price-guide/route.ts
@bullion-tracker-mobile/src/components/numismatic/PriceGuideDisplay.tsx

**Relevant context:**
- CoinPriceGuide model exists with pcgsPrice, greysheetPrice, priceDate
- CollectionItem has numismaticValue (Float?) that stores current guide value
- bookValueType='guide_price' items use numismaticValue for calculateCurrentBookValue
- Price guide API endpoint fetches most recent price by coinReferenceId + gradeCode

**Decisions from Phase 22:**
- Phase 22: bookValueType='guide_price' items return numismaticValue from calculateCurrentBookValue
- Phase 22: isTracking=false for guide_price items (they don't track spot)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ItemValueHistory model and sync endpoint</name>
  <files>
bullion-tracker/prisma/schema.prisma,
bullion-tracker/src/app/api/collection/sync-prices/route.ts
  </files>
  <action>
1. Add ItemValueHistory model to schema.prisma:
```prisma
model ItemValueHistory {
  id              String   @id @default(cuid())
  collectionItemId String
  collectionItem  CollectionItem @relation(fields: [collectionItemId], references: [id], onDelete: Cascade)
  valueType       String   // 'guide_price' | 'spot_premium' | 'custom'
  value           Float
  priceDate       DateTime @db.Date
  source          String?  // 'pcgs' | 'greysheet' | 'manual' | 'spot'
  createdAt       DateTime @default(now())

  @@unique([collectionItemId, priceDate])
  @@index([collectionItemId, priceDate])
}
```

2. Add relation to CollectionItem:
```prisma
valueHistory    ItemValueHistory[]
```

3. Run `npx prisma db push` to apply schema changes

4. Create POST /api/collection/sync-prices endpoint:
   - Accepts optional `itemId` to sync single item, otherwise syncs all user's guide_price items
   - For each guide_price item: fetch latest CoinPriceGuide, update numismaticValue if changed
   - Create ItemValueHistory entry with current date
   - Return count of updated items

DO NOT use migrations - use prisma db push as per Phase 21 decision.
  </action>
  <verify>
- `npx prisma db push` succeeds
- `npx prisma generate` succeeds
- POST /api/collection/sync-prices returns success response
  </verify>
  <done>
- ItemValueHistory model created
- CollectionItem has valueHistory relation
- sync-prices endpoint functional
  </done>
</task>

<task type="auto">
  <name>Task 2: Add value history API and update calculations</name>
  <files>
bullion-tracker/src/app/api/collection/[id]/history/route.ts,
bullion-tracker/src/types/index.ts,
bullion-tracker/src/lib/calculations.ts
  </files>
  <action>
1. Create GET /api/collection/[id]/history endpoint:
   - Returns ItemValueHistory entries for item, ordered by priceDate desc
   - Include priceDate, value, source fields
   - Support optional `limit` query param (default 30)

2. Add ValueHistoryEntry type to types/index.ts:
```typescript
export interface ValueHistoryEntry {
  priceDate: string;
  value: number;
  source: string | null;
}
```

3. Update calculations.ts - add helper to record value history:
```typescript
export async function recordValueHistory(
  itemId: string,
  value: number,
  valueType: string,
  source: string | null
): Promise<void> {
  // Insert with today's date, upsert if already exists for today
}
```

4. Optionally call recordValueHistory when items are created/updated to bootstrap history.
  </action>
  <verify>
- `cd bullion-tracker && npx tsc --noEmit` passes
- GET /api/collection/{id}/history returns array of history entries
  </verify>
  <done>
- Value history API endpoint working
- ValueHistoryEntry type exported
- recordValueHistory helper available
  </done>
</task>

<task type="auto">
  <name>Task 3: Add mobile value history display</name>
  <files>
bullion-tracker-mobile/src/lib/api.ts,
bullion-tracker-mobile/src/components/numismatic/ValueHistoryChart.tsx,
bullion-tracker-mobile/src/screens/CollectionScreen.tsx
  </files>
  <action>
1. Add to api.ts:
```typescript
async getItemValueHistory(itemId: string, limit?: number): Promise<ValueHistoryEntry[]> {
  const response = await makeRequest(`/api/collection/${itemId}/history?limit=${limit || 30}`);
  if (!response.ok) throw new Error('Failed to fetch value history');
  const data = await response.json();
  return data.data || [];
}
```

2. Create ValueHistoryChart component:
   - Simple line chart showing value over time (use react-native-svg if available, or simple text list)
   - Show date range: "Last 30 days" or "All time"
   - Display current value prominently
   - Show % change from first to last entry

3. Add "Price History" button or section to CollectionScreen item detail view:
   - For numismatic items (bookValueType='guide_price'), show ValueHistoryChart
   - For items with no history, show "No price history available"

Keep it simple - text-based list is acceptable if charting library not installed.
  </action>
  <verify>
- `cd bullion-tracker-mobile && npx tsc --noEmit` passes (ignoring pre-existing CollageScreen errors)
- Value history displays for numismatic items
  </verify>
  <done>
- Mobile can fetch and display value history
- ValueHistoryChart component created
- CollectionScreen shows history for guide_price items
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd bullion-tracker && npm run build` succeeds
- [ ] `cd bullion-tracker-mobile && npx tsc --noEmit` passes (minus pre-existing errors)
- [ ] ItemValueHistory model exists in database
- [ ] sync-prices endpoint updates numismaticValue from latest guide price
- [ ] Value history API returns entries for an item
- [ ] Mobile displays value history for numismatic items
</verification>

<success_criteria>
- ItemValueHistory model stores value snapshots over time
- sync-prices endpoint updates numismaticValue for guide_price items
- GET /api/collection/{id}/history returns value history
- Mobile shows price history for numismatic items
- Missing guide prices handled gracefully (no error, just "no data")
</success_criteria>

<output>
After completion, create `.planning/phases/23-dynamic-guide-price/23-01-SUMMARY.md` with:

# Phase 23 Plan 01: Dynamic Guide Price Integration Summary

**[One-liner: what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `path/to/file` - Description

## Decisions Made
- [Any decisions, or "None"]

## Issues Encountered
- [Problems and resolutions, or "None"]

## Next Phase Readiness
- Ready for Phase 24: Portfolio Value Dashboard Updates
</output>
