# Phase 49 Plan 01: Cert Lookup API Integration

---
phase: 49-cert-lookup-api
plan: 01
type: execute
---

<objective>
Create API endpoint for PCGS cert number lookup and integrate with existing form to enable autofill functionality.

Purpose: Allow users to enter a PCGS cert number and automatically populate coin details from the PCGS API.
Output: `/api/coins/cert-lookup` endpoint, updated NumismaticForm with cert autofill, NGC fallback handling.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/49-cert-lookup-api/RESEARCH.md

# Key existing files:
@bullion-tracker/coin_scraper/api/pcgs_api.py (existing PCGS API client)
@bullion-tracker-mobile/src/components/addItem/NumismaticForm.tsx (form to enhance)
@bullion-tracker/src/app/api/coins/search/route.ts (search API pattern)

**Research findings:**
- PCGS: Public API available, we have working Python client with `get_coin_by_cert()`
- NGC: No public API, actively blocks automated access
- Strategy: Full PCGS autofill, NGC shows manual lookup link

**Current form state:**
- NumismaticForm has `certNumber` field (line 166)
- Grading service toggle (PCGS/NGC) at line 173
- Uses `CoinSearchInput` for coin selection
- Grade picker for grade entry

**Fields to autofill from PCGS response:**
- Coin selection (match to CoinReference by PCGS number)
- Grade
- Metal type (from coin data)
- Price guide value
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js Cert Lookup API Endpoint</name>
  <files>bullion-tracker/src/app/api/coins/cert-lookup/route.ts</files>
  <action>
Create `/api/coins/cert-lookup` API route:

1. Accept POST with `{ certNumber: string, service: "pcgs" | "ngc" }`:
   ```typescript
   interface CertLookupRequest {
     certNumber: string;
     service: 'pcgs' | 'ngc';
   }
   ```

2. For PCGS requests:
   - Validate cert number (7-8 digits)
   - Call PCGS API via Python script (spawn process or HTTP to local service)
   - Map response to our CoinReference fields
   - Try to match coin in our database by PCGS number
   - Return structured response with autofill data

3. For NGC requests:
   - Return `{ service: "ngc", requiresManualLookup: true, lookupUrl: "https://www.ngccoin.com/certlookup/" }`

4. Response format:
   ```typescript
   interface CertLookupResponse {
     success: boolean;
     service: 'pcgs' | 'ngc';
     requiresManualLookup?: boolean;
     lookupUrl?: string;
     data?: {
       pcgsNumber: number;
       fullName: string;
       year: number;
       mintMark: string | null;
       denomination: string;
       grade: string;
       gradeNumeric: number;
       metal: string;
       priceGuide: number | null;
       mintage: number | null;
       imageUrl: string | null;
       matchedCoinId: string | null; // Our CoinReference ID if matched
     };
     error?: string;
   }
   ```

5. Error handling:
   - Invalid cert format → 400
   - Cert not found → 404
   - PCGS API error → 502
   - Rate limit → 429
  </action>
  <verify>
curl -X POST localhost:3000/api/coins/cert-lookup -H "Content-Type: application/json" -d '{"certNumber":"12345678","service":"pcgs"}' returns coin data or appropriate error
curl -X POST localhost:3000/api/coins/cert-lookup -H "Content-Type: application/json" -d '{"certNumber":"1234567","service":"ngc"}' returns requiresManualLookup: true
  </verify>
  <done>
- API endpoint created with PCGS lookup integration
- NGC fallback returns manual lookup URL
- Response mapped to form-compatible fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript PCGS API Wrapper</name>
  <files>bullion-tracker/src/lib/pcgs-api.ts</files>
  <action>
Create TypeScript wrapper for PCGS API calls (avoids spawning Python):

1. Port essential functions from Python client:
   ```typescript
   export class PCGSApiClient {
     private accessToken: string | null = null;
     private tokenExpiresAt: Date | null = null;

     async authenticate(): Promise<string>;
     async getCoinByCert(certNo: string): Promise<PCGSCoinResponse>;
   }
   ```

2. Environment variables:
   - PCGS_USERNAME
   - PCGS_PASSWORD

3. OAuth2 password grant authentication (same as Python version)

4. Implement `getCoinByCert()`:
   - Call `GET /coindetail/GetCoinFactsByCertNo/{certNo}`
   - Handle token refresh
   - Return typed response

5. Add quota tracking (optional, can use database counter)

6. Error types:
   ```typescript
   export class PCGSApiError extends Error {}
   export class AuthenticationError extends PCGSApiError {}
   export class QuotaExceededError extends PCGSApiError {}
   ```
  </action>
  <verify>
TypeScript compiles without errors
Unit test: authenticate() returns token
Unit test: getCoinByCert() returns coin data for valid cert
  </verify>
  <done>
- TypeScript PCGS API client created
- OAuth2 authentication working
- getCoinByCert method implemented
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Mobile API Function for Cert Lookup</name>
  <files>bullion-tracker-mobile/src/api/coins.ts</files>
  <action>
Add cert lookup function to mobile API layer:

1. Add function to existing coins API:
   ```typescript
   export async function lookupCertNumber(
     certNumber: string,
     service: 'pcgs' | 'ngc'
   ): Promise<CertLookupResponse> {
     const response = await fetch(`${API_BASE_URL}/api/coins/cert-lookup`, {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({ certNumber, service }),
     });

     if (!response.ok) {
       throw new Error('Cert lookup failed');
     }

     return response.json();
   }
   ```

2. Add TypeScript types for response

3. Handle errors appropriately (network, 404, rate limit)
  </action>
  <verify>
Function compiles without TypeScript errors
Can be imported in NumismaticForm
  </verify>
  <done>
- Mobile API function added
- Types exported for use in form
  </done>
</task>

<task type="auto">
  <name>Task 4: Enhance NumismaticForm with Cert Autofill</name>
  <files>bullion-tracker-mobile/src/components/addItem/NumismaticForm.tsx</files>
  <action>
Add autofill functionality to certification number input:

1. Add debounced cert lookup when certNumber changes (and service is PCGS):
   ```typescript
   const [certLookupLoading, setCertLookupLoading] = useState(false);
   const [certLookupError, setCertLookupError] = useState<string | null>(null);

   useEffect(() => {
     if (currentGradingService === 'PCGS' && certNumber.length >= 7) {
       const timer = setTimeout(() => lookupCert(), 500);
       return () => clearTimeout(timer);
     }
   }, [certNumber, currentGradingService]);
   ```

2. Implement `lookupCert()` function:
   - Call `lookupCertNumber(certNumber, 'pcgs')`
   - On success, auto-populate fields:
     - Find matching coin in search (if matchedCoinId exists)
     - Set grade from response
     - Set metal type
     - Set price guide value
   - Show success indicator

3. For NGC:
   - Show info message: "NGC lookup requires manual verification"
   - Provide button to open NGC lookup URL in browser
   - After user returns, they manually enter data

4. UI updates:
   - Show loading spinner while looking up
   - Show success checkmark when autofilled
   - Show error message if lookup fails
   - "Autofill" badge next to cert input when PCGS selected

5. Allow user to override autofilled values
  </action>
  <verify>
Enter PCGS cert number → form fields populate automatically
Enter NGC cert number → shows manual lookup prompt
Can override autofilled values
  </verify>
  <done>
- Cert input triggers autofill on PCGS
- Form fields populate from API response
- NGC shows manual lookup fallback
- Loading/error states implemented
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `/api/coins/cert-lookup` endpoint responds correctly
- [ ] PCGS cert lookup returns coin data
- [ ] NGC requests return manual lookup fallback
- [ ] NumismaticForm autofills on PCGS cert entry
- [ ] Error handling works (invalid cert, not found, API error)
- [ ] No TypeScript errors
- [ ] Mobile app builds successfully
</verification>

<success_criteria>
- All 4 tasks completed
- PCGS autofill working end-to-end
- NGC graceful fallback implemented
- Form UX is smooth (loading states, error messages)
</success_criteria>

<output>
After completion, create `.planning/phases/49-cert-lookup-api/49-01-SUMMARY.md`:

# Phase 49 Plan 01: Cert Lookup API Integration Summary

**[One-liner describing outcome]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `bullion-tracker/src/app/api/coins/cert-lookup/route.ts`
- `bullion-tracker/src/lib/pcgs-api.ts`
- `bullion-tracker-mobile/src/api/coins.ts`
- `bullion-tracker-mobile/src/components/addItem/NumismaticForm.tsx`

## Decisions Made
[Any decisions and rationale]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
[Ready for Phase 50: Autofill Form Component]

---
*Phase: 49-cert-lookup-api*
*Plan: 01*
</output>
