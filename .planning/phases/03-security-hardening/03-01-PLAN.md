---
phase: 03-security-hardening
plan: 01
type: execute
---

<objective>
Fix critical authentication and authorization vulnerabilities in the web app.

Purpose: Eliminate security holes that could allow unauthorized access or credential compromise.
Output: Hardened auth system with proper JWT handling, strong passwords, and protected admin endpoints.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md

# Source files to modify:
@bullion-tracker/src/lib/auth.ts
@bullion-tracker/src/app/api/auth/signup/route.ts
@bullion-tracker/src/app/api/auth/mobile/signin/route.ts
@bullion-tracker/src/app/api/prices/seed/route.ts

**Security issues from CONCERNS.md:**
- Default JWT secret fallback: `'your-secret-key'` used if env missing (predictable tokens)
- Weak password: Only 6 char minimum (easy brute force)
- Unprotected seed endpoint: Anyone can delete/reseed price data
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove default JWT secret fallback</name>
  <files>bullion-tracker/src/lib/auth.ts, bullion-tracker/src/app/api/auth/mobile/signin/route.ts</files>
  <action>
    Replace the fallback pattern `process.env.NEXTAUTH_SECRET || 'your-secret-key'` with a hard fail:

    In auth.ts (line 5):
    ```typescript
    const JWT_SECRET = process.env.NEXTAUTH_SECRET;
    if (!JWT_SECRET) {
      throw new Error('NEXTAUTH_SECRET environment variable is required');
    }
    ```

    In mobile/signin/route.ts (line 6):
    Same pattern - fail hard at module load if secret missing.

    Why: Fallback strings make tokens predictable. App should fail fast, not silently use weak security.
  </action>
  <verify>
    1. Start app without NEXTAUTH_SECRET set: should crash with clear error
    2. Start app with NEXTAUTH_SECRET set: should work normally
    3. `grep -r "your-secret-key" bullion-tracker/src/` returns no matches
  </verify>
  <done>No default JWT secrets anywhere. App fails to start without proper env var.</done>
</task>

<task type="auto">
  <name>Task 2: Strengthen password requirements</name>
  <files>bullion-tracker/src/app/api/auth/signup/route.ts</files>
  <action>
    Update password validation (around line 17) to require:
    - Minimum 8 characters (not 6)
    - At least one uppercase letter
    - At least one lowercase letter
    - At least one number

    Add a helper function for password validation:
    ```typescript
    function isStrongPassword(password: string): { valid: boolean; reason?: string } {
      if (password.length < 8) {
        return { valid: false, reason: 'Password must be at least 8 characters' };
      }
      if (!/[A-Z]/.test(password)) {
        return { valid: false, reason: 'Password must contain at least one uppercase letter' };
      }
      if (!/[a-z]/.test(password)) {
        return { valid: false, reason: 'Password must contain at least one lowercase letter' };
      }
      if (!/[0-9]/.test(password)) {
        return { valid: false, reason: 'Password must contain at least one number' };
      }
      return { valid: true };
    }
    ```

    Replace the simple length check with this validation.
    Return the specific reason in the 400 response so users know what's wrong.

    Why: 6-char passwords are trivially brute-forceable. Complexity rules dramatically increase attack cost.
  </action>
  <verify>
    1. curl signup with "abc123" → 400 with "at least 8 characters"
    2. curl signup with "abcdefgh" → 400 with "uppercase letter"
    3. curl signup with "Abcdefgh" → 400 with "number"
    4. curl signup with "Abcdefg1" → 201 success (or 400 if email exists)
  </verify>
  <done>Password requires 8+ chars, uppercase, lowercase, number. Clear error messages.</done>
</task>

<task type="auto">
  <name>Task 3: Protect seed endpoint</name>
  <files>bullion-tracker/src/app/api/prices/seed/route.ts</files>
  <action>
    Add environment check to restrict seed endpoint to development only:

    At the start of the POST function:
    ```typescript
    // Only allow in development mode
    if (process.env.NODE_ENV === 'production') {
      return NextResponse.json(
        { error: 'Seed endpoint is disabled in production' },
        { status: 403 }
      );
    }
    ```

    Also add an optional admin key check for extra safety:
    ```typescript
    const adminKey = request.headers.get('x-admin-key');
    if (process.env.ADMIN_SEED_KEY && adminKey !== process.env.ADMIN_SEED_KEY) {
      return NextResponse.json(
        { error: 'Invalid admin key' },
        { status: 403 }
      );
    }
    ```

    Why: Seed endpoint deletes all price data. Must not be publicly accessible.
  </action>
  <verify>
    1. With NODE_ENV=production: POST /api/prices/seed → 403
    2. With NODE_ENV=development: POST /api/prices/seed → 200 (seeds data)
    3. If ADMIN_SEED_KEY set: requires matching x-admin-key header
  </verify>
  <done>Seed endpoint blocked in production. Optional admin key for dev environments.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] No "your-secret-key" strings in codebase
- [ ] Password validation rejects weak passwords
- [ ] Seed endpoint returns 403 in production mode
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Security improvements documented in SUMMARY
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-hardening/03-01-SUMMARY.md`
</output>
