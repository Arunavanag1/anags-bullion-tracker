---
phase: 55-data-security-review
plan: 01
type: execute
---

<objective>
Audit and remediate data security vulnerabilities: API response exposure, input validation gaps, authorization weaknesses, and token revocation.

Purpose: Ensure all API endpoints properly protect user data and cannot be exploited for unauthorized access.
Output: Hardened API layer with comprehensive input validation, proper authorization, and token revocation on account deletion.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-auth-security-audit/54-01-SUMMARY.md

**Tech stack available:** Prisma, NextAuth, JWT (jsonwebtoken), bcryptjs
**Established patterns:** Fail-hard for secrets, isProduction() check, rate limiting with Upstash

**Key files from Phase 54:**
@bullion-tracker/src/lib/auth.ts
@bullion-tracker/src/lib/validation.ts
@bullion-tracker/src/lib/ratelimit.ts
@bullion-tracker/src/app/api/collection/route.ts
@bullion-tracker/src/app/api/auth/delete-account/route.ts

**Constraining decisions from Phase 54:**
- Production environment detection: `NODE_ENV === 'production' || VERCEL === '1'`
- Fail-hard pattern for missing secrets

**Issues identified in exploration:**
1. FDX account authorization uses string format validation instead of database lookup
2. Deleted accounts retain valid JWT tokens until natural expiry
3. Rate limiting fails silently in production if Upstash not configured
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden FDX Account Authorization</name>
  <files>bullion-tracker/src/app/api/fdx/v6/accounts/[accountId]/transactions/route.ts, bullion-tracker/src/app/api/fdx/v6/accounts/[accountId]/route.ts</files>
  <action>
    Replace string-based accountId validation with proper ownership verification:

    Current (insecure):
    ```typescript
    if (!accountId.endsWith(userId)) {
      return NextResponse.json({ error: 'not_found' }, { status: 404 });
    }
    ```

    Fixed (secure):
    ```typescript
    // Validate accountId format matches expected pattern
    const expectedAccountId = `bullion_${userId}`;
    if (accountId !== expectedAccountId) {
      return NextResponse.json({ error: 'not_found' }, { status: 404 });
    }
    ```

    This ensures exact match rather than suffix match, preventing exploitation via crafted accountIds.
  </action>
  <verify>
    - Review both FDX route files to confirm exact match validation
    - Verify endpoints return 404 for mismatched accountIds
    - Build passes: `cd bullion-tracker && npm run build`
  </verify>
  <done>FDX account routes use exact match validation for accountId ownership</done>
</task>

<task type="auto">
  <name>Task 2: Add User Existence Check to getUserId</name>
  <files>bullion-tracker/src/lib/auth.ts</files>
  <action>
    Modify getUserId() to verify the user still exists in the database. This prevents deleted users from continuing to access the API with valid but orphaned tokens.

    After JWT verification, add a database check:
    ```typescript
    // After decoding JWT, verify user still exists
    const user = await prisma.user.findUnique({
      where: { id: decoded.userId },
      select: { id: true }
    });
    if (!user) {
      throw new Error('Unauthorized - User not found');
    }
    ```

    Import prisma from '@/lib/db' at the top of the file.

    Note: This adds one DB query per authenticated request for mobile users. This is acceptable for security - consider caching user existence in Redis for high-traffic scenarios (future enhancement).
  </action>
  <verify>
    - TypeScript compiles without errors
    - Test manually: delete account, try to use the JWT token - should get 401
    - Existing auth flows still work normally
  </verify>
  <done>getUserId() verifies user exists in database before returning userId, preventing deleted users from accessing API</done>
</task>

<task type="auto">
  <name>Task 3: Make Rate Limiting Fail-Hard in Production</name>
  <files>bullion-tracker/src/lib/ratelimit.ts</files>
  <action>
    Change the production warning to fail-hard error. Currently, if Upstash Redis is not configured in production, rate limiting is silently disabled (only logs warning).

    Update the check:
    ```typescript
    // Warn if rate limiting is disabled in production
    if (!redis && isProduction) {
      // FAIL HARD - rate limiting is critical for production security
      throw new Error(
        'UPSTASH_REDIS_REST_URL is required in production. ' +
        'Rate limiting protects against brute-force attacks. ' +
        'Configure Upstash Redis or set NODE_ENV=development.'
      );
    }
    ```

    This aligns with the fail-hard pattern established in Phase 54 for OAuth keys.
  </action>
  <verify>
    - In production without UPSTASH_REDIS_REST_URL, app should fail to start with clear error
    - In development without Redis, rate limiting still bypassed (for local dev convenience)
    - Build passes: `cd bullion-tracker && npm run build`
  </verify>
  <done>Rate limiting configuration fails hard in production if Upstash Redis not configured</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd bullion-tracker && npm run build` succeeds without errors
- [ ] FDX routes use exact match for accountId validation
- [ ] getUserId() includes user existence verification
- [ ] Rate limiting throws error in production if Redis not configured
- [ ] All TypeScript types compile correctly
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- FDX authorization hardened
- Deleted users cannot access API with stale tokens
- Rate limiting required in production
</success_criteria>

<output>
After completion, create `.planning/phases/55-data-security-review/55-01-SUMMARY.md`:

# Phase 55 Plan 01: Data Security Review Summary

**[Substantive one-liner describing security fixes applied]**

## Accomplishments
- FDX account authorization hardened
- User existence verification added to auth flow
- Rate limiting made fail-hard in production

## Files Created/Modified
- List all modified files with descriptions

## Decisions Made
- Any decisions and rationale

## Issues Encountered
- Problems and resolutions, or "None"

## Next Step
[If phase complete: "Phase complete, ready for Phase 56 (Account Deletion Security)"]
</output>
