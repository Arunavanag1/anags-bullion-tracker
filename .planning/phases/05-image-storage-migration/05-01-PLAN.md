# Phase 5 Plan 01: Image Storage Migration

**Phase**: 05-image-storage-migration
**Plan**: 01
**Created**: 2026-01-09
**Status**: Ready

## Objective

Migrate image storage from base64 strings in PostgreSQL to Cloudinary cloud storage, reducing database bloat and improving performance.

## Context

### Current State
- Images stored as base64 data URLs in the `Image.url` field (schema.prisma:112-121)
- `ImageUploader.tsx` compresses images client-side and stores as base64
- PUT/POST collection APIs accept base64 strings directly in `images` array
- Base64 storage bloats database and slows queries (especially mobile sync)

### Target State
- Images uploaded to Cloudinary via unsigned upload preset
- `Image.url` stores Cloudinary URLs instead of base64
- Migration script converts existing base64 images to Cloudinary
- Backwards-compatible: app still works with existing base64 URLs during transition

### Research Decision: Cloudinary vs S3

**Chosen: Cloudinary** (unsigned uploads)

Rationale:
- Simpler setup: No server-side SDK required for uploads
- Unsigned preset allows direct client-to-Cloudinary upload
- Built-in image transformations (resize, optimize)
- Free tier: 25GB storage, 25GB bandwidth/month
- S3 would require presigned URLs (server roundtrip) or public buckets (security risk)

## Dependencies

- Phase 4 complete (environment configuration)
- Cloudinary account (free tier sufficient)

## Tasks

### Task 1: Create Cloudinary Upload Utility

**Files to create:**
- `bullion-tracker/src/lib/cloudinary.ts`

**Implementation:**
1. Create upload utility that uses Cloudinary's unsigned upload API
2. Use environment variables: `NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME`, `NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET`
3. Return Cloudinary URL on success
4. Include fallback to base64 if Cloudinary not configured (for dev without cloud setup)

```typescript
// Core function signature
export async function uploadToCloudinary(
  base64Data: string
): Promise<{ url: string; publicId: string } | null>
```

**Verification:**
- TypeScript compiles without errors
- Function exports correctly

### Task 2: Update ImageUploader Component

**Files to modify:**
- `bullion-tracker/src/components/collection/ImageUploader.tsx`

**Implementation:**
1. Import `uploadToCloudinary` from new utility
2. After compression, attempt Cloudinary upload
3. If Cloudinary configured and upload succeeds, use returned URL
4. If Cloudinary not configured or fails, fall back to base64 (existing behavior)
5. Update the note at bottom to reflect Cloudinary status

**Verification:**
- TypeScript compiles without errors
- Image upload still works (falls back to base64 in dev)

### Task 3: Update Environment Configuration

**Files to modify:**
- `bullion-tracker/.env.example`

**Files to create:**
- None (add vars to existing .env.example)

**Implementation:**
1. Add Cloudinary section to `.env.example`:
   - `NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME`
   - `NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET`
2. Document how to create unsigned upload preset in Cloudinary dashboard
3. Add to production checklist

**Verification:**
- `.env.example` includes Cloudinary configuration section

### Task 4: Create Migration Script

**Files to create:**
- `bullion-tracker/scripts/migrate-images-to-cloudinary.ts`

**Implementation:**
1. Create standalone script that:
   - Fetches all Image records where URL starts with `data:image`
   - For each, uploads to Cloudinary
   - Updates Image record with new Cloudinary URL
   - Logs progress and errors
2. Make it idempotent (skip already-migrated images)
3. Add batch processing with delay to respect rate limits
4. Include dry-run mode (`--dry-run` flag)

**Verification:**
- Script compiles: `npx tsc --noEmit scripts/migrate-images-to-cloudinary.ts`
- Script has --dry-run and --help options

### Task 5: Document Migration Process

**Files to modify:**
- `bullion-tracker/.env.example` (add migration instructions comment)

**Implementation:**
1. Add comment section in .env.example explaining migration:
   - How to set up Cloudinary account
   - How to create unsigned upload preset
   - How to run migration script
   - What to expect during migration

**Verification:**
- Documentation is clear and complete

## Acceptance Criteria

1. New images upload to Cloudinary when configured
2. Falls back to base64 when Cloudinary not configured (dev-friendly)
3. Migration script exists and is documented
4. TypeScript compiles without errors
5. Existing functionality not broken

## Estimated Complexity

- **Task 1**: Small (new utility file)
- **Task 2**: Medium (modify existing component logic)
- **Task 3**: Small (add env vars)
- **Task 4**: Medium (new script with DB access)
- **Task 5**: Small (documentation)

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Cloudinary rate limits during migration | Batch with delays, dry-run first |
| Mixed URLs in database (base64 + Cloudinary) | Both work as `<img src>`, no code change needed |
| Failed uploads during normal use | Fallback to base64 maintains functionality |

## Notes

- Mobile app doesn't need changes - it fetches URLs from API, works with both base64 and Cloudinary URLs
- Future enhancement: Add image deletion from Cloudinary when item deleted (not in scope for this plan)
- Migration script is optional - new uploads go to Cloudinary, old ones work as base64

---
*Plan: 05-01 | Phase: 05-image-storage-migration*
