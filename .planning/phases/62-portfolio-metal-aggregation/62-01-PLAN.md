# Plan 62-01: Portfolio Metal Aggregation

**Goal**: Calculate total precious metal weight across portfolio from numismatic coins' `preciousMetalOz` field, display breakdown by metal type on dashboard (web and mobile).

**Phase**: 62-portfolio-metal-aggregation
**Milestone**: v2.5 Numismatic Metal Content
**Prior phases**: 58 (schema), 59 (rules engine), 60 (cert autofill), 61 (manual input)

---

## Context

Phases 58-61 established metal content tracking on individual numismatic coins:
- `metalPurity` (0.0-1.0 float)
- `metalWeightOz` (total coin weight in troy oz)
- `preciousMetalOz` (calculated: metalWeightOz Ã— metalPurity)

This phase aggregates `preciousMetalOz` across all numismatic items to show total precious metal content from coins alongside existing bullion weights.

## Architecture

**Current state:**
- `CollectionSummary` (web) tracks `goldOz`, `silverOz`, `platinumOz` from bullion `weightOz`
- `PortfolioSummary` (mobile) tracks `totalWeight.gold/silver/platinum` from bullion
- Neither aggregates `preciousMetalOz` from numismatic items

**Target state:**
- Add `preciousMetalGoldOz`, `preciousMetalSilverOz`, `preciousMetalPlatinumOz` fields
- Sum `preciousMetalOz` grouped by metal type from numismatic coins
- Display in new "Numismatic Metal Content" card on dashboard

## Tasks

### Task 1: Add precious metal aggregation to API

**Files:**
- `bullion-tracker/src/lib/calculations.ts` - Add aggregation logic
- `bullion-tracker/src/types/index.ts` - Extend CollectionSummary type
- `bullion-tracker/src/app/api/portfolio/summary/route.ts` - Return new fields

**Changes:**
1. Add to `CollectionSummary` interface:
   ```typescript
   preciousMetalGoldOz: number;
   preciousMetalSilverOz: number;
   preciousMetalPlatinumOz: number;
   ```

2. In `calculateCollectionSummary`, aggregate `preciousMetalOz` by metal:
   ```typescript
   // For numismatic items with preciousMetalOz
   if (item.category === 'NUMISMATIC' && item.preciousMetalOz) {
     if (item.metal === 'gold') summary.preciousMetalGoldOz += item.preciousMetalOz;
     if (item.metal === 'silver') summary.preciousMetalSilverOz += item.preciousMetalOz;
     if (item.metal === 'platinum') summary.preciousMetalPlatinumOz += item.preciousMetalOz;
   }
   ```

3. Initialize new fields in summary:
   ```typescript
   preciousMetalGoldOz: 0,
   preciousMetalSilverOz: 0,
   preciousMetalPlatinumOz: 0,
   ```

**Commit**: `feat(62-01): add precious metal aggregation to portfolio summary API`

---

### Task 2: Add Numismatic Metal Content card to web dashboard

**Files:**
- `bullion-tracker/src/hooks/usePortfolioSummary.ts` - Verify types match
- `bullion-tracker/src/app/dashboard/page.tsx` - Add metal content card

**Changes:**
1. Add "Numismatic Metal Content" card after category breakdown:
   ```tsx
   {(summary.preciousMetalGoldOz > 0 || summary.preciousMetalSilverOz > 0 || summary.preciousMetalPlatinumOz > 0) && (
     <Card>
       <CardHeader>
         <CardTitle>Numismatic Metal Content</CardTitle>
         <CardDescription>Precious metal from graded/raw coins</CardDescription>
       </CardHeader>
       <CardContent>
         <div className="grid grid-cols-3 gap-4">
           {summary.preciousMetalGoldOz > 0 && (
             <div>
               <p className="text-sm text-muted-foreground">Gold</p>
               <p className="text-xl font-mono">{summary.preciousMetalGoldOz.toFixed(4)} oz</p>
             </div>
           )}
           {/* Silver and Platinum similarly */}
         </div>
       </CardContent>
     </Card>
   )}
   ```

2. Style to match existing breakdown cards

**Commit**: `feat(62-01): add numismatic metal content card to web dashboard`

---

### Task 3: Add precious metal aggregation to mobile calculations

**Files:**
- `bullion-tracker-mobile/src/lib/calculations.ts` - Add aggregation
- `bullion-tracker-mobile/src/types/index.ts` - Extend PortfolioSummary

**Changes:**
1. Add to `PortfolioSummary` interface:
   ```typescript
   preciousMetalWeight: {
     gold: number;
     silver: number;
     platinum: number;
   };
   ```

2. In `calculatePortfolioSummary`, aggregate `preciousMetalOz`:
   ```typescript
   const preciousMetalWeight = {
     gold: 0,
     silver: 0,
     platinum: 0,
   };

   items.forEach(item => {
     // Existing logic...

     // Aggregate precious metal from numismatic items
     if (item.category === 'NUMISMATIC' && item.preciousMetalOz) {
       preciousMetalWeight[metalKey] += item.preciousMetalOz;
     }
   });
   ```

3. Return `preciousMetalWeight` in summary

**Commit**: `feat(62-01): add precious metal aggregation to mobile calculations`

---

### Task 4: Add Numismatic Metal Content card to mobile dashboard

**Files:**
- `bullion-tracker-mobile/src/screens/DashboardScreen.tsx` - Add card

**Changes:**
1. Add "Numismatic Metal Content" card after Category Breakdown:
   ```tsx
   {summary && (summary.preciousMetalWeight.gold > 0 || summary.preciousMetalWeight.silver > 0 || summary.preciousMetalWeight.platinum > 0) && (
     <View style={styles.metalContentCard}>
       <Text style={styles.metalContentLabel}>NUMISMATIC METAL CONTENT</Text>
       <View style={styles.metalContentRow}>
         {summary.preciousMetalWeight.gold > 0 && (
           <View style={styles.metalContentItem}>
             <Text style={styles.metalContentTitle}>Gold</Text>
             <Text style={styles.metalContentValue}>{summary.preciousMetalWeight.gold.toFixed(4)} oz</Text>
           </View>
         )}
         {/* Silver and Platinum similarly */}
       </View>
     </View>
   )}
   ```

2. Add styles matching existing category/valuation cards

**Commit**: `feat(62-01): add numismatic metal content card to mobile dashboard`

---

## Verification

- [ ] API returns preciousMetalGoldOz, preciousMetalSilverOz, preciousMetalPlatinumOz
- [ ] Web dashboard shows card when numismatic items have metal content
- [ ] Mobile dashboard shows card when numismatic items have metal content
- [ ] Card hidden when no numismatic metal content exists
- [ ] Values sum correctly across all numismatic items with preciousMetalOz

## Risks

- **Low**: Numismatic items without metal content (null preciousMetalOz) safely skipped
- **Low**: Existing bullion weight tracking unchanged

## Dependencies

- Phase 58: Schema fields exist
- Phase 59: Rules engine populates fields for US coins
- Phase 60: Cert lookup populates fields
- Phase 61: Manual input populates fields

---

**Estimated tasks**: 4
**Files to modify**: 6
