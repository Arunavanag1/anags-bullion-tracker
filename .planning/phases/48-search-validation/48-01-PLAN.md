# Phase 48 Plan 01: Search & Validation

---
phase: 48-search-validation
plan: 01
type: execute
---

<objective>
Optimize coin search with PostgreSQL full-text search (tsvector) and add data quality validation with admin reports.

Purpose: Make coin search fast and accurate as database grows from 100 to 8,000+ coins; ensure data quality.
Output: Optimized search endpoint, validation CLI, admin reports for missing/stale data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/46-data-population-pipeline/46-01-SUMMARY.md
@.planning/phases/47-price-refresh-automation/47-01-SUMMARY.md

# Key existing files:
@bullion-tracker/src/app/api/coins/search/route.ts
@bullion-tracker/prisma/schema.prisma
@bullion-tracker/coin_scraper/validators/coin_validator.py

**Tech stack available:** Prisma, PostgreSQL, SQLAlchemy (Python scraper), CoinValidator
**Established patterns:** Dual logging, validation reports, CLI with argparse

**Constraining decisions:**
- Phase 46: CoinValidator with ValidationReport pattern
- Phase 47: Established CLI patterns with --status, --report flags
- Current search uses simple Prisma LIKE queries (slow for large datasets)
- `searchTokens` field exists but is unused

**Current state:**
- 100 coins in database
- Search endpoint uses `{ contains: query, mode: 'insensitive' }` (O(n) scan)
- `searchTokens` column exists but isn't populated or queried
- Validators exist in Python but no validation reports for existing data
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PostgreSQL Full-Text Search Migration</name>
  <files>bullion-tracker/prisma/migrations/*/migration.sql, bullion-tracker/prisma/schema.prisma</files>
  <action>
Create a Prisma migration to add PostgreSQL full-text search capabilities:

1. Create migration file with raw SQL:
   ```sql
   -- Add tsvector column for full-text search
   ALTER TABLE "CoinReference" ADD COLUMN IF NOT EXISTS "searchVector" tsvector;

   -- Create GIN index for fast full-text search
   CREATE INDEX IF NOT EXISTS "CoinReference_searchVector_idx"
   ON "CoinReference" USING GIN ("searchVector");

   -- Function to generate search vector from coin fields
   CREATE OR REPLACE FUNCTION coin_search_vector_update() RETURNS trigger AS $$
   BEGIN
     NEW."searchVector" :=
       setweight(to_tsvector('english', COALESCE(NEW."fullName", '')), 'A') ||
       setweight(to_tsvector('english', COALESCE(NEW."series", '')), 'B') ||
       setweight(to_tsvector('english', COALESCE(NEW."denomination", '')), 'C') ||
       setweight(to_tsvector('english', COALESCE(CAST(NEW.year AS TEXT), '')), 'D');
     RETURN NEW;
   END;
   $$ LANGUAGE plpgsql;

   -- Trigger to auto-update search vector
   DROP TRIGGER IF EXISTS coin_search_vector_trigger ON "CoinReference";
   CREATE TRIGGER coin_search_vector_trigger
   BEFORE INSERT OR UPDATE ON "CoinReference"
   FOR EACH ROW EXECUTE FUNCTION coin_search_vector_update();

   -- Populate existing rows
   UPDATE "CoinReference" SET "fullName" = "fullName" WHERE "searchVector" IS NULL;
   ```

2. Run migration:
   - `npx prisma migrate dev --name add-full-text-search`

3. Add searchVector to schema.prisma as `@db.Unsupported("tsvector")` since Prisma doesn't natively support tsvector.
  </action>
  <verify>
npx prisma migrate status shows migration applied
psql: SELECT COUNT(*) FROM "CoinReference" WHERE "searchVector" IS NOT NULL; returns 100
  </verify>
  <done>
- Migration created and applied
- GIN index exists on searchVector column
- Trigger auto-updates searchVector on insert/update
- All existing coins have searchVector populated
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Search API to Use Full-Text Search</name>
  <files>bullion-tracker/src/app/api/coins/search/route.ts</files>
  <action>
Rewrite the search endpoint to use PostgreSQL full-text search:

1. Replace Prisma `contains` queries with raw SQL using `to_tsquery`:
   ```typescript
   const coins = await prisma.$queryRaw`
     SELECT id, "pcgsNumber", year, "mintMark", denomination, series, "fullName", metal
     FROM "CoinReference"
     WHERE "searchVector" @@ plainto_tsquery('english', ${query})
     ORDER BY ts_rank("searchVector", plainto_tsquery('english', ${query})) DESC
     LIMIT ${limit}
   `;
   ```

2. Add fallback for short queries (1-2 chars) to use LIKE:
   - Under 3 chars: Use original LIKE query (may be PCGS number prefix)
   - 3+ chars: Use full-text search

3. Handle special cases:
   - Numeric queries (years, PCGS numbers): Query year or pcgsNumber directly
   - Empty queries: Return empty array

4. Return ranked results (most relevant first via ts_rank).
  </action>
  <verify>
curl "localhost:3000/api/coins/search?q=morgan" returns coins ranked by relevance
curl "localhost:3000/api/coins/search?q=1921" returns 1921 dated coins
curl "localhost:3000/api/coins/search?q=MS" returns coins (if any have MS in name)
  </verify>
  <done>
- Search uses full-text tsquery for 3+ char queries
- Results ranked by relevance
- Numeric queries match year/pcgsNumber
- Performance improved for large datasets
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Data Validation CLI for Existing Coins</name>
  <files>bullion-tracker/coin_scraper/validate_data.py</files>
  <action>
Create a CLI script to validate all CoinReference data and generate reports:

1. Create `validate_data.py` that:
   - Connects to PostgreSQL using existing DATABASE_URL
   - Loads all CoinReference records
   - Uses existing `CoinValidator` from validators module
   - Generates `ValidationReport` with errors and warnings
   - Identifies data quality issues:
     - Missing required fields (pcgsNumber, series, fullName)
     - Invalid year ranges
     - Unknown denominations/mint marks
     - Missing searchVector
     - Coins with no price guide entries
     - Stale price data (>30 days old)

2. CLI flags:
   - `--report`: Full validation report with all issues
   - `--summary`: Quick summary (counts only)
   - `--fix`: Auto-fix where possible (e.g., regenerate searchVector)
   - `--series SERIES`: Validate specific series only
   - `--export FILE`: Export report to markdown file

3. Generate reports to `logs/validation_report_YYYY-MM-DD.md`:
   - Summary statistics
   - Coins with missing data
   - Coins with stale prices
   - Series coverage (how many coins per series)

4. Follow established patterns from `populate.py` and `refresh_prices.py`.
  </action>
  <verify>
python validate_data.py --help shows all options
python validate_data.py --summary shows quick stats
python validate_data.py --report generates full report
  </verify>
  <done>
- validate_data.py runs with all CLI flags
- Uses existing CoinValidator
- Generates detailed validation reports
- Identifies missing/stale data
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration applied: `searchVector` column exists with GIN index
- [ ] All 100 coins have `searchVector` populated
- [ ] Search API uses full-text search for 3+ char queries
- [ ] Search results ranked by relevance
- [ ] validate_data.py --summary works
- [ ] validate_data.py --report generates markdown report
- [ ] No TypeScript errors in search route
</verification>

<success_criteria>

- All tasks completed
- Full-text search operational with relevance ranking
- Data validation CLI functional
- Reports generated in logs/ directory
- v2.1 Coin Database Expansion milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/48-search-validation/48-01-SUMMARY.md`:

# Phase 48 Plan 01: Search & Validation Summary

**[Substantive one-liner describing outcome]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `bullion-tracker/prisma/migrations/*/` - Full-text search migration
- `bullion-tracker/src/app/api/coins/search/route.ts` - Optimized search
- `bullion-tracker/coin_scraper/validate_data.py` - Validation CLI

## Decisions Made
[Any decisions and rationale]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
[v2.1 milestone complete, ready for next milestone]

---
*Phase: 48-search-validation*
*Plan: 01*
</output>
